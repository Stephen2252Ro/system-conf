'use strict';(function(){function B(a){let b=Math.floor(a/60);a%=60;return`${10>b?"0"+b:b}:${10>a?"0"+a:a}`}function G(){(new w(x?40:20,500,function(){let a=document.querySelector(e.danmuBtn);return a?(a.checked&&a.click(),!0):!1})).start()}function C(a){(new w(x?40:20,500,function(){if(2===a&&document.body.classList.contains("player-fullscreen-fix")||1===a&&document.body.classList.contains("player-mode-widescreen"))return!0;let b;1===a?b=document.querySelector(e.widescreen):2===a&&(b=document.querySelector(e.pagefullscreen));
return b?(b.click(),!0):!1})).start()}function R(a){document.fullscreenElement?r=(a=!!document.querySelector("#bilibiliPlayer"))&&document.body.classList.contains("player-mode-webfullscreen")||!a&&document.body.classList.contains("player-fullscreen-fix")?2:document.body.classList.contains("player-mode-widescreen")?1:0:0!=r&&(""==document.body.className&&1===r?C(r):setTimeout(()=>C(r),0))}function H(){document.fullscreenElement&&setTimeout(function(){let a=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video");
a&&a.ended&&document.fullscreenElement&&document.exitFullscreen()},600)}function I(){let a=document.querySelector(e.nextBtn);a&&a.click()}function J(a){if(!a&&(a=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video"),!a))return;let b=!1;try{b=window.self!==window.top}catch(c){b=!0}b?"1"==(new URL(location.href)).searchParams.get("autoplay")&&
a.play().catch(c=>{}):a.play().catch(c=>{})}function D(a){let b=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video");if(b){let c=b.style.width;""==c&&(c="100%");b.style.width=0<a?"50%"==c?"75%":"100%":0>a?"100%"==c?"75%":"50%":"100%";b.style.margin="auto"}}async function S(a){var b=a.target.tagName;if(!("INPUT"===b||"TEXTAREA"===
b||a.target.isContentEditable||a.ctrlKey||a.altKey||a.metaKey)){b=a.keyCode;var c=a.code;if(70===b)a.preventDefault(),a.stopPropagation(),document.pictureInPictureElement&&await document.exitPictureInPicture(),(a=document.querySelector(e.fullscreen))&&a.click();else if(87===b)a.preventDefault(),a.stopPropagation(),(a=document.querySelector(e.pagefullscreen))&&a.click();else if(68===b)if(a.preventDefault(),a.stopPropagation(),a.shiftKey)f.showDanmuState();else{if(a=document.querySelector(e.danmuBtn))a.click(),
f.showDanmuState()}else if(84===b)a.preventDefault(),a.stopPropagation(),(a=document.querySelector(e.widescreen))&&a.click();else if(75===b)a.preventDefault(),a.stopPropagation(),(a=document.querySelector(e.playBtn))&&a.click();else if(74===b)a.preventDefault(),a.stopPropagation(),a.shiftKey?y(!1,E):F(!1);else if(76===b)a.preventDefault(),a.stopPropagation(),a.shiftKey?y(!0,E):F(!0);else if("Equal"===c)a.preventDefault(),a.stopPropagation(),a.shiftKey?D(1):((a=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video"))&&
5>a.playbackRate&&(a.playbackRate=parseFloat((a.playbackRate+d.speedStep).toFixed(2))),a&&f.showState(t.stateSpeed+a.playbackRate));else if("Minus"===c)if(a.preventDefault(),a.stopPropagation(),a.shiftKey)D(-1);else{if(a=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video"))b=parseFloat((a.playbackRate-d.speedStep).toFixed(2)),
.25<=b&&(a.playbackRate=b),f.showState(t.stateSpeed+a.playbackRate)}else if("Digit0"===c)if(a.preventDefault(),a.stopPropagation(),a.shiftKey)D(0);else{if(a=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video"))a.playbackRate=1,f.showState(t.stateSpeed+1)}else if(67===b)a.preventDefault(),a.stopPropagation(),T();else if(73===b)a.preventDefault(),
a.stopPropagation(),k.toggle(0);else if(78===b)a.preventDefault(),a.stopPropagation(),I();else if(77===b){if(a.preventDefault(),a.stopPropagation(),a=document.querySelector(e.muteBtn))if(a.firstElementChild.click(),b=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video"))a=a.classList.contains("squirtle-volume-icon")?a.classList.contains("squirtle-volume-mute-state"):
b.muted,f.showState(a?t.stateMute:t.stateUnmute)}else 80===b?(a.preventDefault(),a.stopPropagation(),U()):188===b?(a.preventDefault(),a.stopPropagation(),y(!1,.042)):190===b?(a.preventDefault(),a.stopPropagation(),y(!0,.042)):83===b&&a.shiftKey?(a.preventDefault(),a.stopPropagation(),!(a=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video"))||
2>a.readyState||(h||(h=document.createElement("a")),"BWP-VIDEO"===a.tagName?a.toDataURL&&(h.download=`screenshot-${a.currentTime.toFixed(3)}.png`,h.href=a.toDataURL(),h.click()):(l||(l=document.createElement("canvas")),l.width=a.videoWidth,l.height=a.videoHeight,l.getContext("2d").drawImage(a,0,0,l.width,l.height),d&&"png"==d.imageFormat?(h.download=`screenshot-${a.currentTime.toFixed(3)}.png`,h.href=l.toDataURL("image/png")):(h.download=`screenshot-${a.currentTime.toFixed(3)}.jpg`,h.href=l.toDataURL("image/jpeg",
.98)),h.click()))):71===b?(a.preventDefault(),a.stopPropagation(),f.toggleTimeState()):72===b?(a.preventDefault(),a.stopPropagation(),f.toggleClockState()):66===b&&(a.preventDefault(),a.stopPropagation(),f.showTitle())}}function y(a,b){let c=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video");!c||0===c.readyState||!Number.isFinite(c.duration)||
1>b&&!c.paused||(a?c.currentTime=Math.min(c.currentTime+b,c.duration-1):c.duration==c.currentTime?F(!1):c.currentTime=Math.max(c.currentTime-b,0))}function F(a){let b=document.querySelector(e.videoArea);b&&b.click();a=a?new KeyboardEvent("keydown",{bubbles:!0,cancelable:!0,key:"ArrowRight",code:"ArrowRight",keyCode:39}):new KeyboardEvent("keydown",{bubbles:!0,cancelable:!0,key:"ArrowLeft",code:"ArrowLeft",keyCode:37});document.body.dispatchEvent(a)}async function U(){let a=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video");
a&&document.pictureInPictureEnabled&&!a.disablePictureInPicture&&0!==a.readyState&&(document.fullscreenElement&&await document.exitFullscreen(),document.pictureInPictureElement?document.exitPictureInPicture():a.requestPictureInPicture())}function T(){let a=document.querySelector(".bilibili-player-iconfont-subtitle");if(a)if(a.nextElementSibling)a.click();else{let b=a.parentElement;b.addEventListener("mouseover",c=>{setTimeout(()=>{b.dispatchEvent(new MouseEvent("mouseout"));setTimeout(()=>a.click(),
500)},150)},{once:!0});b.dispatchEvent(new MouseEvent("mouseover"))}else(a=document.querySelector(".squirtle-subtitle-wrap"))&&a.firstElementChild&&a.firstElementChild.click()}function K(){let a=document.querySelector(".bilibili-player-video-danmaku,.bpx-player-row-dm-wrap");var b=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video");
if(a&&b){var c=b.clientHeight;b=a.parentElement.clientHeight;c=.85*c+(b-c)/2;b=`${(c/b*100).toFixed(2)}%`;c=Math.round(c*devicePixelRatio);a.style.height!=b&&(a.style.height=b);"CANVAS"===a.tagName&&a.height!=c&&(a.height=c)}}function L(){let a=document.querySelector(".bilibili-player-video-danmaku,.bpx-player-row-dm-wrap");a&&(K(),z=new ResizeObserver(()=>{setTimeout(K,1E3)}),z.observe(a.parentElement))}function V(){let a=document.querySelector("#bilibiliPlayer");if(a){const b={childList:!0};let c;
function p(){c=new MutationObserver(M);c.observe(a,b)}p();let N=document.querySelector("#bilibili-player,.player-container");N&&(new MutationObserver(function(){c.disconnect();setTimeout(p,800);M()})).observe(N,b)}}function M(){d.turnOffDanmu&&G();d.preventshade&&(z&&z.disconnect(),setTimeout(L,500));d.autoplay&&setTimeout(J,500);d.exitFullscreen&&setTimeout(function(){let a=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video");
a&&a.addEventListener("ended",H)},2E3);g&&"none"!=g.style.display&&setTimeout(f.showTitle,1500)}function O(){(new w(x?60:30,600,function(){let a=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video");if(a){V();d.keyboard&&document.addEventListener("keydown",S);d.turnOffDanmu&&G();let b=d.screenMode;0!==b&&C(b);d.autoplay&&J(a);d.turnOffLight&&
(k.initTurnOffLight(),d.smartLight&&k.smartLight());d.preventshade&&L();E=d.longStep;document.addEventListener("fullscreenchange",R);d.exitFullscreen&&a.addEventListener("ended",H);return!0}return!1})).start()}var d=JSON.parse(document.currentScript.dataset.settings);const W={stateMute:"\u5df2\u9759\u97f3",stateUnmute:"\u5df2\u53d6\u6d88\u9759\u97f3",stateSpeed:"\u500d\u901f "},X={stateMute:"Muted",stateUnmute:"Unmuted",stateSpeed:"Speed "},t="zh-CN"==navigator.language?W:X,e={danmuBtn:".bilibili-player-video-danmaku-switch > input[type=checkbox],.bpx-player-dm-switch input[type=checkbox]",
playBtn:".bilibili-player-video-btn-start,.squirtle-video-start",nextBtn:".bilibili-player-video-btn-next,.squirtle-video-next",muteBtn:".bilibili-player-video-btn-volume,.squirtle-volume-icon",state:".bilibili-player-video-state,.bpx-player-state-wrap",title:".bilibili-player-video-top-title,#player-title",widescreen:".bilibili-player-video-btn-widescreen,.squirtle-video-widescreen",pagefullscreen:".bilibili-player-video-web-fullscreen,.squirtle-video-pagefullscreen",fullscreen:".bilibili-player-video-btn-fullscreen,.squirtle-video-fullscreen",
videoArea:".bilibili-player-video-wrap,.bpx-player-video-area"};var E=30;class w{constructor(a,b,c){this.max=a;this.fn=c;this.timeout=b;this.count=0;this.repeat=this.start.bind(this)}start(){this.count++;this.count>this.max||this.fn()||setTimeout(this.repeat,this.timeout)}}var q,A,m,u,n,v,P,g;class f{static showState(a){if(!q){var b=document.createElement("div");b.style.cssText="position: absolute; z-index: 100000; left: 34px; bottom: 80px; padding: 10px; background-color: black; color: white; font-size: 30px;";
q=b}if(b=document.querySelector(e.state))q.innerText=a,q.style.display="block",b.parentElement.appendChild(q),A&&clearTimeout(A),A=setTimeout(f.clearState,1500)}static clearState(){A=null;q&&(q.style.display="none")}static showDanmuState(){let a=document.querySelector(e.danmuBtn);a&&f.showState(`\u5f39\u5e55 ${a.checked?"On":"Off"}`)}static toggleTimeState(){if(u)clearTimeout(u),u=null,m&&(m.style.display="none");else{if(!m){let a=document.createElement("div");a.style.cssText="position: absolute; z-index: 100000; left: 0px; top: 0px; padding: 4px; background-color: rgba(8, 8, 8, 0.75); color: white; font-family: monospace; font-size: 22px;";
m=a}f.showPlayerTime(!0)}}static showPlayerTime(a=!1){var b=document.querySelector("#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video");let c=document.querySelector(e.state);if(c&&b&&0!==b.readyState&&Number.isFinite(b.duration)){var p=Math.round(b.currentTime);b=Math.round(b.duration);p=`${B(p)} / ${B(b)} [-${B(b-p)}]`;a&&(m.style.display="block");
c.parentElement!==m.parentElement&&c.parentElement.appendChild(m);m.innerText=p;u=setTimeout(f.showPlayerTime,1E3)}else u=null,m.style.display="none"}static toggleClockState(){if(v)clearTimeout(v),v=null,n&&(n.style.display="none");else{if(!n){var a={hour12:!0,hour:"2-digit",minute:"2-digit"};d&&(a.hour12=!d.timeFormatHour24,d.timeFormatSecond&&(a.second="2-digit"));P=new Intl.DateTimeFormat("en-GB",a);a=document.createElement("div");a.style.cssText="position: absolute; z-index: 100000; right: 0px; top: 0px; padding: 4px; background-color: rgba(8, 8, 8, 0.75); color: white; font-family: monospace; font-size: 22px;";
n=a}f.showClockTime(!0)}}static showClockTime(a=!1){let b=document.querySelector(e.state);b?(n.innerText=P.format(new Date),a&&(n.style.display="block"),b.parentElement!==n.parentElement&&b.parentElement.appendChild(n),v=setTimeout(f.showClockTime,1E3)):(v=null,n.style.display="none")}static showTitle(){if(!g){var a=document.createElement("div");a.style.cssText="display: none; position: absolute; z-index: 100000; top: 0px; left: 50%; transform: translateX(-50%); padding: 4px 8px; background-color: rgba(8, 8, 8, 0.75); color: white; font-size: 22px;";
g=a}a=document.querySelector(e.state);let b=document.querySelector(e.title);a&&b&&b.textContent?(a.parentElement!==g.parentElement&&(a.parentElement.appendChild(g),g.style.display="none"),"none"==g.style.display?(g.innerText=b.textContent,g.style.display="block"):g.style.display="none"):g.style.display="none"}}var r=0;if("mediaSession"in navigator)try{navigator.mediaSession.setActionHandler("nexttrack",I)}catch(a){}class k{static clickLightBtn(a){let b=document.querySelector(".bilibili-player-video-btn-setting-right-others-content-lightoff input[type=checkbox],.squirtle-lightoff");
return b?(0===a?b.click():1!==a||!0!==b.checked&&!b.classList.contains("active")?2!==a||!1!==b.checked&&b.classList.contains("active")||b.click():b.click(),!0):!1}static toggle(a){if(k.clickLightBtn(a))return!0;let b=document.querySelector(".bilibili-player-video-btn-setting");return b?(b.addEventListener("mouseover",c=>{b.dispatchEvent(new MouseEvent("mouseout"));setTimeout(()=>k.clickLightBtn(a),100)},{once:!0}),b.dispatchEvent(new MouseEvent("mouseover")),!0):!1}static initTurnOffLight(){(new w(x?
30:15,600,()=>k.toggle(2))).start()}static smartCallback(a,b){a=a[0];a.isIntersecting?a.target.classList.contains("mini-player")||k.toggle(2):k.toggle(1)}static smartLight(){let a=new IntersectionObserver(k.smartCallback,{threshold:.75}),b=document.querySelector("#bilibili-player,.player-container");b&&a.observe(b)}}var l,h,z,x=function(){const a=location.href;return a.startsWith("https://www.bilibili.com/video/")||a.startsWith("https://www.bilibili.com/bangumi/")}(),Q=!1;document.hidden?document.addEventListener("visibilitychange",
function(){document.hidden||Q||(Q=!0,O())}):O()})();
