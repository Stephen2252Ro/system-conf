function w(e){return new Date(+e-6e4*(new Date).getTimezoneOffset()).toJSON().slice(0,-5).replace("T"," ")}function y(e,t){return t&&("omniBlockList"===e||c.oo([t]))?"$base64:"+btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(e,t)=>String.fromCharCode(parseInt(t,16)))):t}function S(e){return e instanceof Array&&(e=e.join("\n").trimRight()),(e=e.replace(/\r\n?/g,"\n").replace(/\xa0/g," ")).replace(/^\$base64:(.*)/gm,(e,t)=>{try{return decodeURIComponent([].map.call(atob(t),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))}catch(e){}return e})}function v(e,t,o){let i=t.environment,r=i&&i.platform||"",l=i&&i.extension&&i.extension+""||"",c=parseFloat(l||0)||0,u=c>1?l.split(".",2).join("."):"",f=c>parseFloat(_.runtime.getManifest().version);if(r&&(r=(""+r).slice(0,10)),!confirm(m("confirmImport",[m(true!==o?"backupFile":"recommendedFile"),u?m("fileVCVer").replace("*",u):"",(u?m("fileVCVer_2").replace("*",u):"")+(f?m("fileVCNewer"):""),r?m("filePlatform",[m(r)||r[0].toUpperCase()+r.slice(1)]):m("commonPlatform"),e?m("atTime",[w(e)]):m("before")])))return void(window.VApi&&VApi.t({k:201}));Object.setPrototypeOf(t,null);{let e=t.chrome;e&&"object"==typeof e&&Object.assign(t,e)}if(null==t.vimSync){let e=s.Nt("vimSync"),n=e&&confirm(m("keepSyncing"));t.vimSync=n||null,e&&console.log("Before importing: You chose to",n?"keep settings synced.":"stop syncing settings.")}let d=function(e,t,n,o){let i=arguments.length>3,r=i?o:n,l=["%s %c%s",e,"color:darkred",t];r="string"!=typeof r||r.length<=72?r:r.slice(0,71).trimRight()+"\u2026",i&&l.push(n),l.push(r),console.log(...l)};console.group("Import settings at "+w(Date.now())),e>1e4?console.info("load settings saved at %c%s%c.","color:darkblue",w(e),"color:auto"):console.info("load the settings:",o?"recommended.":"saved before.");let p=e=>e.split(/\s+/g).forEach(e=>e&&delete t[e]);p("name time environment author description chrome firefox edge safari");for(let e in t)"@"===e[0]&&delete t[e];let g=e=>{let n=t[e];"string"==typeof n&&n.includes("extension://",2)&&(/^(chrome|edge)-/.test(n)?n.startsWith("edge-")&&(t[e]=n.replace("edge-","chrome-")):delete t[e])};g("vomnibarPage"),g("newTabUrl");let h=localStorage,y=s.Ft,b=a.Is;for(let e=h.length;0<=--e;){let n=h.key(e);n.includes("|")||n in t||(t[n]=null)}p("findModeRawQueryList innerCSS findCSS omniCSS newTabUrl_f vomnibarPage_f\n      focusNewTabContent dialogMode");for(let e in s.Gt)e in t&&(t[s.Gt[e]]=t[e],delete t[e]);t.vimSync!==s.Nt("vimSync")&&(d("import","vimSync",t.vimSync),s.Rt("vimSync",t.vimSync),b.vimSync.os());{let e=b.keyMappings;void 0!==e&&(delete b.keyMappings,b.keyMappings=e)}for(let e in b){let n=b[e],o=n.es,i=t[o];if(delete t[o],o in y)if(null==i?i=y[o]:("string"==typeof y[o]&&(i=S(i)),i=n.ps(i,"object"==typeof y[o])),n.vs(n.rs(),i)){if(n.ns)continue;n.os()}else d("import",o,i),s.Rt(o,i),o in s.Lt&&a.Ss.push(o),n.os(),n.hs&&n.hs()}for(let e in t){let n=t[e];if(null!=n)"string"==typeof y[e]&&(n=S(n)),e in y?s.Nt(e)!==n&&(s.Rt(e,n),d("update",e,n)):(h.setItem(e,n),d("save",e,n));else{if(e in y){if(n=y[e],s.Nt(e)!==n){s.Rt(e,n),d("reset",e,n);continue}n=s.Nt(e)}else n=h.getItem(e);h.removeItem(e),d("remove",e,":=",n)}}n("#saveOptions").onclick(false),n("#advancedOptionsButton").getAttribute("aria-checked")!==""+s.Nt("showAdvancedOptions")&&n("#advancedOptionsButton").onclick(null,true),console.info("import settings: finished."),console.groupEnd();let v=window.VApi&&VApi.y().r,C=v&&v.querySelector("#HCls");C&&(C.click(),n("#showCommands").click()),window.VApi&&VApi.t({k:202})}function C(e,t,n){let o=null,i=null,r="";try{let e=V(n?t:t.replace(/\xa0/g," "));e instanceof Error?i=e:e?o=e:r=m("notJSON")}catch(e){i=e}if(null!=i){r=i?(i.message||i)+"":m("exc")+(""!==i?i:m("unknown"));let e=/^(\d+):(\d+)$/.exec(r);r=e?m("JSONParseError",[e[1],e[2]]):r}if(!o)return alert(r);if(e=+new Date(o.time||("object"==typeof e?+e:e))||0,"Vimium C"!==o.name&&"Vimium++"!==o.name||e<1e4&&e>0)return r=m("notVCJSON"),alert(r);let l=a.Is.keyMappings.cs?Promise.resolve():T("./options_checker.js"),s=e,c=o;l.then(()=>{setTimeout(v,17,s,c,n)})}function V(e){function t(){return/a?/.test("")}function n(e){let t=e.length;for(;s.length<t;s+=s);return s.slice(0,t)}let o=/\b(?:position (\d+)|line (\d+) column (\d+))/;if(!e||!(e=e.trimRight()))return null;let i,r,l,s=" ";try{let o=JSON.parse(e.replace(/"(?:\\[^\r\n]|[^"\\\r\n])*"|'(?:\\[^\r\n]|[^'\\\r\n])*'|(?:\/\/|#)[^\r\n]*|\/\*[^]*?\*\//g,e=>{let t=e[0];return"/"===t||"#"===t?e.startsWith("/*")?e.replace(/[^\r\n]+/g,n):n(e):e}));return t(),o}catch(e){if(i=o.exec(e+""),t(),!i||!i[0])throw e}if(i[2])r=+i[2],l=+i[3];else if(+i[1]>0){let t=e.includes("\r")?e.includes("\r\n")?"\r\n":"\r":"\n",n=e.slice(0,+i[1]).split(t);r=n.length,l=n[r-1].length+1}else r=l=1;return new SyntaxError(r+":"+l)}import{CurCVer_ as t,CurFFVer_ as j,bgSettings_ as s,OnChrome as i,OnEdge as k,OnFirefox as f,$ as n,asyncBackend_ as c,browser_ as _,import2 as T,OnSafari as A}from"./async_bg.js";import{ExclusionRulesOption_ as d,Option_ as a,oTrans_ as m}from"./options_base.js";import{click as R,delayed_task as B,clear_delayed_task as F,Platform_ as L}from"./options_wnd.js";n("#showCommands").onclick=function e(t){if(!window.VApi||!VApi.z)return void("undefined"!=typeof VimiumInjector&&setTimeout(e,120,null));let n,o=VApi.y().r;if(t&&t.preventDefault(),o&&(n=o.querySelector("#HCls"))){let e=null!=o.querySelector(".HelpCommandName");if(R(n),e)return}VApi.p({H:12}),t||setTimeout(()=>{let e=VApi.y(),t=e.r&&e.r.querySelector("#HDlg");t&&t.querySelector("#HCls").addEventListener("click",()=>{location.hash=""},true)},100)},d.prototype.Qn=function(e){if(e&&this.Wr)return;let t,n,o=this.ms(),i=/^([:^]?[a-z\-?*]+:\/\/)?((?:[^\/]|\/])+)(\/[^\]].*|\/?$)/;for(let e of o)(n=i.exec(t=e.pattern.replace("(?:[^./]+\\.)*?","*.")))&&n[1]&&n[2]&&(t=n[3]?n[3].replace(/\\\./g,"."):"",n=n[2].replace(/\\\./g,".").split("."),n.reverse(),t=n.join(".")+t),e.va=t;if(o.sort((e,t)=>e.va<t.va?-1:e.va===t.va?0:1),this.as(o),this.is(),!e)return;let r=this;this.Wr=setTimeout((e,t)=>{e.firstChild.data=t,r.Wr=0},1e3,e,e.firstChild.data),e.firstChild.data=m("o3_2")},n("#exclusionSortButton").onclick=function(){a.Is.exclusionRules.Qn(this)};let P="";window.addEventListener("unload",()=>{P&&URL.revokeObjectURL(P)}),n("#exportButton").onclick=e=>{let n;P&&(URL.revokeObjectURL(P),P="");let o=!!e&&(e.ctrlKey||e.metaKey||e.shiftKey),i=new Date;n=Object.create(null),n.name="Vimium C",o||(n["@time"]=i.toLocaleString(),n.time=i.getTime());let r=_.runtime.getManifest();n.environment={extension:r.version,platform:L},n.environment.chrome=t;let l=[],c=localStorage,a=s.Ft;for(let e=0,t=c.length;e<t;e++){let t=c.key(e);t.includes("|")||t.endsWith("_f")||"findModeRawQueryList"===t||t.endsWith("CSS")||l.push(t)}l.sort();for(let e of l){let t=c.getItem(e);"string"!=typeof a[e]?n[e]=e in a?s.Nt(e):t:t.includes("\n")?(n[e]=t.split("\n")).push(""):n[e]=t,"string"==typeof a[e]&&(n[e]="string"==typeof n[e]?y(e,n[e]):n[e].map(t=>y(e,t)))}let u=JSON.stringify(n,null,"\t")+"\n",f=w(i);"win"===n.environment.platform&&(u=u.replace(/\n/g,"\r\n")),n=null;let d="vimium_c-";d+=o?"settings":f.replace(/[\-:]/g,"").replace(" ","_"),d+=".json";let m=new Blob([u],{type:"application/json",endings:"native"});{let e=document.createElement("a");e.download=d,e.href=URL.createObjectURL(m),R(e),P=e.href}console.info("EXPORT settings to %c%s%c at %c%s%c.","color:darkred",d,"color:auto","color:darkblue",f,"color:auto")};let U=n("#settingsFile");U.onclick=null,U.onchange=function(){let e=this.files[0];if(this.value="",!e)return;let t=a.Is.vimSync.ss?102400:10485760;if(e.size&&e.size>t)return void alert(m("JSONTooLarge",[e.name,t/1024]));let n=new FileReader,o=e.lastModified||e.lastModifiedDate||0;n.onload=function(){return C(o,this.result,false)},n.readAsText(e)},U=n("#importOptions"),U.onclick=null,U.onchange=function(){n("#importButton").focus(),"exported"!==this.value?fetch("../settings-template.json").then(e=>e.text()).then(e=>C(0,e,true)):R(n("#settingsFile"))},U=null,B&&(()=>{let e=B;F();let t=n(e[0]);t.onclick&&t.onclick(e[1])})();