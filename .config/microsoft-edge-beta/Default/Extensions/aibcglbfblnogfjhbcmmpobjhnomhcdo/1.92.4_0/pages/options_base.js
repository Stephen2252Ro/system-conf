import{CurCVer_ as t,BG_ as e,bgSettings_ as s,OnChrome as i,$ as n,$$ as l,nextTick_ as h,pageLangs_ as o,pageTrans_ as r}from"./async_bg.js";export const showI18n=()=>{if("en"===o)return;let t=o.split(",")[0],e=navigator.language||t,s=n("#keyMappings"),i=s&&oTrans_("keyMappingsP");if(i&&(s.placeholder=i),e&&(!t.startsWith("zh")||"zh-CN"!==e))for(s of l("input[type=text], textarea"))s.lang=e;for(s of l("[data-i]")){let t=s.dataset.i,e=t.endsWith("-t");i=r(e?t.slice(0,-2):t),null!=i&&(e?s.title=i:s.innerText=i)}document.documentElement.lang="zh"===t?"zh-CN":t};window.__extends=function(t,e){let s=function(){this.constructor=t};s.prototype=e.prototype,t.prototype=new s};export const debounce_=(t,e,s,i)=>{let n,l=0,h=()=>{let o=Date.now()-n;if(!(o<e-4&&o>=0))return l=0,n!==i?t.call(s):void 0;l=setTimeout(h,e-o)};return i=i?1:0,()=>{if(n=Date.now(),!l)return l=setTimeout(h,e),i?(i=n,t.call(s)):void 0}};export class Option_{constructor(t,e){this.ts=t,this.es=t.id,this.ss=this.is=null,this.ns=false,this.es in s.Lt&&(e=this.ls.bind(this,e)),this.is=debounce_(e,330,this,1),this.Fr(t)}hs(){}os(){this.ns=true,this.ss=this.rs(),Option_.us||this.as(this.ss)}rs(){return s.Nt(this.es)}ps(t,s,i){let n=this.cs;return s?(i=n||!i?JSON.stringify(n?n._s(t):t):i,e.JSON.parse(i)):n?n._s(t):t}fs(){return true}ds(){let t=this.ms(),e="object"==typeof t,s=e?JSON.stringify(this.ss):this.ss,i=e?JSON.stringify(t):t;i!==s&&(s=i,t=this.ps(t,e,e?i:""),this.ss=t=this.xs(t,e,i),this.ns=true,(s!==(e?JSON.stringify(t):t)||this.ys(t))&&this.as(t,true),this.hs())}Os(){return!this.vs(this.ss,this.rs())}xs(t,e,i){return e&&JSON.stringify(t)===JSON.stringify(s.Ft[this.es])&&(t=s.Ft[this.es]),s.Rt(this.es,t),this.es in s.Lt&&Option_.Ss.push(this.es),this.rs()}ys(t){return false}static gs(t,e){return JSON.stringify(t)===JSON.stringify(e)}}Option_.us=false;export class ExclusionRulesOption_ extends Option_{constructor(){super(...arguments),this.vs=Option_.gs}Fr(t){this.Rs=t.querySelector("#exclusionTemplate").content.querySelector(".exclusionRule"),this.Ns=t.querySelector("tbody"),this.qr=[],this.Ns.addEventListener("input",ExclusionRulesOption_.ws),this.Ns.addEventListener("input",this.is),this.Ns.addEventListener("click",t=>this.$s(t)),this.bs=false,n("#exclusionAddButton").onclick=()=>this.ks("")}Es(t){}static ws(t){let e=t.target.vnode;e&&(e.Js=true)}ks(t,e){this.Ks(this.Ns,{pattern:t,passKeys:""});let s=this.qr[this.qr.length-1];false!==e&&h(()=>s.zs.focus()),t&&this.is(),this.Es(1)}as(t){if(!this.bs){this.bs=true,Option_.Ss&&(this.Rs.draggable=true);for(let t of"en"!==o?l("[title]",this.Rs):[]){let e=r(t.title);e&&(t.title=e)}}if(this.Ns.innerText="",this.qr=[],t.length<=0);else if(1===t.length)this.Ks(this.Ns,t[0]);else{let e=document.createDocumentFragment();t.forEach(this.Ks.bind(this,e)),this.Ns.append(e)}return this.Es(t.length)}Ts(t){return true}Ks(t,{pattern:e,passKeys:s}){let i={Cs:{pattern:e,passKeys:s},Kl:null,Js:false,Bi:false,zs:null,Ps:null};if(i.Bi=this.Ts(i),!i.Bi)return void this.qr.push(i);let n=document.importNode(this.Rs,true),l=n.querySelector(".pattern"),h=n.querySelector(".passKeys"),o=s.trimRight();l.value=e,e&&(l.placeholder=""),h.value=o,o&&(h.placeholder="");let r=i;r.zs=l,r.Ps=h,l.vnode=r,h.vnode=r,this.qr.push(r),t.append(n)}static As(t){t.Cs.pattern&&t.Ps.placeholder&&(t.Ps.placeholder="")}$s(t){let e=t.target;if("path"===e.localName&&(e=e.parentElement),"svg"===e.localName&&(e=e.parentElement),e.classList.contains("remove")&&(e=e.parentNode.parentNode,e.classList.contains("exclusionRule"))){let t=e.querySelector(".pattern").vnode;return e.remove(),this.qr.splice(this.qr.indexOf(t),1),this.is(),this.Es(0)}}static Ds(t,e,s){let i=s.toLowerCase();return e||1!==s.length?s!==i?`<${e}s-${i}>`:t:s}static Fs(t){return t&&t.replace(/<(?!<)((?:[acm]-){0,3})(\S|[A-Za-z]\w+)>/g,ExclusionRulesOption_.Ds)}ms(t){let e=[];t=true===t;for(let s of this.qr){if(t&&!s.Bi)continue;if(!s.Js){s.Cs.pattern&&e.push(s.Cs);continue}let i=s.zs.value.trim(),n=false,l=s.Ps.value;if(!i){this.Ms(s,"",l);continue}let h=i.startsWith(":")?0:i.indexOf("://");if(h)if(/^[\^*]|[^\\][$()*+?\[\]{|}]/.test(i))if(i.startsWith("^")){let t=".*$".includes(i.slice(-2))?i.endsWith(".*$")?3:i.endsWith(".*")?2:0:0;i=0!==t&&"\\"!==i[i.length-t]?i.slice(0,-t):i}else{n=!i.includes("/",h+3),i.endsWith("*")&&(i=i.slice(0,/^[^\\]\.\*$/.test(i.slice(-3))?-2:-1),n=false),i=i.startsWith(".*")&&!/[(\\[]/.test(i)?"*."+i.slice(2):i;let t=i;t=(h<0?"^https?://":"^")+(t.startsWith("*")&&"."!==t[1]?"[^/]"+t:(t=t.replace(/\./g,"\\."),t.startsWith("*")?t.replace("*\\.","(?:[^./]+\\.)*?"):t.replace("://*\\.","://(?:[^./]+\\.)*?"))),i=u(t,"")?t:i.includes("*")||i.includes("/")?":"+i:":https://"+(i.startsWith(".")?i.slice(1):i)}else n=!i.includes("/",h+3)&&!i.startsWith("vimium:"),i=i.replace(/\\(.)/g,"$1"),i=(h<0?":http://":":")+i;if(n&&(i+="/"),l){l=ExclusionRulesOption_.Fs(l);let t=l.match(/<(?!<)(?:a-)?(?:c-)?(?:m-)?(?:s-)?(?:[a-z]\w+|[^\sA-Z])>|\S/g);if(t){let e="^"===t[0]&&t.length>1;e&&t.shift(),t.sort(),e?t.unshift("^"):"^"===t[0]&&(t.shift(),t.push("^"))}l=t?t.join(" ")+" ":"",l=l.replace(/<escape>/gi,"<esc>")}let o=l?l.length>1&&"^"===l[0]?"only hook such keys":"pass through such keys":"completely disabled";s.Ps.title!==o&&(s.Ps.title=o),this.Ms(s,i,l),e.push(s.Cs)}return e}Ms(t,e,s){let i=!t.Cs.passKeys&&!!s;t.Cs={pattern:e,passKeys:s},t.Kl=null,t.Js=false,i&&ExclusionRulesOption_.As(t)}hs(){for(let t of this.qr){if(!t.Bi)continue;t.zs.value!==t.Cs.pattern&&(t.zs.value=t.Cs.pattern);let e=t.Cs.passKeys.trim();t.Ps.value!==e&&(t.Ps.value=e)}}}let u=(t,e)=>{try{return new RegExp(t,e)}catch(t){return null}};export let setupBorderWidth_=devicePixelRatio<2&&true?()=>{let t=document.createElement("style"),e=devicePixelRatio,s=e>=1,i=1/e;i+=999e-8,i=(""+i).slice(0,7).replace(/\.?0+$/,""),t.textContent=s?`html { --tiny: ${i}px; }`:`* { border-width: ${i}px !important; }`,document.head.append(t)}:null;export const oTrans_=(t,e)=>r(t,e)||"";