import{CurCVer_ as t,bgSettings_ as s,OnChrome as i,OnFirefox as f,$ as n,$$ as l,asyncBackend_ as c,browser_ as _,nextTick_ as h}from"./async_bg.js";import{Option_ as a,ExclusionRulesOption_ as d,oTrans_ as m}from"./options_base.js";a.Is=Object.create(null),a.Ss=[],a.prototype.ls=function(t){t.call(this),window.VApi&&s.Et(s.Lt[this.es],this.ms(),VApi.z)},a.Ws=()=>{let t=a.Is,e=[];for(let i in t){let s=t[i];!s.ns&&s.Os()&&e.push(s.es)}if(e.length>0&&!confirm(m("dirtyOptions",[e.join("\n  * ")])))return false;for(let e in t){let i=t[e];if(!i.ns&&!i.fs())return false}t.vimSync.ns||t.vimSync.ds(),t.exclusionRules.ns||t.exclusionRules.ds();for(let e in t)t[e].ns||t[e].ds();return true},a.Xs=()=>{let t=a.Is;for(let e in t)if(!t[e].ns)return true;return false},a.prototype.vs=(t,e)=>t===e;export class NumberOption_ extends a{Fr(){let t,e;this.cs={min:(t=this.ts.min)&&!isNaN(e=parseFloat(t))?e:null,max:(t=this.ts.max)&&!isNaN(e=parseFloat(t))?e:null,default:s.Ft[this.es],_s:NumberOption_.Ys},this.ts.oninput=this.is,this.ts.onfocus=this.Zs.bind(this)}as(t){this.ts.value=""+t}ms(){return parseFloat(this.ts.value)}Zs(){let t=this.ts,e=t=>this.On(t),i=()=>{t.removeEventListener("wheel",e,{passive:false}),t.removeEventListener("blur",i),this.Nn=0};this.Nn=0,t.addEventListener("wheel",e,{passive:false}),t.addEventListener("blur",i)}On(t){t.preventDefault();let e=this.Nn,i=Date.now();if(i-e<100&&i+99>e&&e)return;this.Nn=i;let s,n=this.ts,l=(t.deltaY||t.deltaX)>0,r=n.value,o=l?n.stepUp:n.stepDown;if("function"==typeof o)o.call(n),s=n.value,n.value=r;else{o=parseFloat;let t=o(n.step)||1;i=(+n.value||0)+(l?t:-t),isNaN(t=o(n.max))||(i=Math.min(i,t)),isNaN(t=o(n.min))||(i=Math.max(i,t)),s=""+i}return this.En(s,e>0,false)}static Ys(t){return isNaN(t)&&(t=this.default),t=null!=this.min?Math.max(this.min,t):t,null!=this.max?Math.min(this.max,t):t}}export class BooleanOption_ extends a{Fr(){let t=this.ts,e=t.dataset.map;this.Bn=e?JSON.parse(e):t.dataset.allowNull?BooleanOption_.Vn:BooleanOption_.Fn,this.Jn=this.Bn.length-1,this.Jn>1&&"vimSync"!==this.es&&t.addEventListener("change",this.onTripleStatusesClicked.bind(this),true),t.onchange=this.is}as(t){let e=true===t||t===this.Bn[this.Jn];this.ts.checked=e,this.ts.indeterminate=this.Jn>1&&t===this.Bn[1],this.jn=e?this.Jn:Math.max(0,this.Bn.indexOf(t))}ms(){return this.ts.indeterminate?this.Bn[1]:this.Bn[this.ts.checked?this.Jn:0]}onTripleStatusesClicked(t){t.preventDefault();let e=this.jn;this.jn=2===e?1:e?0:2,this.ts.indeterminate=2===e,this.ts.checked=2===this.jn}}BooleanOption_.Fn=[false,true],BooleanOption_.Vn=[false,null,true];export class TextOption_ extends a{Fr(){let t=this.ts.dataset.converter||"",e=t?t.split(" "):[];this.ts.oninput=this.is,e.length>0&&(this.cs={Cn:e,Ke:0,_s:TextOption_.zn})}os(){super.os();let t=this.cs;t&&(t.Ke=0,t.Ke=t._s(this.ss)===this.ss?1:0)}as(t,e){let i=t.replace(/ /g,"\xa0");true!==e?this.ts.value=i:this.En(i,true,true)}Ln(){return this.ts.value.trim().replace(/\xa0/g," ")}ms(){let t=this.Ln(),e=this.cs;return t&&e&&e._s===TextOption_.zn&&(e.Ke|=2,t=e._s(t),e.Ke&=-3),t}ys(t){return t!==this.Ln()}Qs(t,e,i){let{ts:s,ts:{classList:n,parentElement:l}}=this,r=s.nextElementSibling;r=r&&r.classList.contains("tip")?r:null,null!=i||(i=!!t),(i||r)&&h(()=>{i?(null==r&&(r=document.createElement("div"),r.className="tip",l.insertBefore(r,s.nextElementSibling)),r.textContent=t,null!==e&&n.add(e||"has-error")):(n.remove("has-error"),n.remove("highlight"),r&&r.remove())})}static zn(t){let e=this.Cn;if(e.indexOf("lower")>=0?t=t.toUpperCase().toLowerCase():e.indexOf("upper")>=0&&(t=t.toLowerCase().toUpperCase()),t=t.normalize(),e.indexOf("chars")<0||2&this.Ke&&!(1&this.Ke))return t;let i="";for(let e of t.replace(/\s/g,""))i.includes(e)||(i+=e);return i}}export class NonEmptyTextOption_ extends TextOption_{ms(){let t=super.ms();return t||(t=s.Ft[this.es],this.as(t,true)),t}}export class JSONOption_ extends TextOption_{Rn(t){let e=this.ts instanceof HTMLInputElement,i=JSON.stringify(t,null,e?1:2);return e?i.replace(/(,?)\n\s*/g,(t,e)=>e?", ":""):i}as(t,e){super.as(this.Rn(t),e)}ys(t){return this.Rn(t)!==this.Ln()}ms(){let t=super.ms(),e=null;if(t)try{e=JSON.parse(t)}catch(t){}else e=s.Ft[this.es],this.as(e,true);return e}}export class MaskedText_ extends TextOption_{Fr(){super.Fr(),this.An=true,this.Un=this.Dn.bind(this),this.ts.addEventListener("focus",this.Un)}Dn(){this.Un&&(this.ts.removeEventListener("focus",this.Un),this.ts.classList.remove("masked"),this.Un=null,this.An=false,this.ts.removeAttribute("placeholder"),this.os())}as(t,e){this.An?this.ts.placeholder=m("clickToUnmask"):super.as(t,e)}ms(){return this.An?this.ss:super.ms()}}TextOption_.prototype.En=NumberOption_.prototype.En=function(t,e,i){let s=false;e&&(this.Hn=true,s=document.activeElement!==this.ts,s&&this.ts.focus(),document.execCommand("undo")),this.Hn=i,this.ts.select(),document.execCommand("insertText",false,t),s&&this.ts.blur(),this.Hn=false},JSONOption_.prototype.vs=a.gs,d.prototype.Es=function(t){if(this.qr.length!==t)return;let e=n("#exclusionToolbar"),i=l("[data-model]",e);e.style.visibility=t?"":"hidden";for(let e of i){let i=a.Is[e.id],s=i.ts.parentNode.style;s.visibility=t||i.ns?"":"visible",s.display=!t&&i.ns?"none":""}};export const saveBtn=n("#saveOptions");export const exportBtn=n("#exportButton");export let savedStatus;export let registerClass;export const createNewOption=(()=>{let t=false;savedStatus=e=>t=null!=e?e:t;let e=function(){this.Hn||((this.ns=this.vs(this.ms(),this.ss))?t&&!a.Xs()&&(saveBtn.disabled=true,saveBtn.firstChild.data=m("o115"),exportBtn.disabled=false,savedStatus(false),window.onbeforeunload=null):t||(window.onbeforeunload=()=>m("beforeUnload"),savedStatus(true),saveBtn.disabled=false,saveBtn.firstChild.data=m("o115_2"),exportBtn.disabled=true))},i={Number:NumberOption_,Boolean:BooleanOption_,Text:TextOption_,NonEmptyText:NonEmptyTextOption_,JSON:JSONOption_,MaskedText:MaskedText_,ExclusionRules:d},s=t=>{let s=new(0,i[t.dataset.model])(t,e);return a.Is[s.es]=s};a.us=true;for(let t of l("[data-model]"))s(t);return registerClass=(t,e)=>{i[t]=e},s})();{let t=a.Is.exclusionRules,e=t.Ns;e.ondragstart=e=>{(t.Pn=e.target).style.opacity="0.5"},e.ondragend=()=>{let e=t.Pn;t.Pn=null,e&&(e.style.opacity="")},e.ondragover=t=>{t.preventDefault()},e.ondrop=e=>{e.preventDefault();let i=t.Pn,s=e.target;if(s=s.closest(".exclusionRule"),!i||!s||i===s)return;t.Ns.insertBefore(i,s);let n=t.qr,l=i.querySelector(".pattern").vnode,r=s.querySelector(".pattern").vnode;n.splice(n.indexOf(l),1),n.splice(n.indexOf(r),0,l),t.is()}}let x=a.Is.keyMappings,O=t=>{let e,i=new RegExp("^#![^\\n]*|^[^]","gm");for(;e=i.exec(t);){let i=e[0];if(i&&"\n"!==i[0]){if("#"!==i[0])break;if("!"===i[1]&&"no-check"===i.slice(2).trim()){t=t.slice(0,e.index)+t.slice(e.index+i.length).trimLeft();break}}}return t.replace(/\.activateMode(To)?/g,".activate")};x.rs=function(){return O(a.prototype.rs.call(this))},x.ps=function(t){return t=O(t),a.prototype.ps.call(this,t,false)},x.hs=function(){let t=c.to(),e=t.ro,i=e?(t=>{let e,i,s=t.length>1?t.length+" Errors:\n":"Error: ";for(i of t)e=0,s+=i[0].replace(/%([a-z])/g,(t,s)=>(++e,"c"===s?"":"s"===s||"d"===s?i[e]:JSON.stringify(i[e]))),e+1<i.length&&(s+=` ${i.slice(e+1).map(t=>"object"==typeof t&&t?JSON.stringify(t):t).join(" ")}.\n`);return s})(e):"";if(c.Ye.l&&!i){let e=Object.keys(t.me).join(""),i=t._e;if(e+=i?Object.keys(i).join(""):"",/[^ -\xff]/.test(e))return void this.Qs(m("ignoredNonEN"),null)}this.Qs(i)};let N=a.Is.linkHintCharacters,b=a.Is.linkHintNumbers,E=a.Is.filterLinkHints;N.hs=b.hs=function(){this.Qs(!this.ts.style.display&&this.ss.length<4?_.i18n.getMessage("96"):"")},E.hs=()=>{h(t=>{let e=E.ms();t.style.display=b.ts.style.display=e?"":"none",N.ts.style.display=e?"none":"",N.hs(),b.hs()},n("#waitForEnterBox"))},a.Is.ignoreKeyboardLayout.hs=function(){h(t=>{t.style.display=this.ms()>1?"none":""},n("#ignoreCapsLockBox"))},a.Is.vomnibarPage.hs=function(){let t=this,e=t.ss,i=e.startsWith(location.protocol)||e.startsWith("front/");if(e=c.Te.vomnibarPage_f||e,i);else{if(e.startsWith("file:"))return t.Qs(m("fileVomnibar"),"highlight");if(/^http:\/\/(?!localhost[:/])/i.test(e))return t.Qs(m("httpVomnibar"),"highlight")}return t.Qs("")},a.Is.newTabUrl.cs={Ke:0,_s(t){let e=/^\/?pages\/[a-z]+.html\b/i.test(t)?_.runtime.getURL(t):c.yt(t.toLowerCase());return e=e.split("?",1)[0].split("#",1)[0],t.startsWith("http")||1!==c.ve.get(e)&&!/^(?!http|ftp)[a-z\-]+:\/?\/?newtab\b\/?/i.test(t)?t:s.Ft.newTabUrl}},a.Is.userDefinedCss.hs=function(){window.VApi&&VApi.z&&this.ts.classList.contains("debugging")&&setTimeout(()=>{let t=VApi.y().r;for(let e of l("iframe",t)){let t=e.classList.contains("HUD"),i=e.contentDocument.querySelector("style.debugged");i&&(t?i.remove():i.classList.remove("debugged"))}a.Is.userDefinedCss.ts.classList.remove("debugging")},500)};