function Ze(){Ct&&(ht(),zt.style.display="none",Ct.remove(),Ct=null),VData=window.VData=Object.create(null);let t,n=location.hash,i="",l="";if(Lt||!n&&c&&(t=c.E())){n=Lt||t,Lt="",/^[^:]+[ &]data:/i.test(n)&&(Et=-1),Et=Et||Math.floor(4294967296*Math.random())||3286711320;let e=Rt(n,Et,true);history.state?history.pushState(e,"",""):history.replaceState(e,"",""),window.name=""+Et}else n||!history.state||(Et?(n=Rt(history.state,Et,false),window.name=""+Et):history.replaceState(null,"",""));VData.full=n,n.length<3||(n.startsWith("#!image")?(n=n.slice(7),i="image"):n.startsWith("#!url")&&(n=n.slice(5),i="url")),n=n.startsWith("%20")?n.slice(3):n.trim();for(let e=0;e=n.indexOf("&")+1;n=n.slice(e)){let t=n.slice(0,e).indexOf("="),i=t>0?n.slice(0,t):"",r=t>0?n.slice(t+1,e-1):"";if("download"===i)l=nt(r).split(/\||\uff5c| [-\xb7] /,1)[0].trim(),l=l.replace(/[\r\n"]/g,""),VData.file=l;else if(r=r.toLowerCase(),"auto"===i)VData.auto="once"===r?r:"true"===r||"false"!==r&&parseInt(r,10)>0;else if("pixel"===i)VData.pixel="1"===r||"true"===r;else{if("incognito"!==i)break;VData.incognito="true"===r||"false"!==r&&parseInt(r,10)>0}}if(n=nt(n,n.includes(":")||n.includes("/")?decodeURI:null).trim(),n)if(n.toLowerCase().startsWith("javascript:"))i=n=l=VData.file="";else if(e){let e=c.yt(n,null,-2);c.kt()<=2&&(n=e)}else n.startsWith("//")?n="http:"+n:/^([-.\dA-Za-z]+|\[[\dA-Fa-f:]+])(:\d{2,5})?\//.test(n)&&(n="http://"+n);else"image"===i&&(i="");switch(VData.type=i,/^data:/i.test(n)&&(n="data:"+n.slice(5)),VData.url=VData.original=n,i){case"image":if(VData.auto){let e=gt(n);e&&(console.log("Auto predict a better URL:\n %o =>\n %o",n,e),n=VData.url=e)}if(Ct=it("shownImage"),Ct.onerror=function(){VData.url!==VData.original&&VData.url?vt():(xt(),VData.auto=false,this.onerror=this.onload=null,this.alt=VData.error=sTrans_("failInLoading"),this.classList.add("broken"),setTimeout(Xe,34),this.onclick=t=>{e&&c.vn(VData.url)||(t.ctrlKey||t.shiftKey||t.altKey||!_.tabs||!_.tabs.update?Ye({target:"_top"},t):_.tabs.update({url:VData.url}))})},/[:.]/.test(n)?(Ct.onclick=lt,Ct.onload=function(){let e=this.naturalWidth,t=this.naturalHeight;if(e<12&&t<12){if(VData.auto)return void vt();if(e<2&&t<2)return console.log("The image is too small to see."),void this.onerror(null)}VData.original=VData.url,xt();let n=VData.url.slice(0,6).toLowerCase(),i=n.startsWith("blob:");if((i||n.startsWith("data:")&&!this.src.startsWith("data"))&&(zt.dataset.vimUrl=VData.original=VData.url=this.src,_t(i?0:1)),this.onerror=this.onload=null,this.src.startsWith("blob:")||setTimeout(()=>{Ct.src=Ct.src},0),Xe(),this.classList.add("zoom-in"),VData.pixel){jt.classList.add("pixel");let n=devicePixelRatio;if(e>innerWidth*n*.9&&t>innerHeight*n*.9){let e=it("snapshot-banner",true);e.querySelector(".banner-close").onclick=()=>{e.remove()};let t=e.querySelectorAll("[data-i]");for(let e=0;e<t.length;e++){let n=t[e].dataset.i,i=n.endsWith("-t"),l=r(i?n.slice(0,-2):n);l&&(i?t[e].title=l:t[e].textContent=l)}jt.insertBefore(e,jt.firstChild)}}e>=.9*innerWidth&&jt.classList.add("filled")},wt(n,Ct)):(n=VData.url="",Ct.onerror(null),Ct.alt=VData.error=sTrans_("none")),l){VData.file=l=pt(l)||l;let e=l.split(/[/\\]+/);e.length>1&&Ct.setAttribute("download",e[e.length-1]),Ct.alt=l,Ct.setAttribute("aria-title",l)}break;case"url":if(Ct=it("shownText"),n&&e){let t=null;if(n.startsWith("vimium://")&&(t=c.P(n.slice(9),1,true)),t=null!==t?t:c.yt(n,null,-1),"string"==typeof t)t=c.Bl(t,"whole"),t=c.$t(t);else{if(t instanceof e.Promise){t.then(e=>{ot(e[1],e[0]||e[2]||"")});break}if(t instanceof e.Array){ot(t[1],t[0]);break}}n=t}"string"==typeof n&&(n=yt(n)||n),ot(i,n);break;default:n="",Ct=it("shownImage"),Ct.src="../icons/icon128.png",zt.style.display="none"}zt.dataset.vimUrl=n,l?(zt.dataset.vimText=l,zt.download=l):(zt.removeAttribute("data-vim-text"),zt.removeAttribute("download")),zt.onclick=Ct?rt:lt}function Xe(){let e=Ct.scrollWidth;zt.style.height=Ct.scrollHeight+"px",zt.style.width=e+"px",zt.style.display=""}function Ye(e,t){if(t.preventDefault(),!VData.url)return;let n=document.createElement("a");Object.setPrototypeOf(e,null);for(let t in e)n.setAttribute(t,e[t]);n.href=VData.url,Qe(n,t)}function Qe(e,t){let n=document.createEvent("MouseEvents");return n.initMouseEvent("click",true,true,window,1,0,0,0,0,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,0,null),e.dispatchEvent(n)}function et(e){if(VData.error)return false;let{keyCode:t}=e,n=window.VApi&&VApi.z?VApi.m({c:" ",e,i:t},8):32===t?"space":13===t?"enter":"",i=n.slice(n.lastIndexOf("-")+1)||n&&"-";if("space"===i||"enter"===i){if(VData.pixel){let e=document.activeElement,t=e&&document.querySelector("#snapshot-banner");if(t&&t.contains(e)){let n=t.querySelector(".banner-close");return n.contains(e)&&n.onclick(null),true}}return e.preventDefault(),"enter"===i&&$t&&$t.isShown&&!$t.hiding&&!$t.played?$t.play(true):$t&&$t.isShown&&!$t.hiding||Qe(Ct,e),true}let l=0;switch(n){case"c-=":case"m-=":case"+":case"=":case"up":l=1;break;case"left":l=-2;break;case"right":l=2;break;case"c--":case"m--":case"-":case"down":l=-1;break;default:return false}return e.preventDefault(),e.stopImmediatePropagation(),$t&&$t.viewed?tt($t,l):dt().then(mt).then(e=>{tt(e,l)}).catch(ct),true}function tt(e,t){2===t||-2===t?e.rotate(45*t):e.zoom(t/10,true)}function nt(e,t){try{e=(t||decodeURIComponent)(e)}catch(e){}return e}function it(e,t){let i=n("#bodyTemplate"),l=document.importNode(i.content.querySelector("#"+e),true);return t||document.body.insertBefore(l,i),l}function lt(e){if(e.altKey)return e.stopImmediatePropagation(),Ye({download:VData.file||""},e);switch(VData.type){case"url":Ye({target:"_blank"},e);break;case"image":if(VData.error)return;let t=e.ctrlKey||e.metaKey;dt().then(e=>mt(e,t)).catch(ct)}}function rt(e){e.preventDefault(),Ct.onclick&&Ct.onclick(e)}function ot(e,t){e="number"==typeof e?["math","copy","search","ERROR","status","paste","url"][e]:e,n("#textTip").dataset.text=sTrans_(`t_${e}`)||e,n(".colon").dataset.colon=sTrans_("colon")+sTrans_("NS");let i=n("#textBody");return t?(i.textContent="string"!=typeof t?t.join(" "):t,Ct.onclick=at):i.classList.add("null"),Xe()}function at(e){let t=getSelection(),i=""+t;if(!i||"image"===VData.type&&i.trim()===Ct.alt.trim()){if("image"===VData.type&&VData.url){if("Range"===t.type&&!VData.url.startsWith(location.protocol))return;e.preventDefault();let n=navigator.clipboard;return void(null!=Vt?Promise.resolve(Vt):fetch(VData.url,{cache:"force-cache",referrer:"no-referrer"}).then(e=>e.blob()).catch(()=>(ut(VData.url),0)).then(e=>Vt=e)).then(e=>{if(!e)return;let t={"image/png":new Blob([e],{type:"image/png"}),"text/html":new Blob,"text/plain":new Blob([VData.url],{type:"text/plain"})},i=()=>n.write([new ClipboardItem(t)]),l=document.createElement("img");return l.src=VData.url,VData.file&&l.setAttribute("aria-title",l.alt=VData.file),t["text/html"]=new Blob([l.outerHTML],{type:"text/html"}),i().catch(()=>(delete t["text/html"],i()))}).catch(e=>{console.log(e),ut(VData.url)})}ut("url"===VData.type?n("#textBody").textContent:VData.url,e)}}function ut(e,t){e&&window.VApi&&(t&&t.preventDefault(),VApi.p({H:16,s:e}))}function st(e){"image"===VData.type&&(VData.error||$t&&$t.isShown&&!$t.hiding?e.preventDefault():Ct.classList.toggle("invert"))}function ft(e){if(n('link[href="'+e+'"]'))return;let t=document.createElement("link");t.rel="stylesheet",t.href=e,document.head.insertBefore(t,n('link[href$="show.css"]'))}function ct(e){e&&console.log("%o",e)}function dt(){return It?Promise.resolve(It):(ft("../lib/viewer.min.css"),T("../lib/viewer.min.js").then(e=>((e=e&&"function"==typeof e?e:window.Viewer).setDefaults({navbar:false,shown(){zt.style.display="none"},viewed(){St&&St(true)},hide(){zt.style.display="",St&&St(false)}}),It=e,e)))}function mt(e,t){let n=scrollX||scrollY,i=getSelection();"Range"===i.type&&i.collapseToStart();let l=$t=$t||new e(Ct);return l.scrollbarWidth=0,l.hiding&&(l.isShown=false),l.isShown||l.show(),l.hiding=false,n&&scrollTo(0,0),l.viewed?(l.zoomTo(1),l):(Object.defineProperty(l,"initialImageData",{configurable:true,enumerable:true,get(){return Bt},set(e){if(Bt=e,$t&&!t){t=true;let e=$t.imageData,n=1,i=e.naturalWidth*n,l=e.naturalHeight*n,r=l-e.height;e.left-=(i-e.width)/2,e.top-=r/2,e.width=i,e.height=l,e.ratio=n}}}),new Promise((e,t)=>{St=n=>{St=null,n?e(l):t("failed to view the image")}}))}function ht(){if(bt(),Vt=null,At&&(At(),At=null),"image"===VData.type){let e=document.body.classList;Ct.classList.remove("svg"),e.remove("pixel"),e.remove("filled"),Ct.removeAttribute("src"),Ct.onerror=Ct.onload=null,$t&&($t.destroy(),$t=null)}}function gt(t){function n(e){try{return new URL(e)}catch(e){}return null}function i(e){try{e=decodeURIComponent(e||"")}catch(e){}return e}let l=t,r=n(t=e&&c.j(t,256)||t);if(!r||!/^(ht|s?f)tp/i.test(r.protocol))return null;let{origin:o,pathname:a}=r,u=r.search;if(u.length>10)for(let e of u.slice(1).split("&")){let t=e.split("=",1)[0],l=e.slice(t.length+1),r=l;if(r.length>7)if(!r.includes("://")&&/%(?:3[aA]|2[fF])/.test(r)&&(r=i(r).trim()),r.includes("/")&&null!=n(r)){if(/^(?:imgurl|mediaurl|objurl|origin(?:al)?|real\w*|src|url)$/i.test(t))return r;let e=r.split("?")[0].split("/");if(Ft.test(e[e.length-1])&&!/\bthumb/i.test(t))return r}else if("id"===t&&/&w=\d{2,4}&h=\d{2,4}/.test(u))return o+a+"?id="+l;if("name"===t&&/^(\d{2,4}x\d{2,4}|small)$/i.test(l)&&u.toLowerCase().includes("format="))return o+a+u.replace(r,"large")}let s=null;if((s=/[?&]s=\d{2,4}(&|$)/.exec(u))&&u.split("=").length<=3)return o+a;u=a;let f=u.lastIndexOf("/")+1;u=u.slice(f);let d=u.lastIndexOf("@")+1||u.lastIndexOf("!")+1,m=d>2||Ft.test(u),h=null;if(m){f+=d,u=u.slice(d);let e=/(?:[.\-_]|\b)(?:[1-9]\d{2,3}[a-z]{1,3}[_\-]?|[1-9]\d?[a-z][_\-]?|0[a-z][_\-]?|[1-9]\d{1,3}[_\-]|[1-9]\d{1,2}(?=[.\-_]|\b)){2,6}(?=[.\-_]|\b)/gi;for(;h=e.exec(u);s=h);if(s&&/.[_\-].|\d\dx\d/i.test(s[0])){h=Ft.exec(u.slice(s.index+s[0].length)),f+=s.index;let e=s[0].length;h&&0===h.index&&(e+=h[0].length),u=a.slice(f+e),/[@!]$/.test(u||a.charAt(f-1))?u?u=u.slice(0,-1):f--:u||!h||0!==h.index||Ft.test(a.slice(Math.max(0,f-6),f))||(u=h[0])}else(s=/\b([\da-f]{8,48})([_-](?:[a-z]{1,2}|\d{3,4}[whp]?))\.[a-z]{2,4}$/.exec(u))?(f+=s.index+s[1].length,u=u.slice(s.index+s[1].length+s[2].length)):m=false}return m||d>2?m=m||0:(s=/_(0x)?[1-9]\d{2,3}([whp]|x0)?\./.exec(u))?u=u.slice(0,s.index)+u.slice(s.index+s[0].length-1):u.startsWith("thumb_")?u=u.slice(6):/^[1-9]\d+$/.test(u)&&+u>0&&+u<640?(f--,u=""):Ft.test(u)&&/^\/(small|(thumb|mw|orj)[1-9]\d{2,3})\//.test(a)?(m=true,u="/large"+a.slice(a.indexOf("/",1)),f=0):m=0,0!==m?o+a.slice(0,f)+u:l!==t?t:null}function pt(e){if(!e||/.\.[a-z]{3,4}\b/i.test(e))return;let t=Ft.exec(VData.url);if(t)return e+t[0];let n=Vt?Vt.type.toLowerCase():"";if(n.startsWith("image/")){let e={jpeg:"jpg",png:0,bmp:0,svg:0,gif:0,tif:0,ico:0};for(let t in e)if(e.hasOwnProperty(t)&&n.includes(t))return e[t]||"."+t}}function wt(e,t){let n=new Text,i=At=()=>{t.removeEventListener("load",i),t.removeEventListener("error",i),clearTimeout(a),n.remove(),At===i&&(At=null)};t.addEventListener("load",i,true),t.addEventListener("error",i,true);let l=e.slice(0,20).toLowerCase(),r=l.startsWith("blob:"),o=l.startsWith("data:");o&&l.startsWith("data:image/svg+xml,")&&t.classList.add("svg"),r||o&&!(e.length<1e4)||(VData.incognito||s.Nt("showInIncognito"))&&/^(ht|s?f)tp|^data:/.test(l)&&true?(bt(),jt.replaceChild(n,t),Promise.resolve(Ut[e]||fetch(e,r||o?{}:{cache:"no-store",referrer:"no-referrer"}).then(e=>e.blob())).then(t=>(Ut[e]=t,Pt=URL.createObjectURL(Vt=t)),()=>e).then(e=>{t.src=e,n.parentNode?jt.replaceChild(t,n):jt.append(t)})):t.src=e;let a=setTimeout(()=>{!t.parentNode||t.scrollHeight>=24||t.scrollWidth>=80?i():n.parentNode||(jt.insertBefore(n,t),n.data=sTrans_("loading"))},400)}function bt(){Pt&&(URL.revokeObjectURL(Pt),Pt="")}function yt(e){let t=e.split(":",1)[0];switch(t.toLowerCase()){case"thunder":case"flashget":case"qqdl":e=e.slice(t.length+3).split("&",1)[0];break;default:return""}try{e=atob(e)}catch(e){return""}return e.startsWith("AA")&&e.endsWith("ZZ")&&(e=e.slice(2,-2)),e.startsWith("[FLASHGET]")&&e.endsWith("[FLASHGET]")&&(e=e.slice(10,-10)),yt(e)||e}function vt(){console.log("Failed to visit the predicted URL, so go back to the original version."),xt(),VData.auto=false,Ze()}function xt(){let e=false;return"once"===VData.auto&&(VData.auto=false,e=true),e&&_t(),e}function _t(e){let t=VData.type;if(!t)return;let n="#!"+t+" "+(VData.incognito?"incognito=1&":"")+(VData.file?"download="+kt(VData.file)+"&":"")+(VData.auto?"auto="+("once"===VData.auto?"once":1)+"&":"")+(VData.pixel?"pixel=1&":"")+VData.original;if(VData.full=n,e)return;let i=Rt(n,Et,true);history.replaceState(i,"","")}function kt(e){return e.replace(new RegExp("[^\\p{L}\\p{N}]+","ug"),encodeURIComponent)}function Rt(e,t,n){if(-1===t)return e;let i=[];if(n)e=encodeURIComponent(e);else try{e=atob(e)}catch(t){e=""}for(let t of e)i.push(t.charCodeAt(0));for(let e=0;e<i.length;e++)i[e]=255&(i[e]^t>>>8*(3&e));if(e=String.fromCharCode(...i),n)e=btoa(e);else try{e=decodeURIComponent(e)}catch(t){e=""}return e}function Tt(){return VData&&VData.full?location.href.split("#",1)[0]+VData.full:location.href}import{CurCVer_ as t,CurFFVer_ as j,BG_ as e,bgSettings_ as s,OnChrome as i,OnFirefox as f,OnEdge as k,$ as n,pageTrans_ as r,asyncBackend_ as c,browser_ as _,nextTick_ as h,enableNextTick_ as te,import2 as T}from"./async_bg.js";let It,At,Lt,VData=null,Ut={},jt=document.body,Ct=null,zt=n("#bgLink"),St=null,$t=null,Bt=null,Et=+window.name||0,Ft=/\.(avif|bmp|gif|icon?|jpe?g|a?png|tiff?|webp)(?=[.\-_]|\b)/i,Pt="",Vt=null;export const sTrans_=(e,t)=>r(e,t)||"";te(1),h(()=>{window.onhashchange=Ze,window.onpopstate=Ze,Ze()}),addEventListener("VimiumC",()=>{window.VApi&&(VApi.u=Tt)},{once:true,capture:true}),window.onunload=bt,jt.ondrop=e=>{let t=e.dataTransfer.files;if(1===t.length){let n=t.item(0),i=n.name;(n.type.startsWith("image/")||Ft.test(i))&&(e.preventDefault(),Lt="#!image download="+i+"&"+URL.createObjectURL(n),Ze())}},jt.ondragover=jt.ondragenter=e=>{let t=e.dataTransfer.items;1===t.length&&t[0].type.startsWith("image/")&&e.preventDefault()},document.addEventListener("keydown",e=>{if("image"===VData.type&&et(e))return;if(!(e.ctrlKey||e.metaKey)||e.altKey||e.shiftKey||e.repeat)return;let t=String.fromCharCode(e.keyCode);return"S"===t?Ye({download:VData.file||""},e):"C"!==t?"A"===t?st(e):void 0:void at(e)});