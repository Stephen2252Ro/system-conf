import{BG_ as e,bgSettings_ as s,OnFirefox as f,OnEdge as k,OnChrome as i,$ as n,pageTrans_ as r,asyncBackend_ as c,browser_ as _,enableNextTick_ as te,nextTick_ as h}from"./async_bg.js";import{ExclusionRulesOption_ as d,setupBorderWidth_ as le,showI18n as oe}from"./options_base.js";let ne,ie,se,ue="",re=0,ae=true,de=null,ce=-1,fe=null,pe=false,me=/^[a-z][\+\-\.\da-z]+:\/\//,he=n("#state-action"),we=n("#saveOptions"),_e=he.nextElementSibling,ge=_e.nextElementSibling,be=Object.create(null),ve=s.Nt("exclusionOnlyFirstMatch"),Re=(e,t)=>r(e,t)||"";class xe extends d{ks(e,t){super.ks(xe.po(),t)}Ts(e){return e.Kl=e.Cs.pattern&&be[e.Cs.pattern]||false,Le(e.Kl)}as(e){super.as(e),this.as=null,document.documentElement.style.height="",xe.prototype.Ts=d.prototype.Ts;let t,l=this.qr.filter(e=>e.Bi),o=l.length>0;re=o?2:1,o?(t=l[0].Ps,Oe(true)):(this.ks("",false),t=this.qr[this.qr.length-1].Ps),h(()=>t.focus())}Ms(e,t,l){let o=e.Cs.pattern===t,n=e.Kl;super.Ms(e,t,l),o?e.Kl=n:this.ho(e,t)}ho(e,t){let l,o=e.zs;t&&t!==xe.po()?(l=Ee(e))instanceof Promise?l.then(()=>{this.ho(e,t)}):Le(l)?o.title=o.style.color="":(o.style.color="red",o.title="Red text means that the pattern does not\nmatch the current URL."):o.title=o.style.color=""}static po(){let e=ie.startsWith("http:")?"^https?://"+ie.split("/",3)[2].replace(/[.[\]]/g,"\\$&")+"/":ie.startsWith(location.origin)?":vimium:/"+new URL(ie).pathname.replace("/pages",""):/^[^:]+:\/\/./.test(ie)&&!ie.startsWith("file:")?":"+ie.split("/",3).join("/")+"/":":"+ie;return xe.po=()=>e,e}}let Oe=e=>{fe.ms(false);let t=fe.qr.filter(e=>e.Bi&&!!e.Cs.pattern),l=re;re=2,Promise.all(t.map(e=>null==e.Kl&&Ee(e))).then(()=>{je(l,e,t)})},je=(e,t,l)=>{let o=3===e,n=Ae(!!ue,l);n&&(n=ye(n)),t&&(de=e>=2?n:null);let i=n===de,s=!!n&&n.length>2&&"^"===n[0];he.textContent=(o?n?Re("o137")+Re(s?"o138":"o139"):Re("o140"):Re(i?"o141":"o142")+Re(n?s?"o138":"o139":i?"o143":"o143_2")).replace(" to be","")+Re("colon")+Re("NS"),_e.className=n?"code":"",_e.textContent=n?s?n.slice(2):n:Re(null!==n?"o144":"o145")+Re("o146"),ge.textContent=pe&&!o&&i?Re("o147",[Re(0!==ce?"o144":"o145")]):pe?Re("o148"):"",we.disabled=i,we.firstChild.data=Re(i?"o115":"o115_2")},ke=()=>{we.disabled||(c.P(`status/${ne.Xl}/reset/silent`,3),fe.ds(),setTimeout(()=>{setTimeout(Ie,150)},50),re=3,Oe(true),we.firstChild.data=Re("o115_3"),we.disabled=true,ae=true)},ye=e=>{let t=(e=e.trim()).length>2&&e.startsWith("^");t&&(e=e.slice(1).trimLeft());let l=Object.create(null);for(let t of e.split(" "))l[t]=1;return(t?"^ ":"")+Object.keys(l).sort().join(" ")},Pe=(e,t)=>{t&&t.preventDefault(),c.P(`status/${ne.Xl}/${e}`,3),window.close()},Le=e=>!!e&&(2===e.t?ie.startsWith(e.v)||!!ue&&ue.startsWith(e.v):e.v.test(ie)||!!ue&&e.v.test(ue)),Ee=e=>{let t=e.Cs.pattern,l=be[t];if(l)return e.Kl=l instanceof Promise?l.then(t=>e.Kl=t):l;let o=Promise.resolve(c.ii(t)[0]);return be[t]=e.Kl=o.then(l=>be[t]=e.Kl=Te(l))},Te=e=>2===e.t?{t:e.t,v:e.v}:{t:e.t,v:new RegExp(e.v,"")},$e=e=>{let t=s.Nt("exclusionRules");for(let l=0,o=t.length;l<o;l++)be["__proto__"!==t[l].pattern?t[l].pattern:"_"]=Te(e[l])},Ae=(e,t)=>{let l="";for(let e of t){let t=e.Kl;if(t&&(2===t.t?ie.startsWith(t.v):t.v.test(ie))){let t=e.Cs.passKeys;if(0===t.length||ve||"^"===t[0]&&t.length>2)return t;l+=t}}return!l&&e&&ie.lastIndexOf("://",5)<0&&!me.test(ie)&&ue?Ae(false,t):l||null},Ie=()=>{se=2!==ne.Ke?"Disable":"Enable";let e=n("#toggleOnce"),t=e.nextElementSibling;h(()=>{e.firstElementChild.textContent=(Re(se)||se)+(pe?"":Re("Once")),e.onclick=Pe.bind(null,se),_e.id="state-value",t.classList.toggle("hidden",!pe),pe&&(t.firstElementChild.onclick=Pe.bind(null,"Reset"))})},Ne=t=>{let l=n(".options-link"),o=location.origin+"/pages/options.html";t.startsWith(o)?h(()=>{l.nextElementSibling.remove(),l.remove()}):(l.href!==o&&h(()=>{l.href=o}),l.onclick=t=>{t.preventDefault();let l=e.Object.create(null);l.u=o,c.dn(l),window.close()})},Se=()=>{c.Ye.o||window.addEventListener("keydown",e=>{e.altKey&&(88===e.keyCode||pe&&90===e.keyCode)&&!(e.shiftKey||e.ctrlKey||e.metaKey)&&(e.preventDefault(),e.stopImmediatePropagation(),Pe(88===e.keyCode?se:"Reset"))}),fe=new xe(n("#exclusionRules"),()=>{if(ae){ae=false;let e=n("#helpSpan");e&&(e.nextElementSibling.style.display="",e.remove()),we.removeAttribute("disabled"),we.firstChild.data=Re("o115_2")}be=Object.create(null),Oe(re<2)}),h(()=>{fe.os()})};Promise.all([c.O(),c.ii(null),new Promise(e=>{_.tabs.query({currentWindow:true,active:true},e)})]).then(e=>{var t;let l=e[2][0],o=l.url,i=c.no(l.id),s=n("#blocked-msg"),u=!(i||l&&o&&"loading"===l.status&&/^(ht|s?f)tp/.test(o));if(te(1),u||Ue(i))return ze(s,l,o,i),Ne(o),void h(oe);h(e=>{s.remove(),s=null;let t=document.documentElement.classList;t.toggle("no-dark",!c.Ye.d),t.toggle("less-motion",!!c.Ye.m);let l=_.runtime.getManifest();e.textContent=l.version_name||l.version},n(".version")),i&&i.Zl&&(pe=true,ce=i.Zl.Ke),ne=!i||i.er.s.Yl&&!me.test(i.er.s.Ot)?{Yl:0,tr:l.incognito,Ke:0,Zt:0,Xl:l.id,Ot:o}:i.er.s,ne.Yl&&(ue=(null===(t=null==i?void 0:i.lr)||void 0===t?void 0:t.s.Ot)||o),ie=ne.Ot,we.onclick=ke,document.addEventListener("keyup",e=>{13===e.keyCode&&(e.ctrlKey||e.metaKey)&&(setTimeout(window.close,300),ae||ke())}),$e(e[1]),Ne(o),Ie(),Se(),h(oe),le&&h(le)});let Ue=e=>!!e&&"string"==typeof e.nr&&true!==c.ke.get(e.nr),ze=(e,t,l,o)=>{let i=document.body,u=document.documentElement;i.innerText="",e.style.display="";let r=_.runtime.getManifest();e.querySelector(".version").textContent=r.version_name||r.version;let a=e.querySelector("#refresh-after-install");t&&l&&/^(ht|s?f)tp/i.test(l)?/\bOpera\//.test(navigator.userAgent)&&/\.(google|bing|baidu)\./.test(l.split("/",4).slice(0,3).join("/"))&&(e.querySelector("#opera-warning").style.display=""):a.remove(),i.style.width="auto",i.append(e);let d=Ue(o)?o.nr:l.startsWith(location.protocol)&&!l.startsWith(location.origin)?new URL(l).host:"",f=d?c.ke.get(d):null;if(null!=f&&true!==f){let e=n("#injection-refused");e.style.display="",e.nextElementSibling.remove(),o&&(o.nr=-1),n("#doAllowExt").onclick=function(){let e=s.Nt("extAllowList"),t=e.split("\n"),l=d;if(t.indexOf(l)<0){let o=t.indexOf("# "+l)+1||t.indexOf("#"+l)+1;t.splice(o?o-1:t.length,o?1:0,l),e=t.join("\n"),s.Rt("extAllowList",e)}o&&(o.nr=null),this.onclick=null,_.tabs.query({active:true,currentWindow:true},e=>{let t=()=>(setTimeout(()=>location.reload(),500),_.runtime.lastError);return e&&e[0]?_.tabs.reload(e[0].id,t):_.tabs.reload(t),_.runtime.lastError})}}u.classList.toggle("no-dark",!c.Ye.d),u.style.height="";let p=n("#retryInject");/^(file|ftps?|https?):/.test(l)&&t?p.onclick=e=>{e.preventDefault(),c.no(t.id)||c.vl(t.id),window.close()}:(p.nextElementSibling.remove(),p.remove())};