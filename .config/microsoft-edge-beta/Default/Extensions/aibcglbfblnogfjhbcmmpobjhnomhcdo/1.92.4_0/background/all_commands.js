"use strict";__filename="background/all_commands.js",define(["require","exports","./store","./browser","./normalize_urls","./parse_urls","./settings","./ports","./ui_css","./i18n","./key_mappings","./run_commands","./clipboard","./open_urls","./frame_commands","./filter_tabs","./tab_commands","./tools"],(e,t,l,o,r,n,i,a,u,s,d,f,c,m,p,h,v,b)=>{Object.defineProperty(t,"__esModule",{value:true}),i=__importStar(i),l.y([0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,2,0,1,0,0,0,0,2,0,1,0,2,2,0,0,1,0,0,1,0,0,1,0,2,1,1,0,0,0,0]),l.Y([()=>{let e=l.get_cOptions().for||l.get_cOptions().wait;"ready"!==e?(e=e?Math.abs("count"===e||"number"===e?l.cRepeat:0|e):f.hasFallbackOptions(l.get_cOptions())?Math.abs(l.cRepeat):0,e&&(e=Math.max(34,e),e>17&&e<=1e3&&l.cPort&&l.cPort.postMessage({N:16,t:e+50}),f.runNextCmdBy(1,l.get_cOptions(),e))):f.runNextOnTabLoaded({},null,()=>{f.runNextCmdBy(1,l.get_cOptions(),1)})},()=>{let e=l.get_cOptions().rel,t=e?(e+"").toLowerCase():"next",o=null!=l.get_cOptions().isNext?!!l.get_cOptions().isNext:!t.includes("prev")&&!t.includes("before"),r=c.rn(l.get_cOptions());c.doesNeedToSed(8192,r)?Promise.resolve(a.Vl(l.Pe.get(l.cPort.s.Xl).lr)).then(e=>{let n=o?l.cRepeat:-l.cRepeat,i=e&&l.j(e,8192,r),[a,u]=i?m.goToNextUrl(i,n,!l.get_cOptions().absolute||"absolute"):[false,e];a&&u?(l.set_cRepeat(n),null==l.get_cOptions().reuse&&f.overrideOption("reuse",0),f.overrideCmdOptions({url_f:u,goNext:false}),m.openUrl()):p.framesGoNext(o,t)}):p.framesGoNext(o,t)},e=>{let t,o=l.get_cOptions().key,r=null!=(t=l.get_cOptions().hideHUD)||null!=(t=l.get_cOptions().hideHud)?!t:!l.Te.hideHud,n=o&&"string"==typeof o&&(o.length>2||o.length<2&&!/[0-9a-z]/i.test(o))?d.la(o):"";f.sendFgCmd(7,r,{h:r?s.or("5",[n&&": "+(1===n.length?`" ${n} "`:o)]):null,k:n||null,i:!!l.get_cOptions().insert,p:!!l.get_cOptions().passExitKey,r:+!!l.get_cOptions().reset,u:!!l.get_cOptions().unhover}),e(1)},p.nextFrame,p.parentFrame,p.performFind,e=>{let t=(l.get_cOptions().key||"")+"",o="darkMode"===t?"d":"reduceMotion"===t?"m":i.Lt[t],r=o?l.Ye[o]:0,n=s.or("quoteA",[t]),u=l.get_cOptions().value,d="boolean"==typeof u,c="";if(o?"boolean"==typeof r?d||(u=null):d||void 0===u?c=s.or(d?"notBool":"needVal",[n]):typeof u!=typeof r&&(c=JSON.stringify(r),c=s.or("unlikeVal",[n,c.length>10?c.slice(0,9)+"\u2026":c])):c=s.or(t in i.Ft?"notFgOpt":"unknownA",[n]),c)a.showHUD(c);else{u=i.Et(o,u);let t=l.Pe.get(l.cPort.s.Xl),r=t.er;for(let e of t.Qt){let t=e===r;f.portSendFgCmd(e,8,t,{k:o,n:t?n:"",v:u},1)}e(1)}},()=>{0!==l.cPort.s.Yl||64&l.cPort.s.Zt?(new Promise((t,o)=>{e([l.e.HelpDialogJS],t,o)}).then(__importStar),f.sendFgCmd(17,true,l.get_cOptions())):p.initHelp({a:l.get_cOptions()},l.cPort)},()=>{p.showVomnibar()},p.enterVisualMode,e=>{let t=l.get_cOptions().folder||l.get_cOptions().path,r=t?(t+"").replace(/\\\/?|\//g,e=>e.length>1?"/":"\n").split("\n").filter(e=>e):[],n=!!l.get_cOptions().all;if(!r.length)return a.showHUD('Need "path" to a bookmark folder.'),void e(0);o.Al.bookmarks.getTree(t=>{if(!t)return e(0),o.Fl();let i=t[0].children,u=i.filter(e=>e.title===r[0]);i=u.length?u:i.reduce((e,t)=>e.concat(t.children),[]);let s=null;for(let t of r){if(i=i.filter(e=>e.title===t),!i.length)return e(0),a.showHUD("The bookmark folder is not found.");if(s=i[0],!s.children)break}(!n&&l.cRepeat*l.cRepeat<2?o.getCurTab:o.ql)(function t(l){if(!l||!l.length)return void o.Fl();let r=o.selectFrom(l).index,[i,u]=n?[0,l.length]:h.getTabRange(r,l.length),d=u-i;if(d>20&&f.tn())f.ln("addBookmark",d).then(t.bind(0,l));else{for(let e of l.slice(i,u))o.Al.bookmarks.create({parentId:s.id,title:e.title,url:o.getTabUrl(e)},o.Fl);a.showHUD(`Added ${u-i} bookmark${u>i+1?"s":""}.`),e(1)}})})},e=>{false!==l.get_cOptions().copied?(f.overrideCmdOptions({copied:true}),m.openUrl()):e(0)},p.captureTab,e=>{e(b.dr.br(l.get_cOptions(),l.cPort))},e=>{let t=l.cPort?l.cPort.s.tr:2===l.we;b.fr.xr(t),a.showHUD(s.or("fhCleared",[t?s.or("incog"):""])),e(1)},e=>{let t=l.get_cOptions().local?l.get_cOptions().all?b._r.$r("#"):a.Ql({H:19,u:"",a:2},true):b._r.$r();t&&t instanceof Promise?t.then(t=>{t&&e(1)}):e(1)},v.copyWindowInfo,function e(t,r,n){let i,a=l.get_cOptions().$pure;if(null==a&&f.overrideOption("$pure",a=!Object.keys(l.get_cOptions()).some(e=>"opener"!==e&&"position"!==e&&"evenIncognito"!==e&&"$"!==e[0])),a)if(!(i=t&&t.length>0?t[0]:null)&&l.Ce>=0&&!o.Fl()&&"dedup"!==n)o.kl(o.tabsGet,l.Ce).then(t=>{e(t&&[t],r,"dedup")});else{let e=true===l.get_cOptions().opener;o.openMultiTabs(i?{active:true,windowId:i.windowId,openerTabId:e?i.id:void 0,index:m.newTabIndex(i,l.get_cOptions().position,e,true)}:{active:true},l.cRepeat,l.get_cOptions().evenIncognito,[null],true,i,e=>{e&&o.selectWndIfNeed(e),r(!!e)})}else m.openUrl(t)},(e,t)=>{h.fi(true,1,function e(t,[r,n,i],u,d){d&&([r,i]=h.getTabRange(n,t.length,0,1));let c=i-r-1;if(c>20&&f.tn())return void f.ln("discardTab",c).then(e.bind(null,t,[r,n,i],u));let m=1!==t.length||t[0].active?t[n+((l.cRepeat>0?n+1<i:0===n)?1:-1)]:t[0],p=[],v=!m.discarded;v&&(c<2||m.autoDiscardable)&&p.push(o.kl(o.$l.discard,m.id));for(let e=r;e<i;e++){let l=t[e];e===n||l===m||l.discarded||(v=true,l.autoDiscardable&&p.push(o.kl(o.$l.discard,l.id)))}p.length?Promise.all(p).then(e=>{let t=e.filter(e=>void 0!==e),l=t.length>0;a.showHUD(l?`Discarded ${t.length} tab(s).`:s.or("discardFail")),u(l)}):(a.showHUD(v?s.or("discardFail"):"Discarded."),u(0))},e,t)},e=>{let t=l.cPort?l.cPort.s.Xl:l.Ce;if(t<0)return a.complainLimits(s.or("dupTab")),void e(0);let r=false===l.get_cOptions().active;o.kl(o.$l.duplicate,t).then(n=>{n?(r&&o.selectTab(t,o.Fl),r?e(1):f.runNextOnTabLoaded(l.get_cOptions(),n),l.cRepeat<2||o.tabsGet(t,e=>{o.openMultiTabs({url:o.getTabUrl(e),active:false,windowId:e.windowId,pinned:e.pinned,index:e.index+2,openerTabId:e.id},l.cRepeat-1,true,[null],true,e,null)})):e(0)}),r&&o.selectTab(t,o.Fl)},e=>{e.length&&p.framesGoBack({s:l.cRepeat,o:l.get_cOptions()},null,e[0])},e=>{let t=l.cRepeat,r=!!l.get_cOptions().absolute,n=n=>{let i=o.selectFrom(n),a=n.length,u=r?t>0?Math.min(a,t)-1:Math.max(0,a+t):Math.abs(t)>2*a?t>0?a-1:0:i.index+t;if(u=u>=0?u%a:a+(u%a||-a),n[0].pinned&&l.get_cOptions().noPinned&&!i.pinned&&(t<0||r)){let e=1;for(;n[e].pinned;)e++;a-=e,r||Math.abs(t)>2*a?u=r?Math.max(e,u):u||e:(u=i.index-e+t,u=u>=0?u%a:a+(u%a||-a),u+=e)}let s=n[u],d=!s.active;d&&o.selectTab(s.id),e(d)};r?1===l.cRepeat?o.kl(o.$l.query,{windowId:l.Se,index:0}).then(t=>{t&&t[0]&&o.Wl(t[0])?n(t):h.fi(false,1,n,[],e)}):h.fi(false,1,n,[],e):1===Math.abs(l.cRepeat)?o.kl(o.getCurTab).then(t=>{h.fi(false,1,n,t||[],e)}):h.fi(false,1,n,[],e)},()=>{var e;"frame"!==l.get_cOptions().type&&l.cPort&&l.cPort.s.Yl&&l.set_cPort((null===(e=l.Pe.get(l.cPort.s.Xl))||void 0===e?void 0:e.lr)||l.cPort);let t={H:3,u:"",p:l.cRepeat,t:l.get_cOptions().trailingSlash,r:l.get_cOptions().trailing_slash,s:c.rn(l.get_cOptions()),e:false!==l.get_cOptions().reloadOnRoot},o=a.Ql(t);Promise.resolve(o||"url").then(()=>{"object"==typeof t.e&&f.getRunNextCmdBy(2)(null!=t.e.p||void 0)})},v.joinTabs,p.mainFrame,(e,t)=>{let r=l.get_cOptions().group,n="ignore"!==r&&false!==r;h.fi(false,1,r=>{let i=o.selectFrom(r),a=i.pinned,u=r.indexOf(i),s=Math.max(0,Math.min(r.length-1,u+l.cRepeat));for(;a!==r[s].pinned;)s-=l.cRepeat>0?1:-1;if(s!==u&&n){let e=o.getGroupId(i),t=o.getGroupId(r[s]);if(t!==e&&(1===Math.abs(l.cRepeat)||e!==o.getGroupId(r[l.cRepeat>0?s<r.length-1?s+1:s:s&&s-1]))){for(null!==e&&(s=u,t=e);s+=l.cRepeat>0?1:-1,0<=s&&s<r.length&&o.getGroupId(r[s])===t;);s-=l.cRepeat>0?1:-1}}s===u&&i.active?t(0):o.$l.move((i.active?i:e[0]).id,{index:r[s].index},o.yl(t))},e,t,n?t=>o.getGroupId(e[0])===o.getGroupId(t):null)},v.moveTabToNewWindow,v.moveTabToNextWindow,()=>{m.openUrl()},(e,t)=>{h.fi(!l.get_cOptions().single,0,v.reloadTab,e,t)},(e,t)=>{h.fi(false,1,(e,[t],l)=>{o.$l.remove(e[t].id,o.yl(l))},e,t)},v.removeTab,e=>{let t=l.get_cOptions().other?0:l.cRepeat;h.di(t,function r(n){let i=n;if(!i||0===i.length)return o.Fl();let a=o.selectFrom(i),u=i.indexOf(a),s=l.get_cOptions().noPinned,d=l.get_cOptions().filter;t>0?(++u,i=i.slice(u,u+t)):(s=null!=s?s&&i[0].pinned:u>0&&i[0].pinned&&!i[u-1].pinned,t<0?i=i.slice(Math.max(u+t,0),u):i.splice(u,1)),s&&(i=i.filter(e=>!e.pinned)),d&&(i=h.si(a,i,d));let c=l.get_cOptions().mayConfirm;c&&i.length>("number"==typeof c?Math.max(c,5):20)&&f.tn()&&f.ln("closeOtherTabs",i.length).then(r.bind(null,n)),i.length>0?o.$l.remove(i.map(e=>e.id),o.yl(e)):e(0)})},(e,t)=>{if(e.length<=0)return void t(0);let o=e[0],r=false!==l.get_cOptions().group;v.kr(o,void 0,void 0,r)},e=>{let t=o.Ol();if(!t)return e(0),a.complainNoSession();let r=!!l.get_cOptions().one,n=t.MAX_SESSION_RESULTS,i=Math.abs(l.cRepeat);if(i>n){if(r)return e(0),void a.showHUD(s.or("indexOOR"));i=n}if(!r&&i<2&&(l.cPort?l.cPort.s.tr:2===l.we)&&!l.get_cOptions().incognito)return e(0),a.showHUD(s.or("notRestoreIfIncog"));if(r&&i>1)t.getRecentlyClosed({maxResults:i},l=>{if(i>l.length)return e(0),a.showHUD(s.or("indexOOR"));let o=l[i-1],r=o&&(o.tab||o.window);r?t.restore(r.sessionId,f.getRunNextCmdBy(0)):e(0)});else for(t.restore(null,f.getRunNextCmdBy(0));0<--i;)t.restore(null,o.Fl)},()=>{null==l.get_cOptions().$seq?f.runKeyWithCond():f.runKeyInSeq(l.get_cOptions().$seq,l.cRepeat,l.get_cOptions().$f)},e=>{let t=(l.get_cOptions().keyword||"")+"",i=n.Gl({u:o.getTabUrl(e[0])});if(!i||!t)return void(f.runNextCmd(0)||a.showHUD(s.or(t?"noQueryFound":"noKw")));let u=c.rn(l.get_cOptions());i.u=l.j(i.u,0,u);let d=r.zt(i.u.split(" "),t,2),p=l.get_cOptions().reuse;f.overrideCmdOptions({url_f:d,reuse:null!=p?p:0,opener:true,keyword:""}),m.openUrl(e)},e=>{let t=l.get_cOptions().id,r=l.get_cOptions().data;if(t&&"string"==typeof t&&void 0!==r){let n=Date.now();o.Al.runtime.sendMessage(t,l.get_cOptions().raw?r:{handler:"message",from:"Vimium C",count:l.cRepeat,keyCode:l.cKey,data:r},l=>{let r=o.Fl();return r?(console.log("Can not send message to the extension %o:",t,r),a.showHUD("Error: "+(r.message||r)),e(0)):"string"==typeof l&&Math.abs(Date.now()-n)<1e3&&a.showHUD(l),r||e(false!==l),r})}else a.showHUD('Require a string "id" and message "data"'),e(0)},e=>{let t=l.get_cOptions().text;if(!t&&l.get_cOptions().$f){let o=l.get_cOptions().$f;if(t=o&&o.t?s.or(`${o.t}`):"",!t)return void e(false)}a.showHUD(t?t+"":s.or("needText")),e(!!t)},(e,t)=>{b.dr.yr(l.get_cOptions(),l.cRepeat,e,t)},v.toggleMuteTab,(e,t)=>{h.fi(true,0,v.togglePinTab,e,t)},v.toggleTabUrl,(e,t)=>{let o=e[0].id,r=((l.get_cOptions().style||"")+"").trim(),n=!!l.get_cOptions().current;if(!r)return a.showHUD(s.or("noStyleName")),void t(0);for(let e of l.fe)if(e.s.Xl===o)return e.postMessage({N:46,t:r,c:n}),void setTimeout(t,100,1);n||u.en({t:r,o:1}),setTimeout(t,100,1)},p.toggleZoom,e=>{let t=!!l.get_cOptions().acrossWindows,r=!!l.get_cOptions().onlyActive,n=t=>{if(t.length<2)return r&&a.showHUD("Only found one browser window"),e(0),o.Fl();let n=t.findIndex(e=>e.id===l.Ce);n>=0&&t.splice(n,1);let u=t.filter(e=>l.Ee.has(e.id)).sort(b.ar.Xr),s=(t=r&&0===u.length?t.sort((e,t)=>t.id-e.id):u)[l.cRepeat>0?Math.min(l.cRepeat,t.length)-1:Math.max(0,t.length+l.cRepeat)];s?r?o.Pl.update(s.windowId,{focused:true},o.yl(e)):i(s.id):e(0)},i=t=>{o.selectTab(t,t=>(t&&o.selectWndIfNeed(t),o.yl(e)()))};if(1===l.cRepeat&&!r&&-1!==l.Ce){let e=h.ai();if(e>=0)return void o.kl(o.tabsGet,e).then(e=>{e&&(t||e.windowId===l.Se)&&o.Wl(e)?i(e.id):t?o.$l.query({},n):o.ql(n)})}t||r?o.$l.query(r?{active:true}:{},n):o.ql(n)},e=>{let t=l.get_cOptions().newWindow;true!==t&&true?o.kl(o.Al.permissions.contains,{permissions:["downloads.shelf","downloads"]}).then(r=>{if(r){let t,l=o.Al.downloads.setShelfEnabled;try{l(false),setTimeout(()=>{l(true),e(1)},256)}catch(e){t=(e&&e.message||e)+""}a.showHUD(t?"Can not close the shelf: "+t:"The download bar has been closed"),t&&e(0)}else false===t&&l.cPort?(a.showHUD("No permissions to close download bar"),e(0)):l.se[26](e)}):l.se[26](e)},e=>{let t=l.Pe.get(l.cPort?l.cPort.s.Xl:l.Ce);for(let e of t?t.Qt:[])f.portSendFgCmd(e,7,false,{r:1},1);t&&t.er.postMessage({N:16,t:150}),e(1)}])});