"use strict";__filename="background/browsing_data_manager.js",define(["require","exports","./store","./browser","./utils","./settings","./completion_utils"],(e,t,l,r,i,o,n)=>{Object.defineProperty(t,"__esModule",{value:true}),t._i=t.mi=t.ci=t.pi=t.hi=t.Ti=t.bi=void 0,i=__importStar(i),o=__importStar(o);let u,f,s=decodeURIComponent,_=-1,a="1",m=null,c=null,d=null;t.bi=e=>{let t,l,r=e.lastIndexOf(":",5),i=r>0?e.slice(0,r):"";if("http"===i)t=7;else if("https"===i)t=8;else{if("ftp"!==i)return null;t=6}return l=e.indexOf("/",t),{gi:"__proto__"!==(e=e.slice(t,l<0?e.length:l))?e:".__proto__",vi:t}},t.Ti={xi:null,yi:"",ki:0,Qr:0,wi:null,Di(){let e=r.Al.bookmarks;e.onCreated.addListener(t.Ti.Li),e.onRemoved.addListener(t.Ti.Ri),e.onChanged.addListener(t.Ti.Ri),e.onMoved.addListener(t.Ti.Li),e.onImportBegan.addListener(()=>{r.Al.bookmarks.onCreated.removeListener(t.Ti.Li)}),e.onImportEnded.addListener(()=>{r.Al.bookmarks.onCreated.addListener(t.Ti.Li),t.Ti.Li()})},Ii(){l.ce.Ke=1,t.Ti.Qr&&(clearTimeout(t.Ti.Qr),t.Ti.Qr=0),r.Al.bookmarks.getTree(t.Ti.Ui)},Ui(e){l.ce.Fe=[],l.ce.Je=[],l.ce.Ke=2,n.ji.$r(2),e.forEach(t.Ti.Mi,t.Ti),setTimeout(()=>t._i.Si(l.ce.Fe),50),t.Ti.Di&&(setTimeout(t.Ti.Di,0),t.Ti.Di=null);let r=t.Ti.wi;t.Ti.wi=null,r&&r()},Mi(e){let r=e.title,o=e.id,n=t.Ti.yi+"/"+(r||o);if(e.children){l.ce.Je.push(o);let r=t.Ti.yi;2<++t.Ti.ki&&(t.Ti.yi=n),e.children.forEach(t.Ti.Mi,t.Ti),--t.Ti.ki,t.Ti.yi=r}else{let u=e.url,f="javascript:",s=u.startsWith(f);l.ce.Fe.push({Ei:o,Oi:n,Ai:r||o,t:s?f:u,Bi:c?t.ci(u,r):1,u:s?f:u,Pi:s?u:null,Vi:s?i.tt(u):null})}},Wi(){let e=performance.now()-l.ce.ze;0===l.ce.Ke&&(e>=6e4||e<-5e3?(t.Ti.Qr=l.ce.ze=0,l.ce.Qe=false,t.Ti.Ii()):(l.ce.Fe=[],l.ce.Je=[],t.Ti.Qr=setTimeout(t.Ti.Wi,3e4),n.ji.$r(2)))},Li(){l.ce.ze=performance.now(),l.ce.Ke<2||(t.Ti.Qr=setTimeout(t.Ti.Wi,6e4),l.ce.Ke=0)},Ri(e,r){let i=l.ce.Fe,o=i.length,n=r&&r.title,f=0;for(;f<o&&i[f].Ei!==e;f++);if(f<o){let e=i[f],o=e.u,s=r&&r.url;return u&&(null==n?o!==e.t||!r:null!=s&&o!==s)&&l.de.has(o)&&t.hi.qi&&t.hi.Ci(o)<0&&l.de.delete(o),void(null!=n?(e.Oi=e.Oi.slice(0,-e.Ai.length)+(n||e.Ei),e.Ai=n||e.Ei,s&&(e.u=s,e.t=t._i.Hi(s,e),t._i.zi()),c&&(e.Bi=t.ci(e.u,e.Ai))):(i.splice(f,1),r||t.Ti.Li()))}if(!(l.ce.Je.indexOf(e)<0)){if(null!=n)return t.Ti.Li();if(!l.ce.Qe&&u){let e=l.de,r=t.hi.Ci;for(let{u:l}of t.hi.qi?i:[])e.has(l)&&r(l)<0&&e.delete(l);l.ce.Qe=true}return t.Ti.Li()}}};let p=e=>{e&&e()};t.hi={qi:false,Fi:0,Gi:null,Ji(e){t.hi.Gi?e&&t.hi.Gi.push(e):(l.ue.Ze=Date.now(),t.hi.Gi=e?[e]:[],t.hi.Fi||r.Al.history.search({text:"",maxResults:2e4,startTime:0},e=>{setTimeout(t.hi.Ki,0,e)}))},Ki(e){t.hi.Ki=null;for(let l=0,r=e.length;l<r;l++){let r=e[l],i=r.url;i.length>2e3&&(i=t.hi.Ni(i,r)),e[l]={t:i,Ai:r.title,Qi:r.lastVisitTime,Bi:1,u:i}}if(c)for(let l of e)0===t.ci(l.t,l.Ai)&&(l.Bi=0);setTimeout(()=>{setTimeout(()=>{let e=l.ue.We;for(let l=e.length-1;0<l;){let r=e[l],i=r.u,o=r.t=t._i.Hi(i,r),n=o.length>=i.length;for(;0<=--l;){let r=e[l],u=r.u;if(u.length>=i.length||!i.startsWith(u))break;r.u=i.slice(0,u.length);let f=n?u:t._i.Hi(u,r);r.t=n||f.length<u.length?o.slice(0,f.length):f}}l.ue.Xe||setTimeout(()=>{t.hi.Xi&&t.hi.Xi(l.ue.We)},200)},100),l.ue.We.sort((e,t)=>e.u>t.u?1:-1),t.hi.qi=true,r.Al.history.onVisitRemoved.addListener(t.hi.Yi),r.Al.history.onVisited.addListener(t.hi.Zi)},100),l.ue.We=e,t.hi.Ji=p,t.hi.Gi&&t.hi.Gi.length>0&&setTimeout(e=>{for(let t of e)t()},1,t.hi.Gi),t.hi.Gi=null},Zi(e){let r=e.url;r.length>2e3&&(r=t.hi.Ni(r,e));let i=e.lastVisitTime,o=e.title,u=++l.ue.$e,f=l.ue.Xe,s=t.hi.Ci(r);s<0&&l.ue.el++,(u>59||u>10&&Date.now()-l.ue.Ze>3e5)&&t.hi.$i();let _,a=s>=0?l.ue.We[s]:{t:"",Ai:o,Qi:i,Bi:c?t.ci(r,o):1,u:r};if(f){let e=t.bi(r);e&&((_=f.get(e.gi))?(_.Qi=i,s<0&&(_.lo+=a.Bi),e.vi>=7&&(_.Mt=8===e.vi?1:0)):f.set(e.gi,{Qi:i,lo:a.Bi,Mt:8===e.vi?1:0}))}if(s>=0){if(a.Qi=i,o&&o!==a.Ai&&(a.Ai=o,n.ji.Wr&&n.ji.$r(1),c)){let e=t.ci(r,o);a.Bi!==e&&(a.Bi=e,_&&(_.lo+=e||-1))}}else a.t=t._i.Hi(r,a),l.ue.We.splice(~s,0,a),n.ji.Wr&&n.ji.$r(1)},Yi(e){f.length=0;let r=l.de;if(n.ji.$r(1),e.allHistory){l.ue.We=[],l.ue.Xe=new Map;let e=new Set(l.ce.Fe.map(e=>e.u));return void r.forEach((t,l)=>{e.has(l)||r.delete(l)})}let i,o=t.hi.Ci,{We:u,Xe:s}=l.ue;for(let l of e.urls){let e=o(l);if(e>=0){if(s&&u[e].Bi){let e=t.bi(l);e&&(i=s.get(e.gi))&&--i.lo<=0&&s.delete(e.gi)}u.splice(e,1),r.delete(l)}}},Ni(e,t){let l=e.lastIndexOf(":",9),r=l>0&&"://"===e.substr(l,3),o=t.title;return e=e.slice(0,(r?e.indexOf("/",l+4):l)+320)+"\u2026",o&&o.length>160&&(t.title=i.ut(o,0,160)),e},$i(){let e=Date.now();if(l.ue.el<=0);else{if(e<l.ue.Ze+1e3&&e>=l.ue.Ze)return;setTimeout(r.Al.history.search,50,{text:"",maxResults:Math.min(999,l.ue.$e+10),startTime:e<l.ue.Ze?e-3e5:l.ue.Ze},t.hi.io)}return l.ue.Ze=e,l.ue.el=l.ue.$e=0,t._i.zi()},Xi(e){t.hi.Xi=null;let r=l.ue.Xe;for(let{u:l,Qi:i,Bi:o}of e){let e=t.bi(l);if(!e)continue;let{gi:n,vi:u}=e,f=r.get(n);f?(f.Qi<i&&(f.Qi=i),f.lo+=o,u>=7&&(f.Mt=8===u?1:0)):r.set(n,{Qi:i,lo:o,Mt:8===u?1:0})}},io(e){let r=l.ue.We,i=t.hi.Ci;if(!(r.length<=0))for(let o of e){let e=o.url;e.length>2e3&&(o.url=e=t.hi.Ni(e,o));let n=i(e);if(n<0)l.ue.el--;else{let e=r[n],t=o.title;if(!t||t===e.Ai)continue}l.ue.$e--,t.hi.Zi(o)}},Ci(e){let t="",r=l.ue.We,i=r.length-1,o=0,n=0;for(;o<=i;)if(n=o+i>>>1,t=r[n].u,t>e)i=n-1;else{if(t===e)return n;o=n+1}return~o}},t.pi=(e,l,i)=>{let o=r.Ol();o?o.getRecentlyClosed({maxResults:Math.min(1.2*e|0,o.MAX_SESSION_RESULTS)},e=>{let r,o=[];for(let i of e){let e=i.tab;if(!e)continue;let n=e.url,u=e.title;n.length>2e3&&(e.url=n=t.hi.Ni(n,e)),(l||t.ci(n,u))&&o.push({u:n,Ai:u,uo:(r=i.lastModified,r<3e11&&r>-4e10?1e3*r:r),fo:[e.windowId,e.sessionId]})}i(o)}):i([])},t.ci=(e,t)=>d.test(t)||d.test(e)?0:1,t.mi={_o(e){if(c)for(let t of e)for(let e of c)if(e=e.trim(),t.includes(e)||e.length>9&&t.length+2>=e.length&&e.includes(t))return true;return false},mo(){if(l.ce.Fe)for(let e of l.ce.Fe)e.Bi=c?t.ci(e.t,e.Oi):1;if(!l.ue.We)return;let e=l.ue.Xe;for(let r of l.ue.We){let l=c?t.ci(r.t,r.Ai):1;if(r.Bi!==l&&(r.Bi=l,e)){let i=t.bi(r.u);if(i){let t=e.get(i.gi);t&&(t.lo+=l||-1)}}}}},t._i={Hi(e,t){if(e.length>=400||e.lastIndexOf("%")<0)return e;try{return s(e)}catch(e){}return l.de.get(e)||(t&&f.push(t),e)},Si(e){let r,i,o=l.de,n=f,u=-1,_=e.length;for(;;)try{for(;++u<_;)r=e[u],i=r.u,r.t=i.length>=400||i.lastIndexOf("%")<0?i:s(i);break}catch(e){r.t=o.get(i)||(n.push(r),i)}t._i.zi()},zi(){0!==f.length&&-1===_&&(_=0,setTimeout(h,17))}};let h=()=>{let e,t=f.length;if(!a||_>=t)return f.length=0,_=-1,void(m=null);for(t=Math.min(_+32,t),m=m||new TextDecoder(a);_<t;_++){let t=f[_],r="string"==typeof t,i=r?t:t.u;(e=l.de.get(i))?r||(t.t=e):(e=i.replace(/%[a-f\d]{2}(?:%[a-f\d]{2})+/gi,T),e=e.length!==i.length?e:i,"string"!=typeof t?l.de.set(t.u,t.t=e):l.de.set(t,e))}_<f.length?setTimeout(h,4):(f.length=0,_=-1,m=null)},T=e=>{let t=new Uint8Array(e.length/3);for(let l=1,r=0;l<e.length;l+=3)t[r++]=parseInt(e.substr(l,2),16);return m.decode(t)};o.Ct.omniBlockList=e=>{let r=[];for(let t of e.split("\n"))t.trim()&&"#"!==t[0]&&r.push(t);d=r.length>0?new RegExp(r.map(i.o).join("|"),""):null,c=r.length>0?r:null,(l.ue.We||l.ce.Fe.length)&&setTimeout(t.mi.mo,100)},o.Dt("omniBlockList"),o.Ct.localeEncoding=e=>{let r=!!e&&!(e=e.toLowerCase()).startsWith("utf"),i=a;if(a=r?e:"",a!==i){try{new TextDecoder(a)}catch(e){r=false}r?"1"!==i&&setTimeout(()=>(l.ue.We&&t._i.Si(l.ue.We),t._i.Si(l.ce.Fe)),100):(l.de.clear(),f&&(f.length=0)),u!==r&&(f=r?[]:{length:0,push:l.A},u=r,_=-1)}},o.Dt("localeEncoding"),l.N.bn=(e,l,i)=>{switch(l){case"tab":n.ji.co(null),r.$l.remove(+e,()=>{let e=r.Fl();return e||n.ji.co(null),i(!e),e});break;case"history":let l=!t.hi.qi||t.hi.Ci(e)>=0;r.Al.history.deleteUrl({url:e}),l&&n.ji.$r(1),i(l)}},l.N.oo=t.mi._o});