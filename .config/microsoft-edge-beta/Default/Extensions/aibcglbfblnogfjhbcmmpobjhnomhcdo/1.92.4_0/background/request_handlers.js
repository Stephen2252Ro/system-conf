"use strict";__filename="background/request_handlers.js",define(["require","exports","./store","./utils","./browser","./parse_urls","./settings","./ports","./exclusions","./ui_css","./i18n","./key_mappings","./run_commands","./open_urls","./frame_commands","./tools"],function(e,l,t,r,n,u,i,o,s,f,a,d,c,m,p,v){Object.defineProperty(l,"__esModule",{value:true}),r=__importStar(r),i=__importStar(i);let _=-1;t.T([(e,l)=>{let r=e.k,n=i.Tt;if(!(r>=0&&r<n.length))return t.set_cPort(l),o.complainLimits(a.or("notModify",[r]));let u=n[r],s=t.O&&t.O();i.Nt(u)!==e.v&&(s?s.then(()=>{i.Rt(u,e.v)}):i.Rt(u,e.v))},(e,l)=>{let t="object"==typeof e;return v.fr.Jr(l.s.tr,t?e.q:"",t?1:e)},(e,l)=>{let t=u.Gl(e);if(null==e.i)return t;l.postMessage({N:44,i:e.i,s:t})},(e,l)=>{let i=e.u,s=e.e,f=u.Dl(e);r.bt(),e.e=f,null==f.p?(t.set_cPort(l),o.showHUD(f.u)):s||i!==f.u?l?c.sendFgCmd(0,false,{r:1,url:f.u}):n.tabsUpdate({url:f.u}):(t.set_cPort(l),o.showHUD("Here is just root"),e.e={p:null,u:"(just root)"})},(e,l)=>{let r,n=u.Gl(e);if(!n||!n.k)return t.set_cPort(l),o.showHUD(a.or("noEngineFound")),void(e.n&&c.runNextCmdBy(0,e.n));let i=e.o||{};r=e.t.trim()&&t.j(e.t.trim(),524288,i.s).trim()||(e.c?t.I(i.s):""),Promise.resolve(r).then(r=>{let u=null===r?"It's not allowed to read clipboard":(r=r.trim())?"":a.or("noSelOrCopied");if(u)return t.set_cPort(l),o.showHUD(u),void(e.n&&c.runNextCmdBy(0,e.n));i.k=null==i.k?n.k:i.k,t.ie[6]({u:r,o:i,r:0,n:c.parseFallbackOptions(e.n)||{}},l)})},(e,l)=>{let r=e.s,u=false!==e.a;if(t.set_cPort(o.findCPort(l)),"number"==typeof r)return void n.selectTab(r,e=>(n.Fl()?o.showHUD(a.or("noTabItem")):n.selectWnd(e),n.Fl()));if(!n.Ol())return void o.complainNoSession();if(n.Ol().restore(r[1],()=>{let e=n.Fl();return e&&o.showHUD(a.or("noSessionItem")),e}),u)return;let i=l.s.Xl;i>=0||(i=t.Ce),i>=0&&n.selectTab(i)},m.openUrlReq,(e,l)=>{let r,n=l.s.Xl,u=t.Pe.get(n);if(!u)return void(t.Ve&&t.L(n,l.s.Ke));let i=u.er;l!==i&&(u.er=l,t.Ve&&(r=l.s.Ke)!==i.s.Ke&&t.L(n,r))},(e,l)=>{let r=l;if(!r&&(r=o.indexFrame(e.tabId,e.frameId),!r))return;let{s:n}=r,{Ot:u}=n,i=e.url,f=t.Pe.get(n.Xl);if(f&&f.Zl)return;let a=s.Xt?s.Yt(n.Ot=l?e.u:i,n):null,d=null===a?0:a?1:2;if(n.Ke!==d)n.Ke=d,t.Ve&&f.er===r&&t.L(n.Xl,d);else if(!a||a===s.Yt(u,n))return;r.postMessage({N:1,p:a,f:0})},(e,l)=>{let r,n=e.t||0;t.set_cPort(l),t.set_cRepeat(n||t.cRepeat>0?1:-1),t.set_cKey(e.k),c.replaceCmdOptions(e.f||{}),2!==n?1===n?p.parentFrame():p.nextFrame():(r=t.Pe.get(l.s.Xl))?p.focusFrame(r.er,r.Qt.length<=2,1,t.get_cOptions()):o.safePost(l,{N:45,l:t.cKey})},(e,l)=>{let r=t.Pe.get(l.s.Xl);if(!r)return;if(r.Zt|=4,r.Qt.length<2)return;let n={N:8};for(let e of r.Qt)e!==l&&e.postMessage(n),e.s.Zt|=4},(e,l,r)=>{let u,i=l.s.Xl,s=t.Pe.get(i),f=e.u;if(!s||s.Qt.length<2)return false;for(let e of s.Qt)if(e.s.Ot===f){if(u){u=null;break}u=e}return u?(t.set_cKey(e.k),g(e,l,u,1),true):!!n.Ml()&&(n.Ml().getAllFrames({tabId:l.s.Xl},n=>{let u=0,s=l.s.Yl;for(let e of n)if(e.parentFrameId===s){if(u){u=0;break}u=e.frameId}let f=u&&o.indexFrame(i,u);f&&(t.set_cKey(e.k),g(e,l,f,1)),o.sendResponse(l,r,!!f)}),l)},p.initHelp,(e,l)=>{t.Pe.get(l.s.Xl).Zt|=4,l.s.Zt|=12,l.postMessage({N:12,H:t.Ne})},(e,l)=>{let{i:n}=e;if(t.set_cKey(0),null!=e.c)c.replaceCmdOptions({url:e.u,newtab:e.n,keyword:e.o.k}),t.set_cRepeat(1);else{if(true!==e.r)return;if(null==t.get_cOptions()||"omni"!==t.get_cOptions().k){if(n)return;t.set_cOptions(r.ct()),t.set_cRepeat(1)}else if(n&&t.get_cOptions().v===t.e.Cl)return}t.set_cPort(l),p.showVomnibar(n)},(e,l)=>{o.isNotVomnibarPage(l,false)||t.N._n(e.q,e,b.bind(l,0|e.i))},(e,l)=>{let n;if(n=e.u||e.s,e.d)if("string"!=typeof n)for(let e=n.length;0<=--e;)n[e]=r.et(n[e]+"");else n=r.et(n);else n.length<4&&!n.trim()&&" "===n[0]&&(n="");n=n&&t.R(n,e.j,e.e),t.set_cPort(l),n=e.s&&"object"==typeof e.s?`[${e.s.length}] `+e.s.slice(-1)[0]:n,o.showHUD(e.d?n.replace(/%[0-7][\dA-Fa-f]/g,decodeURIComponent):n,e.u?14:15)},(e,l)=>{let n=null!=l?l.s:null;if(null!==n&&!(4&n.Zt)){n.Zt|=4;let e=t.Pe.get(n.Xl);e&&(e.Zt|=4)}let u=e.k,i=1,o=/^\d+|^-\d*/.exec(u);if(null!=o){let e=o[0];u=u.slice(e.length),i="-"!==e?parseInt(e,10)||1:-1}let s=t.pe.get(u);s||(o=u.match(d.da),u=o[o.length-1],i=1,s=t.pe.get(u)),r.bt(),s&&c.executeCommand(s,i,e.l,l,0,null)},c.waitAndRunKeyReq,(e,l)=>{switch(t.set_cPort(l),e.a){case 1:return v._r.Ar(e,l);case 0:return v._r.Lr(e,l);case 2:return v._r.$r(e.u);default:return}},m.dn,c.onConfirmResponse,({t:e,s:l,u:r},u)=>{var i;let s="history"===e&&null!=l?"session":e,f="tab"===s?s:s+" item",d=e=>{o.showHUD(a.or(e?"delSug":"notDelSug",[a.ur("sugs",s[0])||f]))};if(t.set_cPort(o.findCPort(u)),"tab"===s&&t.Ce===l)o.showHUD(a.or("notRemoveCur"));else if("session"!==s)t.N.bn("tab"===s?l:r,s,d);else if(null===(i=n.Ol())||void 0===i?void 0:i.forgetClosedTab){let e=l;n.Ol().forgetClosedTab(e[0],e[1]).then(()=>1,t.A).then(d)}},p.openImgReq,(e,l)=>{t.set_cPort(null),m.openJSUrl(e.u,{},()=>{t.set_cPort(l),o.showHUD(a.or("jsFail"))})},(e,l)=>{var r;2!==e.c&&4!==e.c?g(e,l,(null===(r=t.Pe.get(l.s.Xl))||void 0===r?void 0:r.lr)||null,e.f):o.getParentFrame(l.s.Xl,l.s.Yl,1).then(r=>{var n;g(e,l,r||(null===(n=t.Pe.get(l.s.Xl))||void 0===n?void 0:n.lr)||null,e.f)})},f.en,(e,l)=>{c.replaceCmdOptions({active:true,returnToViewport:true}),t.set_cPort(l),t.set_cRepeat(1),p.performFind()},p.framesGoBack,()=>(a.sr&&a.sr(),a.ir),(e,l)=>{l.s.Zt|=8},(e,l)=>{c.replaceCmdOptions({mode:e.c?"caret":"",start:true}),t.set_cPort(l),t.set_cRepeat(1),p.enterVisualMode()},e=>{if(performance.now()-e.r.n<500){let l=e.r.c;l.element=e.e&&[e.e[0],e.e[1],r.m(e.e[2])],c.runKeyWithCond(l)}},(e,l)=>{n.downloadFile(e.u,e.f,e.r,e.m?r=>{r||t.ie[23]({r:-1,f:e.f,u:e.u},l)}:null)},(e,l,t)=>(setTimeout(()=>{o.sendResponse(l,t,0)},e),l)]);let b=function(e,l,n,u,i,s,f,a){var d;let c,m,{Ot:p}=this.s,v=2===e?2:0;if(1===e&&true){p=p.slice(0,p.indexOf("/",p.indexOf("://")+3)+1);let e=-1!==_?null===(d=t.Pe.get(_))||void 0===d?void 0:d.lr:null;if(null!=e&&(e.s.Ot.startsWith(p)?v=1:_=-1),v);else for(let e of t.Pe.values())if(c=e.lr,m=c&&c.s,m&&m.Ot.startsWith(p)){v=1,_=m.Xl;break}}o.safePost(this,{N:43,a:n,c:a,i:v,l,m:u,r:f,s:i,t:s}),r.bt()},g=(e,l,r,n)=>{r&&2!==r.s.Ke?r.postMessage({N:7,H:n||4!==e.c?o.ensureInnerCSS(l.s):null,m:n?4:0,k:n?t.cKey:0,f:{},c:e.c,n:e.n||0,a:e.a}):(e.a.$forced=1,c.portSendFgCmd(l,e.c,false,e.a,e.n||0))}});