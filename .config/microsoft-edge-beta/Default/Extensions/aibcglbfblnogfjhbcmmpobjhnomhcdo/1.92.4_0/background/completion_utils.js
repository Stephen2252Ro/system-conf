"use strict";__filename="background/completion_utils.js",define(["require","exports","./store","./browser","./utils","./settings","./parse_urls","./tools","./browsing_data_manager"],(e,t,r,l,n,u,o,i,a)=>{Object.defineProperty(t,"__esModule",{value:true}),t.of=t.Df=t.sortBy0=t.shortenUrl=t.highlight=t.cutTitle=t.$f=t.get2ndArg=t.ComputeRelevancy=t.ComputeRecency=t.ComputeWordRelevancy=t.if=t.ff=t.cf=t.jf=t.ji=t.gf=t.Cf=t.setupQueryTerms=t.set_tabsInNormal=t.bf=t.tabsInNormal=void 0,n=__importStar(n),u=__importStar(u);let f=[0,0],s=null;t.tabsInNormal=s;let _,c,m,h,d=null,p=0,b=[],w=0,g=3;t.bf=g,t.set_tabsInNormal=e=>{t.tabsInNormal=s=e},t.setupQueryTerms=(e,t,r)=>{_=e,c=t,h=false,m=r},t.Cf=e=>{w=e},t.gf=e=>{t.bf=g=e},t.ji={lf:null,rf:null,Wr:0,hn:0,Vr(e){let l=null,n=0,u=_.join(" ");for(let t=b,r=u?t.length:0;0<=--r;){if(!t[r].xn&&e)continue;let n=t[r].Jr,u=0,o=0;for(;u<n.length&&o<_.length;o++)_[o].includes(n[u])&&u++;if(u>=n.length){l=t[r];break}}t.ji.lf=l,l&&(r.ye.t<200||!l.We||l.We.length>1e3)&&(n=performance.now())-l.Qi<Math.max(300,1.3*r.ye.t)?(t.ji.rf=l,l.Jr=_.slice(0)):!u||l&&u===l.Jr.join(" ")||!(u.length>4||/\w\S|[^\x00-\x80]/.test(u))?t.ji.rf=null:(t.ji.rf={Jr:_.slice(0),xn:e,Qi:n||performance.now(),We:l&&l.We,Fe:l&&l.Fe},b.push(t.ji.rf),t.ji.Wr||(t.ji.Wr=setInterval(t.ji.Mn,6e3)))},Mn(){let e=b,r=-1,l=performance.now()-5983;for(;++r<e.length&&e[r].Qi<l;);r++,r<e.length?e.splice(0,r):(e.length=0,clearInterval(t.ji.Wr),t.ji.Wr=0)},$r(e){for(let t of b)e<2?t.We=null:e<3?t.Fe=null:d=null},co(e){d!==e&&(t.ji.hn&&(clearTimeout(t.ji.hn),t.ji.hn=0),d=e,e&&(t.ji.hn=setTimeout(t.ji.co,3e3,null)))}},t.jf={Tn:0,Qr:0,Ff(){let e=_[0],l=r.Te.searchKeywords;return null==l?(t.jf.Qr=t.jf.Qr||setTimeout(t.jf.kn,67),true):!(e.length>=t.jf.Tn)&&l.includes("\n"+e)},kn(){let e=n.dt(r.Te.searchEngineMap).sort(),l=0,o="",i=[];for(let t=e.length;0<=--t;){let r=e[t];if(!o.startsWith(r)){let e=r.length;l=e>l?e:l,o=r,i.push(r)}}u.Rt("searchKeywords","\n"+i.join("\n")),t.jf.Tn=l,t.jf.Qr=0}},t.cf={_f:null,mf:null,Pf:null,Hf(){let e=t.cf._f=[];t.cf.mf=t.cf.Pf=null;for(let t of _)e.push(new RegExp(n.o(t),t!==t.toUpperCase()&&t.toLowerCase()===t?"i":""))},hf(){let e=t.cf.mf=[],r=t.cf.Pf=[];for(let l of t.cf._f){let t="\\b"+l.source,n=l.flags;e.push(new RegExp(t,n)),r.push(new RegExp(t+"\\b",n))}},Wf(e){t.cf._f&&(t.cf._f[0]=new RegExp(n.o(e),t.cf._f[0].flags))}},t.ff=(e,r)=>{for(let l of t.cf._f)if(!(l.test(e)||l.test(r)))return false;return true},t.if=(e,r)=>{let l=0,n=0,u=0,o=0,i=!!r;t.cf.mf||t.cf.hf();for(let t=0,a=_.length;t<a;t++){let a=M(t,e);o+=a[0],u+=a[1],i&&(a=M(t,r),n+=a[0],l+=a[1])}return o=o/g*x(u,e.length),0===l?r?o/2:o:(n=n/g*x(l,r.length),o<n?n:(o+n)/2)};let x=(e,t)=>e<t?e/t:t/e,M=(e,r)=>{let l=0,n=0;return l=r.split(t.cf._f[e]).length,l<1?f:(n=1,t.cf.mf[e].test(r)&&(n+=1,t.cf.Pf[e].test(r)&&(n+=1)),[n,(l-1)*_[e].length])};t.ComputeWordRelevancy=e=>t.if(e.t,e.title),t.ComputeRecency=e=>{let t=(e-w)/18144e5;return t<0?0:t<1?t*t*.666667:t<1.000165?.666446:0},t.ComputeRelevancy=(e,r,l)=>{let n=t.ComputeRecency(l),u=t.if(e,r);return n<=u?u:(u+n)/2},t.get2ndArg=(e,t)=>t,t.$f=e=>{if(c||e.v||(e.v=t.Df(e.u)),null!=e.textSplit)return void(e.t===e.u&&(e.t=""));e.title=t.cutTitle(e.title);let r,l=e.t,n=o.Hl(l);n.length!==l.length?r=T(l,"\\"===n[0]?5:8):(n=t.shortenUrl(l),r=k(n)),e.t=l.length!==e.u.length?n:"",e.textSplit=v(n,r,l.length-n.length,c?m-13-Math.min(e.title.length,40):m)},t.cutTitle=(e,r)=>{let l=e.length>m+40;return l&&(e=n.ut(e,0,m+39)),t.highlight(l?e+"\u2026":e,r||k(e))},t.highlight=(e,t)=>{if(h)return e;if(0===t.length)return n.it(e);let r="",l=0;for(let u=0;u<t.length;u+=2){let o=t[u],i=t[u+1];o>=e.length||(r+=n.it(e.slice(l,o)),r+="<match>",r+=n.it(e.slice(o,i)),r+="</match>",l=i)}return r+n.it(e.slice(l))},t.shortenUrl=e=>{let t=n.d(e);return!t||t>=e.length?e:e.slice(t,e.length-+(e.endsWith("/")&&!e.endsWith("://")))};let T=(e,t)=>{let r=k(e);for(let e=0;e<r.length;)r[e+1]<=t?r.splice(e,2):(r[e]=Math.max(r[e]-t,0),r[e+1]-=t,e+=2);return r},k=e=>{let r=[];for(let l=0,n=_.length;l<n;l++){let n,u=0,o=0,i=e.split(t.cf._f[l]),a=i.length-1,f=_[l].length;for(;u<a;u++,o=n)n=(o+=i[u].length)+f,r.push([o,n])}if(0===r.length)return r;if(1===r.length)return r[0];r.sort(t.sortBy0);let l=r[0];for(let e=1,t=1,n=r.length;t<n;t++){let n=r[t];l[e]>=n[0]?l[e]<n[1]&&(l[e]=n[1]):(l.push(n[0],n[1]),e+=2)}return l};t.sortBy0=(e,t)=>e[0]-t[0];let v=(e,t,r,l)=>{let u="",o=e.length,i=o,a="";if(o<=l||(r>1?i=e.indexOf("/")+1||o:(i=e.indexOf(":"))<0?i=o:n.gt.test(e.slice(0,i+3).toLowerCase())?i=e.indexOf("/",i+4)+1||o:i+=22),i<o&&t.length)for(let e=t.length,r=o+8;(e-=2)>-4&&r>=i;r=e<0?0:t[e]){let n=e<0?i:t[e+1],u=r-20-Math.max(n,i);if(u>0&&(o-=u,o<=l)){i=n+(l-o);break}}o=0;for(let r=0;o<l&&r<t.length;r+=2){let f=t[r],s=Math.max(o,i),_=f-20-s;_>0?(l+=_,a=n.ut(e,o,s+11),u+=h?a:n.it(a),u+="\u2026",a=n.mt(e,f-8,f),u+=h?a:n.it(a)):o<f&&(a=e.slice(o,f),u+=h?a:n.it(a)),o=t[r+1],a=e.slice(f,o),h?u+=a:(u+="<match>",u+=n.it(a),u+="</match>")}return a=e.length<=l?e.slice(o):n.ut(e,o,l-1>o?l-1:o+10),u+(h?a:n.it(a))+(e.length<=l?"":"\u2026")};t.Df=e=>{let t=a.hi.qi&&e.startsWith("http")?a.hi.Ci(e):-1,l=t<0?~t-1:t,n=l<0?[]:r.ue.We,u=e.indexOf(":")+3,o=0,i=0,f="",s="",_=0,c=0;for(;o<=l&&(u="/"===e[u]?u+1:e.indexOf("/",u+1)+(i?0:1))>0;i=u){for(f=e.slice(i,u),c=l;o<=c;)if(_=o+c>>>1,s=n[_].u.slice(i),s>f)c=_-1;else{if(s===f)return i?n[_].u:"";o=_+1}if(o<=l&&i&&(f=n[o].u,"/"===f[u]&&f.length<=++u))return f}return""},t.of=(e,n,u,o,i)=>{{t.tabsInNormal=s=2!==r.we;let a=(s?2:0)|(e?1:0);if(p!==a&&(d=null,p=a),i=i||d)u(o,i);else{let t=u.bind(null,o);e?(512&n?l.getCurTabs:l.ql)(t):l.$l.query({},t)}}},i.ar.Yr=()=>{d&&(1&p||!(2&p)!=(2===r.we))&&t.ji.co(null)},setTimeout(()=>{u.Dt("searchEngines",null)},80)});