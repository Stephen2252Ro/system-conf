"use strict";__filename="background/eval_urls.js",define(["require","exports","./store","./utils","./normalize_urls","./parse_urls","./ports","./exclusions","./i18n"],(e,s,l,t,a,r,u,n,c)=>{Object.defineProperty(s,"__esModule",{value:true}),n=__importStar(n);let i=0;l.p((s,n,c)=>{let p,d,g,b,m;if("paste"===s&&(s+=" ."),(n|=0)<0||!(s=s.trim())||(p=s.search(/[/ ]/))<=0||!/^[a-z][\da-z\-]*(?:\.[a-z][\da-z\-]*)*$/i.test(d=s.slice(0,p).toLowerCase())||/\.(?:css|html?|js)$/i.test(d))return null;if(!(s=s.slice(p+1).trim()))return null;if(1===n)switch(d){case"sum":case"mul":s=s.replace(/[\s+,\uff0b\uff0c]+/g,"sum"===d?" + ":" * "),d="e";break;case"avg":case"average":g=s.split(/[\s+,\uff0b\uff0c]+/g),s="("+g.join(" + ")+") / "+g.length,d="e"}if(1===n)switch(d){case"e":case"exec":case"eval":case"expr":case"calc":case"m":case"math":return new Promise((s,l)=>{e(["/lib/math_parser.js"],s,l)}).then(__importStar).then(f.bind(0,s));case"error":return[s,3]}else if(n>=2)switch(d){case"status":case"state":return n>=3&&o(s),[s,n>=3?4:6];case"url-copy":case"search-copy":case"search.copy":case"copy-url":if(m=a.yt(s,null,1),m instanceof Promise)return m.then(e=>{let s=e[0]||e[2]||"";return s=s instanceof Array?s.join(" "):s,s=l.R(s),[s,1]});m=5===a.kt&&m instanceof Array?m[0]:m,s=m instanceof Array?m.join(" "):m;case"cp":case"copy":case"clip":return[s=l.R(s),1]}switch(d){case"cd":case"up":if(g=(s+"  ").split(" "),!g[2]){if(n<1)return null;if(m=u.Vl(),"string"!=typeof m)return m.then(e=>{let t=e&&l.P("cd "+s+" "+(s.includes(" ")?e:". "+e),n,c);return t?"string"==typeof t?[t,6]:t:[e?"fail in parsing":"No current tab found",3]});g[2]=m}d=g[0];let e="/"===d[0];p=parseInt(d,10),p=isNaN(p)?"/"===d?1:e?d.replace(/(\.+)|./g,"$1").length+1:-d.replace(/\.(\.+)|./g,"$1").length||-1:p;let i=r.Gl({u:g[2],p,t:null,f:1,a:"."!==g[1]?g[1]:""});return i&&i.u||[i?i.e:"No upper path",3];case"parse":case"decode":d=s.split(" ",1)[0],d.search(/\/|%2f/i)<0?s=s.slice(d.length+1).trimLeft():d="~",g=[s=t.v(s)],s=a.yt(s),4!==a.kt&&(b=r.Gl({u:s}))?""===b.u?g=[d]:(g=b.u.split(" "),g.unshift(d)):g=g[0].split(t.ft);break;case"sed":case"substitute":case"sed-p":case"sed.p":case"sed2":let f=s.split(" ",1)[0];s=s.slice(f.length+1).trim();let o="sed2"===d?s.split(" ",1)[0]:"";return[s=(s=s.slice(o.length).trim())&&l.j(s,d.endsWith("p")?32768:0,o?{r:f,k:o}:/^[@#$-]?[a-z]+$|^\.$/.test(f)?{r:null,k:f}:{r:f,k:null}),5];case"u":case"url":case"search":g=t.v(s).split(t.ft);break;case"paste":if(n>0)return m=l.I(s),m instanceof Promise?m.then(e=>[e?e.trim().replace(t.ft," "):"",5]):[m?m.trim().replace(t.ft," "):"",5];default:return null}return c?[g,2]:(p=i++,p>12?null:12===p?a.zt(g,"",0):p>0?a.zt(g,"",n):(m=a.zt(g,"",n),i=0,m))});let f=(e,s)=>{a.qt.test(e)&&(e=e.slice(1,-1)),e=(e=(e=e.replace(/\uff0c/g," ")).replace(/deg\b/g,"\xb0").replace(/[\xb0']\s*\d+(\s*)(?=\)|$)/g,(e,s)=>(e=e.trim())+("'"===e[0]?"''":"'")+s).replace(/([\u2070-\u2079\xb2\xb3\xb9]+)|[\xb0\uff0b\u2212\xd7\xf7]|''?/g,(e,s)=>{let l,t="";if(!s)return"\xb0"===e?"/180*PI+":(l="\uff0b\u2212\xd7\xf7".indexOf(e))>=0?"+-*/"[l]:`/${"''"===e?3600:60}/180*PI+`;for(let s of e)t+=s<"\xba"?s>"\xb3"?1:s<"\xb3"?2:3:s.charCodeAt(0)-8304;return t&&"**"+t}).replace(/\*PI\+(?!\s*\d)/g,"*PI").replace(/([\d.])rad\b/g,"$1")).replace(/^=+|=+$/g,"").trim();let l=[].reduce.call(e,(e,s)=>e+("("===s?1:")"===s?-1:0),0);for(;l<0;l++)e="("+e;for(;l-- >0;)e+=")";if(e){for(;e&&"("===e[0]&&")"===e.slice(-1);)e=e.slice(1,-1).trim();e=e||"()"}let t="",r=s.MathParser||globalThis.MathParser||{};if(r.evaluate){try{t=r.evaluate("()"!==e?e:"0"),t="function"==typeof t?"":""+t}catch(e){}r.clean(),r.errormsg&&(r.errormsg="")}return[t,0,e]},o=e=>{let s=l.Ce;!parseInt(e,10)||(s=parseInt(e,10),e=e.slice(e.search(/[/ ]/)+1));let t=l.Pe.get(s||(s=l.Ce));if(!t)return;l.set_cPort(t.lr||t.er);let a=e.search(/[/ ]/),r=a>0?e.slice(a+1):"";e=e.toLowerCase(),a>0&&(e=e.slice(0,a)),e.includes("-")&&e.endsWith("able")&&(e+="d");let i=!!r&&/^silent/i.test(r);r=(i?r.slice(7):r).trim();let f,o=0,p=e=>{console.log(e),o||u.showHUD(e),o=1};if(r&&!r.startsWith("^ "))p('"vimium://status" only accepts a list of hooked keys'),r="";else if(r){let e=r.match(/<(?!<)(?:a-)?(?:c-)?(?:m-)?(?:s-)?(?:[a-z]\w+|[^\sA-Z])>|\S/g);r=e?e.join(" ").replace(/<(\S+)>/g,"$1"):""}let d=l.cPort.s,g=d.Ke,b=n.Xt?1===g?g:(f=n.Yt(d.Ot,d),f?1:null===f?0:2):0,m="enable"===e?0:"disable"===e?2:"toggle-disabled"===e?2!==g?2===b?null:2:2===b?0:null:"toggle-enabled"===e?0!==g?0===b?null:0:0===b?2:null:"toggle-next"===e?1===g?0:0===g?2===b?null:2:2===b?0:null:"toggle"===e||"next"===e?0!==g?0:2:("reset"!==e&&p(`Unknown status action: "${e}", so reset`),null),h=!!r&&"enable"===e,y=null===m?0:2===m?3:1,_={N:1,p:2===m||h?r:null,f:y},x=y?m:0;t.Zl=y?{Ke:x,Vt:_.p}:null;for(let e of t.Qt){let s=e.s;!y&&n.Xt&&(f=_.p=n.Yt(s.Ot,s),x=null===f?0:f?1:2,1!==x&&s.Ke===x)||(s.Ke=x,e.postMessage(_))}x=t.er.s.Ke,i||o||u.showHUD(c.or("newStat",c.or(0!==x||h?2===x?"fullDisabled":"halfDisabled":"fullEnabled"))),l.Ve&&x!==g&&l.L(s,x)}});