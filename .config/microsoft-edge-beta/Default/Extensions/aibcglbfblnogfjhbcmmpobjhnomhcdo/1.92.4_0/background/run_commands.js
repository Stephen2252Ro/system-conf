"use strict";__filename="background/run_commands.js",define(["require","exports","./store","./utils","./browser","./ports","./exclusions","./i18n","./key_mappings"],(e,l,t,n,r,i,u,o,s)=>{Object.defineProperty(l,"__esModule",{value:true}),l.waitAndRunKeyReq=l.runNextOnTabLoaded=l.runNextCmdBy=l.getRunNextCmdBy=l.runNextCmd=l.wrapFallbackOptions=l.parseFallbackOptions=l.hasFallbackOptions=l.runKeyInSeq=l.parseKeySeq=l.runKeyWithCond=l.executeExternalCmd=l.executeShortcut=l.portSendFgCmd=l.sendFgCmd=l.onConfirmResponse=l.ln=l.tn=l.executeCommand=l.overrideOption=l.overrideCmdOptions=l.copyCmdOptions=l.replaceCmdOptions=void 0,n=__importStar(n),u=__importStar(u);let f,a,p=Math.abs,d=0,c=1;l.replaceCmdOptions=e=>{t.set_cOptions(n.st(e))},l.copyCmdOptions=(e,l)=>{for(let t in l)("$"!==t[0]||"$then=$else=$retry=$f=".includes(t+"=")&&!t.includes("="))&&(t in e||(e[t]=l[t]));return e},l.overrideCmdOptions=(e,l,r)=>{let i=r||t.get_cOptions();n.pt(n.st(e),i),l||(e.$o=i),r||t.set_cOptions(e)},l.overrideOption=(e,n,r)=>{(r=r||t.get_cOptions())[e]=n;let i=r.$o;null!=i&&l.overrideOption(e,n,i)};let v=e=>{let l=f;if(f=null,l)if(a){let{wt:t,ht:r}=n.c();l(e,r),t.then(w)}else l(e,t.A);return e?void 0:r.Fl()},y=e=>{l.executeCommand(e,1,t.cKey,t.cPort,t.cRepeat)};l.executeCommand=(e,u,o,d,c,m)=>{if(_(0),f)return void(f=null);let $,b=s.oa(e),k=e.ga;if(b&&($=b.$count)&&(u=u*$||1),1===(u=c||(u>=1e4?9999:u<=-1e4?-9999:0|u||1)));else if(1===k)u=1;else if(k>0&&(u>k||u<-k)){if(null!=m)u=u<0?-1:1;else if(!(c||b&&true===b.confirmed))return t.set_cKey(o),t.set_cOptions(null),t.set_cPort(d),t.set_cRepeat(u),void l.ln(e.pa,Math.abs(u)).then(y.bind(null,e))}else u=u||1;if(null!=m){let r=0|m.r;if(r=Math.max(1,r>=0&&r<100?Math.min(r||6,20):p(r)),m.c&&m.c.i>=r&&(!b||"showTip"!==b.$else))return t.set_cPort(d),void i.showHUD(`Has ran sequential commands for ${r} times`);let u=j(m.c,1,m.u);if(b&&(35===e.Ta||l.hasFallbackOptions(b)||u.t&&e.wa)){let t={};b?l.overrideCmdOptions(t,false,b):n.st(t),t.$retry=-r,t.$f=u,u.t&&e.wa&&!b.$else&&(t.$else="showTip"),b=t}}if(!e.wa){let{Ta:n}=e,r=4620>>n&1||4===n&&!!b&&false===b.keepHover;return t.set_cPort(d),void(null==d||l.portSendFgCmd(d,n,r,b,u))}let{Ta:g}=e,h=t.se[g];if(a=e.fa,null===a&&(a=e.fa=null!=b&&l.hasFallbackOptions(b)),t.set_cKey(o),t.set_cOptions(b||(e.ma=n.ct())),t.set_cPort(d),t.set_cRepeat(u),u=t.te[g],null==d&&g<10&&g>0);else if(u<1)if(a){let{wt:e,ht:l}=n.c();h(l),e.then(w)}else h(t.A);else a=e.fa,f=h,(u<2||2===u&&p(t.cRepeat)<2?r.getCurTab:r.ql)(v)},l.tn=()=>c&&true!==t.get_cOptions().confirmed,l.ln=(e,r)=>{var i;if(!t.cPort)return f=null,t.set_cRepeat(t.cRepeat>0?1:-1),Promise.resolve(t.cRepeat>0);if(!t.Ie||!t.Ie[1])return o.getI18nJson("help_dialog").then(n=>(t.Ie?t.Ie[1]=n:t.X([null,n,null]),l.ln(e,r)));let u=o.or("cmdConfirm",[r,t.Ie[1][e]||`### ${e} ###`]),{wt:s,ht:a}=n.c(),p=t.cRepeat,v=t.get_cOptions(),y=t.cPort;return _(setTimeout(m,3e3,0)),f=e=>{t.set_cKey(0),t.set_cOptions(v),t.set_cPort(y),t.set_cRepeat(e?p>0?1:-1:p),c=0,a(e),setTimeout(()=>{c=1},0)},((null===(i=t.Pe.get(t.cPort.s.Xl))||void 0===i?void 0:i.lr)||t.cPort).postMessage({N:13,c:"",i:d,m:u}),s};let m=e=>{let l=f;f=null,e>1&&l&&l(e<3)},_=e=>{d&&clearTimeout(d),d=e};l.onConfirmResponse=(e,t)=>{let n=e.c,r=e.i;r>=-1&&d!==r||(_(0),e.r?m(e.r):l.executeCommand(s.ca.get(n),e.n,0,t,0))},l.sendFgCmd=(e,n,r)=>{l.portSendFgCmd(t.cPort,e,n,r,1)},l.portSendFgCmd=(e,l,t,n,r)=>{e.postMessage({N:10,H:t?i.ensureInnerCSS(e.s):null,c:l,n:r,a:n})},l.executeShortcut=(e,t)=>{if(_(0),t){let n=t.er;return _(setTimeout(l.executeShortcut,100,e,null)),n.postMessage({N:13,c:e,i:d,m:""}),void i.ensuredExitAllGrab(t)}let u=s.ca.get(e),o=u.pa,f=0,a=u;"goBack"===o||"goForward"===o?r.$l.goBack&&(f=20):"autoOpen"===o&&(f=11);let p=s.oa(u);if(f)a={Ta:f,wa:1,pa:o,ba:null,ma:p,fa:null,ga:u.ga};else{if(!u.wa)return;f=u.Ta}f>9||f<1?l.executeCommand(a,1,0,null,0):p&&p.$noWarn||((p||(u.ma=n.ct())).$noWarn=true,console.log("Error: Command",o,"must run on pages which have run Vimium C"))},l.executeExternalCmd=(e,r)=>{let u=e.command;u=u?u+"":"";let o,f=u?s.aa[u]:null;if(!f)return;let a=r.tab?i.indexFrame(r.tab.id,r.frameId||0)||(o=t.Pe.get(r.tab.id),o?o.er:null):null;if(!a&&!f[1])return;let p=e.options||null,d=e.key,c=s.na(u,p),v=e.count;c&&(v="-"!==v?parseInt(v,10)||1:-1,p&&"object"==typeof p?n.st(p):p=null,d|=0,l.executeCommand(c,v,d,a,0))};let $=(e,o)=>{var s;let f=e.host,a=e.iframe,p=e.fullscreen,d=e.element;if(void 0===f&&(f=e.host=null!=e.url?e.url:null,delete e.url),"string"==typeof f&&(f=e.host=u.ni(f)),null!=f){let e,n=o.url;if(null==n&&2===f.t&&((e=f.v.indexOf("/",f.v.indexOf("://")+3))===f.v.length-1||-1===e)){let e=(null===(s=t.Pe.get(t.cPort?t.cPort.s.Xl:t.Ce))||void 0===s?void 0:s.lr)||t.cPort;n=e?e.s.Ot:null}if(null==n&&(n=i.Vl(null,true))instanceof Promise)return n.then(e=>{var n;o.url=e||(t.cPort?((null===(n=t.Pe.get(t.cPort.s.Xl))||void 0===n?void 0:n.lr)||t.cPort).s.Ot:""),l.runKeyWithCond(o)}),0;if(!u.ri(f,n))return 1}if(null!=a){if(!t.cPort&&false!==a)return 1;if("string"==typeof a&&(a=e.iframe=u.ni(a)||true),"boolean"==typeof a){if(a!==!!(t.cPort&&t.cPort.s.Yl))return 1}else if(!u.ri(a,t.cPort.s.Ot))return 1}if(null==p);else{if(null==o.fullscreen)return r.getCurWnd(false,e=>(o.fullscreen=!!e&&e.state.includes("fullscreen"),l.runKeyWithCond(o),r.Fl())),0;if(!!p!==o.fullscreen)return 1}if(d&&"*"!==d){let l="string"==typeof d?[]:d;"string"==typeof d&&(e.element=d.split(",").some(e=>{let t=(e="*"===e[0]?e.slice(1):e).indexOf("#"),r=e.indexOf("."),i=e.length;return e&&l.push({tag:e.slice(0,t<0?r<0?i:r:r<0?t:Math.min(r,t)),id:t>=0?e.slice(t+1,r>t?r:i):"",classList:n.m(r>=0?e.slice(r+1,t>r?t:i):"")}),"*"===e||e.includes(" ")})?(l.length=0,"*"):l);let r=o.element;if(l.length){if(null==r)return t.cPort&&i.safePost(t.cPort,{N:14,n:performance.now(),c:o}),t.cPort?0:1;if(!l.some(e=>0===r?"body"===e.tag&&!e.id&&!e.classList:(!e.tag||r[0]===e.tag)&&(!e.id||r[1]===e.id)&&(!e.classList.length||r[2].length>0&&e.classList.every(e=>r[2].includes(e)))))return 1}}return 2},b=e=>{let t=e.expect;if(e.$normalized)return t;let n=e=>e?"string"==typeof e?e.trim().split(/[, ]+/):e instanceof Array?e:[]:[],r=[];return t&&(t instanceof Array?r=t.map(e=>e instanceof Array?{env:e[0],keys:n(e[1]),options:e[2]}:e&&"object"==typeof e?{env:e.env||e,keys:n(e.keys),options:e.options}:null):"object"==typeof t?r=Object.keys(t).map(e=>{let l=t[e],r=l&&"object"==typeof l&&!(l instanceof Array);return{env:e,keys:n(r?l.keys:l),options:r?l.options:null}}):"string"==typeof t&&/^[^{].*?[:=]/.test(t)&&(r=t.split(t.includes(";")?/[;\s]+/g:/[,\s]+/g).map(e=>e.split(/[:=]/)).map(e=>2!==e.length?null:{env:e[0],keys:n(e[1]),options:null}))),r=r.map(e=>e&&e.env&&"__proto__"!==e.env&&e.keys.length?e:null),l.overrideOption("expect",r,e),l.overrideOption("keys",n(e.keys),e),l.overrideOption("$normalized",true,e),r},k=e=>{let l=n.ct();for(let t in e)t.startsWith("o.")&&t.length>2&&!t.includes("$")&&(l[t.slice(2)]=e[t]);return l};l.runKeyWithCond=e=>{let n,r=p(t.cRepeat),u=t.Pe.get(t.cPort?t.cPort.s.Xl:t.Ce);t.cPort||t.set_cPort(u?u.er:null),e=e||{};let o=b(t.get_cOptions());for(let l of o){if(!l)continue;let t=l.env,r=t;if("string"==typeof r){if(!s.ua)return void i.showHUD("No environments have been declared");if(r=s.ua.get(r),!r)return void i.showHUD(`No environment named "${t}"`);"string"==typeof r&&(r=s.ra(r),s.ua.set(t,r))}let u=$(r,e);if(0===u)return;if(2===u){n=l;break}}let f,a=n?n.keys:t.get_cOptions().keys,d=n?"string"==typeof n.env?`[${n.env}]: `:`(${o.indexOf(n)})`:"";if(0===a.length)i.showHUD(d+"Require keys: comma-seperated-string | string[]");else if(r>a.length&&1!==a.length)i.showHUD(d+"Has no such a key");else if(f=a[1===a.length?0:r-1],("string"==typeof f||"object"==typeof f&&"number"==typeof f.t)&&f){let e=1===a.length?t.cRepeat:r!==t.cRepeat?-1:1,u=n&&n.options||t.get_cOptions().options||k(t.get_cOptions());if("string"!=typeof f||/[()?:+%]/.test(f)){if("string"==typeof f&&(f=a[1===a.length?0:r-1]=l.parseKeySeq(f)),3===f.t)return void i.showHUD(f.val);let n={$seq:{keys:f,repeat:e,options:u,cursor:f,timeout:0},$then:"<v-runkey:s>",$else:"-<v-runkey:s>",$retry:-999};l.replaceCmdOptions(n),t.pe.set("<v-runkey:s>",s.na("runKey",n)),l.runKeyInSeq(n.$seq,1,null)}else{let l=1,t=/^\d+|^-\d*/.exec(f);if(null!=t){let e=t[0];f=f.slice(e.length),l="-"!==e?parseInt(e,10)||1:-1}h(f,l*e,u)}}else i.showHUD(d+"The key is invalid")},l.parseKeySeq=e=>{let l,t=/^([$%][a-z]\+?)*([\d-]\d*\+?)?([$%][a-z]\+?)*(<([a-z]-){0,4}\w+(:i)?>|[A-Z_a-z]\w*)/,r={t:1,val:[],par:null},i=r;for(let n=0;n<e.length;n++)switch(e[n]){case"(":l=r,r={t:1,val:[],par:r},l.val.push(r);break;case")":l=r;do{l=l.par}while(2===l.t);r=l;break;case"?":case":":for(l="?"===e[n]?null:r;l&&2!==l.t;)l=l.par;l&&!l.val.f||(l=r.par,r.par={t:2,val:{cond:r,t:null,f:null},par:l||(i={t:1,val:[],par:null})},l?1===l.t?l.val.splice(l.val.indexOf(r),1,r.par):l.val.t===r?l.val.t=r.par:l.val.f=r.par:i.val.push(r.par),l=r.par),r={t:1,val:[],par:l},"?"===e[n]?l.val.t=r:l.val.f=r;break;case"+":break;default:for(;n<e.length&&!"()?:+".includes(e[n]);){let l=t.exec(e.slice(n));if(!l){let l=e.slice(n);return{t:3,val:"Invalid key item: "+(l.length>16?l.slice(0,15)+"\u2026":l),par:null}}r.val.push({t:0,val:l[0],par:r}),n+=l[0].length}n--}return n.bt(),i};let g=(e,l)=>{let t,n,r=true,i=e;for(0===i.t&&(t=i.par,n=t.val.indexOf(i),i=n<t.val.length-1&&l>0?t.val[n+1]:(r=false,t));i&&0!==i.t;)if(r&&1===i.t&&i.val.length>0)i=i.val[0];else if(r&&2===i.t)i=i.val.cond;else{if(!i.par){i=null;break}1===i.par.t?(t=i.par,n=t.val.indexOf(i),r=n<t.val.length-1,r&&l<0&&(l=1),i=r?t.val[n+1]:t):(t=i.par,r=i===t.val.cond,i=r&&(l>0?t.val.t:(l=1,t.val.f))||(r=false,t))}return i};l.runKeyInSeq=(e,l,n)=>{let r=g(e.cursor,l);if(r&&(g(r,1)||g(r,-1))||(t.pe.set("<v-runkey:s>",s.na("blank",null)),clearTimeout(e.timeout||0),r&&(delete t.get_cOptions().$then,delete t.get_cOptions().$else)),!r)return void(l<0&&n&&n.t&&i.showHUD(o.or(`${n.t}`)));let u=e.timeout=setTimeout(()=>{let e=t.pe.get("<v-runkey:s>"),l=e&&e.ma;l&&l.$seq&&l.$seq.timeout===u&&t.pe.set("<v-runkey:s>",s.na("blank",null))},3e4),f=r.val,a=/[$%]c/.test(f)||e.cursor===e.keys;f=f.replace(/[$%][a-z]\+?/gi,"");let p=1,d=/^\d+|^-\d*/.exec(f);if(null!=d){let e=d[0];f=f.slice(e.length+("+"===f[e.length]?1:0)),p="-"!==e?parseInt(e,10)||1:-1}f="__proto__"!==f?f:"<v-__proto__>",e.cursor=r,h(f,p*(a?e.repeat:1),e.options)};let h=(e,r,u)=>{let o=e,f="__proto__"!==e&&t.pe.get(e)||!e.includes("<")&&t.pe.get(o=`<v-${e}>`)||null,a=true;if(null==f&&e in s.aa&&(a=false,f=s.na(e,null)),null==f)return void i.showHUD(`the "${o}" has not been mapped`);if(35===f.Ta&&f.wa&&!u.$seq)return void i.showHUD('"runKey" can not be nested');n.bt();let p=l.parseFallbackOptions(t.get_cOptions()),d=t.get_cOptions().$f;if(u&&"object"==typeof u||p||d){let e=s.oa(f);f=a?Object.assign({},f):f;let t=n.ct();u&&l.copyCmdOptions(t,n.st(u)),p&&l.copyCmdOptions(t,n.st(p)),e&&l.copyCmdOptions(t,e),t.$f=d,u&&"$count"in u?t.$count=u.$count:e&&"$count"in e&&(u&&"count"in u||(t.$count=e.$count)),f.ma=t,2!==f.Ta||f.wa||(f.ga=0),s.ia(f)}l.executeCommand(f,r,t.cKey,t.cPort,0)};l.hasFallbackOptions=e=>!!(e.$then||e.$else),l.parseFallbackOptions=e=>{let l=e.$then,t=e.$else;return l||t?{$then:l,$else:t,$retry:e.$retry,$f:e.$f}:null},l.wrapFallbackOptions=e=>{let n=l.parseFallbackOptions(t.get_cOptions());return n&&Object.assign(e,n),e};let j=(e,l,t)=>({i:(e?e.i:0)+l,t:t&&2!==t?t:e?e.t:0});l.runNextCmd=e=>l.runNextCmdBy(e,t.get_cOptions()),l.getRunNextCmdBy=e=>l.hasFallbackOptions(t.get_cOptions())?n=>{let i=2&e?void 0===n:r.Fl(),u=t.get_cOptions();return i?l.runNextCmdBy(0,u):l.runNextOnTabLoaded(u,1&e?n:null),2&e?void 0:i}:2&e?t.A:r.Fl;let w=e=>{"object"==typeof e?l.runNextOnTabLoaded(t.get_cOptions(),e):"boolean"==typeof e?l.runNextCmdBy(e?1:0,t.get_cOptions(),null):e<0||l.runNextCmdBy(e?1:0,t.get_cOptions(),e>1?e:null)};l.runNextCmdBy=(e,r,u)=>{let o=e?r.$then:r.$else,f=!!o&&"string"==typeof o;if(f){let e={c:r.$f,r:r.$retry,u:0,w:0};_(setTimeout(()=>{let r=t.Pe.get(t.Ce),u=t.cPort&&t.cPort.s.Xl===t.Ce&&r&&r.Qt.indexOf(t.cPort)>0?t.cPort:r?2===r.er.s.Ke&&r.Qt.filter(e=>2!==e.s.Ke).sort((e,l)=>e.s.Yl-l.s.Yl)[0]||r.er:null;if(r&&i.ensuredExitAllGrab(r),/^[a-z]+(\.[a-z]+)?$/i.test(o)&&o in s.aa)l.executeCommand(s.na(o,null),1,0,u,0,e);else{let r=o,s=1,f=/^\d+|^-\d*/.exec(r);if(null!=f){let e=f[0];r=r.slice(e.length),s="-"!==e?parseInt(e,10)||1:-1}let a=t.pe.get(r);n.bt(),a?l.executeCommand(a,s,0,u,0,e):i.showHUD(`" ${r} " has not been mapped.`)}},u||50))}return f},l.runNextOnTabLoaded=(e,n,i)=>{let u=e.$then;if(!(u&&"string"==typeof u||i))return;let o=n=>{let o=Date.now(),c=o<p-500||o-p>=s;if(!n||!d)return a=-1,r.Fl();if(c||"complete"===n.status){if(i&&!c&&!t.Pe.has(n.id))return;_(0),f=null,i&&i(),u&&l.runNextCmdBy(1,e,i?67:0)}},s=false!==n?1500:500,a=n?n.id:false!==n?-1:t.Ce,p=Date.now();_(setInterval(()=>{r.tabsGet(-1!==a?a:t.Ce,o)},100))},l.waitAndRunKeyReq=(e,n)=>{let r=e.f,i={$then:e.k,$else:null,$retry:r.r,$f:j(r.c,0,r.u)};t.set_cPort(n),false===r.u?l.runNextOnTabLoaded(i,null):l.runNextCmdBy(1,i,r.w)}});