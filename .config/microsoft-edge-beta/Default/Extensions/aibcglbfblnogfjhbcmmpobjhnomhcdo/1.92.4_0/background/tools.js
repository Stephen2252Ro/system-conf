"use strict";__filename="background/tools.js",define(["require","exports","./store","./utils","./browser","./normalize_urls","./parse_urls","./settings","./ports","./ui_css","./i18n","./run_commands","./open_urls","./tab_commands"],function(e,t,r,l,n,o,i,a,u,s,c,f,_,d){Object.defineProperty(t,"__esModule",{value:true}),t.ar=t.cr=t.fr=t._r=t.dr=void 0,l=__importStar(l),a=__importStar(a),t.dr={mr:(e,t)=>"vimiumContent|"+e+(t?"|"+t:""),pr(e,t){let o=n.Al.contentSettings;try{o&&o.images.get({primaryUrl:"https://127.0.0.1/"},n.Fl)}catch(e){o=null}return o?o[e]&&!/^[A-Z]/.test(e)&&o[e].get?!(!t.startsWith("read:")&&l.gt.test(t)&&!t.startsWith(r.e.ll))&&(u.complainLimits(c.or("changeItsCS")),true):(u.showHUD(c.or("unknownCS",[e])),true):(u.showHUD("Has not permitted to set contentSettings"),true)},gr(e,t){if(e.startsWith("file:")){let t=1;return t?(u.complainLimits(1===t?c.or("setFileCS",[56]):c.or("setFolderCS")),[]):[e.split(/[?#]/,1)[0]]}if(e.startsWith("ftp:"))return u.complainLimits(c.or("setFTPCS")),[];let r,n=e.match(/^([^:]+:\/\/)([^\/]+)/),i=o.It.exec(n[2]),a=i[3]+(i[4]||"");if(r=[(e=n[1])+a+"/*"],t<2||l.at(i[3],0))return r;i=null;let[s,f]=l.nt(a),_=Math.min(s.length-f,t-1);for(let t=0;t<_;t++)a=a.slice(s[t].length+1),r.push(e+a+"/*");return r.push(e+"*."+a+"/*"),_===s.length-f&&"http://"===e&&r.push("https://*."+a+"/*"),r},vr(e){let t;for(let{s:{Ot:r}}of e.Qt){let e=new URL(r).host;if(t&&t!==e)return true;t=e}return false},hr(e,r){let l=n.Al.contentSettings[e];null==r?(l.clear({scope:"regular"}),l.clear({scope:"incognito_session_only"},n.Fl),localStorage.removeItem(t.dr.mr(e))):l.clear({scope:r?"incognito_session_only":"regular"})},br(e,l){let n=e.type?""+e.type:"images";return!t.dr.pr(n,"http://a.cc/")&&(t.dr.hr(n,l?l.s.tr:2===r.we),u.showHUD(c.or("csCleared",["images"===n&&c.or(n)||n[0].toUpperCase()+n.slice(1)])),true)},yr(e,r,l,n){let o=e.type?""+e.type:"images",i=l[0];e.incognito?t.dr.wr(r,o,i,n):t.dr.Sr(o,r,i,"reopen"===e.action,n)},Sr(e,l,i,a,u){let s=o.xt(i.url);t.dr.pr(e,s)?u(0):n.Al.contentSettings[e].get({primaryUrl:s,incognito:i.incognito},o=>{t.dr.Mr(e,s,l,{scope:i.incognito?"incognito_session_only":"regular",setting:o&&"allow"===o.setting?"block":"allow"},l=>{if(l)return void u(0);if(!i.incognito){let r=t.dr.mr(e);"1"!==localStorage.getItem(r)&&localStorage.setItem(r,"1")}let o,s=!n.Ol()||(o=r.Pe.get(i.id))&&o.Qt.length>1&&t.dr.vr(o);i.incognito||a?d.kr(i):i.index>0?d.kr(i,s?0:2):n.getCurWnd(true,e=>(e&&"normal"===e.type?d.kr(i,s?0:e.tabs.length>1?2:1):n.$l.reload(f.getRunNextCmdBy(0)),n.Fl()))})})},wr(e,l,i,a){if(r.e.sl)return u.complainLimits("setIncogCS"),void a(0);let s=o.xt(i.url);t.dr.pr(l,s)?a(0):n.Al.contentSettings[l].get({primaryUrl:s,incognito:true},r=>n.Fl()?(n.Al.contentSettings[l].get({primaryUrl:s},r=>{r&&"allow"===r.setting?a(1):n.Pl.create({type:"normal",incognito:true,focused:false,url:"about:blank"},r=>{let o=r.tabs[0].id;return t.dr.Cr(e,l,i,s,r.id,true,()=>{n.$l.remove(o)})})}),n.Fl()):r&&"allow"===r.setting&&i.incognito?t.dr.Ir(i):void n.Pl.getAll(n=>{if(!(n=n.filter(e=>e.incognito&&"normal"===e.type)).length)return void console.log("%cContentSettings.ensure","color:red","get incognito content settings",r," but can not find an incognito window.");let o=_.preferLastWnd(n);if(r&&"allow"===r.setting)return t.dr.Ir(i,o.id);let a=i.windowId,u=i.incognito&&n.some(e=>e.id===a);return t.dr.Cr(e,l,i,s,u?void 0:o.id)}))},Cr(e,r,l,o,i,a,u){let s=t.dr.jr.bind(null,l,i,u);return t.dr.Mr(r,o,e,{scope:"incognito_session_only",setting:"allow"},a&&i!==l.windowId?e=>{if(e)return s(e);n.Pl.get(l.windowId,s)}:s)},Mr(e,r,o,i,a){let u,s=false,c=n.Al.contentSettings[e],f=()=>{let e=n.Fl();return e&&console.log("[%o]",Date.now(),e),s||(--u,s=!!e,(s||0===u)&&setTimeout(a,0,s)),e},_=t.dr.gr(r,0|o);if(u=_.length,u<=0)return a(true);l.st(i);for(let e of _)c.set(Object.assign({primaryPattern:e},i),f)},jr(e,r,l,o){true!==o&&t.dr.Ir(e,r),l&&l(),true!==o?r&&n.Pl.update(r,{focused:true,state:o?o.state:void 0}):f.runNextCmd(0)},Ir(e,t){e.active=true,"number"==typeof t&&e.windowId!==t&&(e.index=void 0,e.windowId=t),d.kr(e)}},t._r={Tr:localStorage,Rt({l:e,n:l,u:n,s:o},i,a){if(e&&0===o[0]&&0===o[1])if(2===o.length){let e=n.indexOf("#");e>0&&e<n.length-1&&o.push(n.slice(e))}else(o[2]||"").length<2&&o.pop();let u=t._r.Nr(l,e?n:""),s=JSON.stringify(e?o:{tabId:a,url:n,scroll:o});i?(r.he||(m.Or(),r.Z(new Map))).set(u,s):t._r.Tr.setItem(u,s)},Ar(e,l){var n;let o=l.s.Xl;e.s?t._r.Rt(e,l.s.tr,o):(l=(null===(n=r.Pe.get(o))||void 0===n?void 0:n.lr)||l)&&l.postMessage({N:11,n:e.n})},Lr(e,o){let{n:i}=e,a=t._r.Nr(i,e.u),s=o.s.tr&&(null==r.he?void 0:r.he.get(a))||t._r.Tr.getItem(a),d=e.c;if(e.l){let t=s?JSON.parse(s):null;if(!t){let r,l,n=e.o;n&&(r=+n.x)>=0&&(l=+n.y)>=0&&(t=[r,l,n.h])}if(t)return void o.postMessage({N:15,l:2,n:i,s:t,f:d})}if(!s)return void u.showHUD(c.or("noMark",[c.or(e.l?"Local_":"Global_"),i]));let m=JSON.parse(s),p=+m.tabId,g={u:m.url,s:m.scroll,t:m.tabId,n:i,p:true,q:_.parseOpenPageUrlOptions(d),f:f.parseFallbackOptions(d)};g.p=false!==d.prefix&&0===g.s[1]&&0===g.s[0]&&!!l.d(g.u),p>=0&&r.Pe.has(p)?n.tabsGet(p,t._r.Ur.bind(0,g)):r.ie[20](g)},Ur(e,l){let o=n.getTabUrl(l).split("#",1)[0];if(o===e.u||e.p&&e.u.startsWith(o))return r.ie[5]({s:l.id}),t._r.Rr(e,l);r.ie[20](e)},Nr:(e,t)=>t?"vimiumMark|"+i.Rl(t.split("#",1)[0])+(t.length>1?"|"+e:""):"vimiumGlobalMark|"+e,Rr(e,l){var n;let o=l.id,i=null===(n=r.Pe.get(o))||void 0===n?void 0:n.lr;if(i&&i.postMessage({N:15,l:0,n:e.n,s:e.s,f:e.f}),e.t!==o&&e.n)return t._r.Rt(e,2===r.we,o)},$r(e){let l=t._r.Nr("",e),n=[],o=t._r.Tr;for(let e=0,t=o.length;e<t;e++){let t=o.key(e);t.startsWith(l)&&n.push(t)}for(let e of n)o.removeItem(e);let i=n.length,a=r.he;return a&&a.forEach((e,t)=>{t.startsWith(l)&&(i++,a.delete(t))}),u.showHUD(c.or("markRemoved",[i,c.or(e?"#"===e?"allLocal":"41":"39"),c.or(1!==i?"have":"has")]))}},t.fr={va:"findModeRawQueryList",qr:null,Wr:0,Fr(){let e=a.Nt(t.fr.va);t.fr.qr=e?e.split("\n"):[],t.fr.Fr=null},Jr(e,n,o){let i=t.fr;i.Fr&&i.Fr();let u=e?r.ge||(m.Or(),r.$(i.qr.slice(0))):i.qr;if(!n)return u[u.length-(o||1)]||"";if(n=n.replace(/\n/g," "),e)return void i.Pr(n,u,true);n=l.ut(n,0,99);let s=i.Pr(n,u);s&&a.Rt(i.va,s),r.ge&&i.Pr(n,r.ge,true)},Pr(e,t,r){let l=t.lastIndexOf(e);if(l>=0){if(l===t.length-1)return;t.splice(l,1)}else t.length>=50&&t.shift();if(t.push(e),!r)return t.join("\n")},xr(e){e?r.ge&&r.$([]):(t.fr.Fr=null,t.fr.qr=[],a.Rt(t.fr.va,""))}};let m={zr:false,Wr:0,Or(){m.zr||(n.Pl.onRemoved.addListener(m.Dr),m.zr=true)},Dr(){m.zr&&(m.Wr=m.Wr||setTimeout(m.Gr,34))},Gr(){m.Wr=0;for(let e of r.Pe.values())if(e.er.s.tr)return;n.Pl.getAll(e=>{e.some(e=>e.incognito)||m.Kr()})},Kr(){r.$(null),r.Z(null),n.Pl.onRemoved.removeListener(m.Dr),m.zr=false}};t.cr={Hr:[2,2],Qr:0,Nt(e){let r=t.cr.Hr[e];return"object"==typeof r?r.matches:null},Zr(e,r){let l=t.cr,n=l.Hr,o=n[e],i=e?"prefers-color-scheme":"prefers-reduced-motion";if(1===o&&r&&(n[e]=o=matchMedia(`(${i})`).matches?2:0),r&&2===o){let r=matchMedia(`(${i}: ${e?"dark":"reduce"})`);r.onchange=l.Br,n[e]=r,l.Qr=l.Qr||setInterval(t.cr.Er,6e4),l.Vr(e,0)}else r||"object"!=typeof o||(o.onchange=null,n[e]=2,l.Qr>0&&n.every(e=>"object"!=typeof e)&&(clearInterval(l.Qr),l.Qr=0),l.Vr(e,0))},Vr(e,l){let n=t.cr.Hr[e],o=e?"dark":"less-motion",i=!!("object"==typeof n)&&n.matches,u=e?"d":"m",c=a.Et(u,i);r.Ye[u]!==c&&(r.Ye[u]=c,l||a.Pt({N:6,d:[u]})),s.en({t:o,e:i||` ${r.Te.vomnibarOptions.styles} `.includes(` ${o} `),b:!l})},Er(){for(let e=t.cr.Hr,r=e.length;0<=--r;)"object"==typeof e[r]&&t.cr.Vr(r)},Br(){t.cr.Qr>0&&clearInterval(t.cr.Qr),t.cr.Qr=-1;let e=t.cr.Hr.indexOf(this);e>=0&&t.cr.Vr(e)}},t.ar={Xr:null,Yr:r.A},setTimeout(()=>{function e(e){if(e.windowId!==r.Se)return void n.Pl.get(e.windowId,l);let t=performance.now();if(t-s>666){let e=a.get(r.Ce),l=1===r.Ye.o?Date.now():t;e?(e.i=++u,e.t=l):a.set(r.Ce,{i:++u,t:l}),u>2037&&n.$l.query({},c)}r.ae(e.tabId),s=t}function l(e){if(!e.focused)return;let t=e.id;t!==r.Se&&(r.oe(r.Se),r.ne(t)),n.$l.query({windowId:t,active:true},e=>{e&&e.length>0&&t===r.Se&&o(e)})}function o(l){if(!l||0===l.length)return n.Fl();let o=l[0],i=o.windowId,a=r.Se;i!==a&&(r.ne(i),r.oe(a)),r.le(o.incognito?2:0),t.ar.Yr(),e({tabId:o.id,windowId:i})}let i=r.Se,a=r.Ee,u=1,s=0,c=e=>{let t=e?e.map(e=>[e.id,a.get(e.id)]).filter(e=>e[1]).sort(e=>e[1].i):[];t.length>1023&&t.splice(0,t.length-1023),t.forEach((e,t)=>e[1].i=t+2),u=t.length>0?t[t.length-1][1].i:1,u>1?r.ee(a=new Map(t)):(a.forEach((e,t)=>{e.i<1026?a.delete(t):e.i-=1024}),u=1024)};n.$l.onActivated.addListener(e),n.Pl.onFocusChanged.addListener(e=>{e!==i&&n.$l.query({windowId:e,active:true},o)}),n.getCurTab(e=>{s=performance.now();let t=e&&e[0];if(!t)return n.Fl();r.ae(t.id),r.ne(t.windowId),r.le(t.incognito?2:0)}),t.ar.Xr=(e,t)=>a.get(t.id).i-a.get(e.id).i;for(let e of["images","plugins","javascript","cookies"])null!=localStorage.getItem(t.dr.mr(e))&&n.Al.contentSettings&&setTimeout(t.dr.hr,100,e)},120),a.Ct.autoDarkMode=a.Ct.autoReduceMotion=(e,r)=>{t.cr.Zr(r.length>12?0:1,e)},a.Ct.vomnibarOptions=e=>{let l=a.Ft.vomnibarOptions,n=r.ye,o=true,{actions:i,maxMatches:u,queryInterval:s,styles:c,sizes:f}=l;if(e!==l&&e&&"object"==typeof e){let t=Math.max(3,Math.min(0|e.maxMatches||u,25)),r=((e.actions||"")+"").trim(),l=+e.queryInterval,n=((e.sizes||"")+"").trim(),a=((e.styles||"")+"").trim(),_=Math.max(0,Math.min(l>=0?l:s,1200));o=u===t&&s===_&&n===f&&i===r&&c===a,o||(u=t,s=_,f=n,c=a),e.actions=r,e.maxMatches=t,e.queryInterval=_,e.sizes=n,e.styles=a}r.Te.vomnibarOptions=o?l:e,n.n=u,n.t=s,n.l=f,n.s=c,t.cr.Vr(0,1),t.cr.Vr(1,1),a.Ht({N:47,d:{n:u,t:s,l:f,s:n.s}})}});