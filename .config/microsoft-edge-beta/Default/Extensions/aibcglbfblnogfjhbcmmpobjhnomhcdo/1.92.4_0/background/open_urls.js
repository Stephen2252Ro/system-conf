"use strict";__filename="background/open_urls.js",define(["require","exports","./store","./utils","./browser","./normalize_urls","./parse_urls","./ports","./exclusions","./i18n","./run_commands","./clipboard","./tools"],(e,l,t,n,r,i,u,o,f,s,d,a,v)=>{Object.defineProperty(l,"__esModule",{value:true}),l.dn=l.openUrlReq=l.openUrl=l.goToNextUrl=l.openUrlWithActions=l.openShowPage=l.openJSUrl=l.parseReuse=l.vn=l.parseOpenPageUrlOptions=l.preferLastWnd=l.newTabIndex=void 0,n=__importStar(n);let p={current:0,reuse:1,newwnd:2,newbg:-2,lastwndfg:-5,lastwnd:-5,lastwndbg:-6,iflastwnd:-7,lastwndbgbg:-8,lastwndbginactive:-8};l.newTabIndex=(e,l,t,n)=>"before"===l||"left"===l||"prev"===l||"previous"===l?e.index:"after"===l||"next"===l||"right"===l?e.index+1:"default"===l?void 0:false!==n&&null!=r.getGroupId(e)?"start"===l||"begin"===l?e.index:"end"===l?void 0:e.index+1:"start"===l||"begin"===l?0:"end"===l?t?3e4:void 0:e.index+1,l.preferLastWnd=e=>e.find(e=>e.id===t.be)||e[e.length-1],l.parseOpenPageUrlOptions=e=>({g:e.group,i:e.incognito,m:e.replace,o:e.opener,r:e.reuse,p:e.position,w:e.window});let c=e=>e===!!e?e:e?"force"===e||("reverse"===e?2!==t.we:"same"===e||"keep"===e?2===t.we:null):null,w=e=>"popup"===e||"normal"===e?e:void 0,m=(e,l,n)=>{let i=l=>!(e&&l.type!==e||null!=n&&l.incognito!==n||"minimized"===l.state);return(t.be<0?Promise.resolve(null):new Promise(e=>{r.Pl.get(t.be,l=>(e(l?i(l)?l:null:(t.oe(-1),null)),r.Fl()))})).then(e=>e||new Promise(e=>r.Pl.getAll(n=>{let r=n.filter(e=>i(e)&&e.id!==t.Se),u=r.length>0?r.sort((e,l)=>l.id-e.id)[0]:null;u&&t.be<0&&t.oe(u.id),e(u||!l?u:n.find(e=>e.id===t.Se)||n.find(e=>e.focused)||null)})))};l.vn=(e,l)=>{e=e.slice(0,128).split("?")[0].replace(/\\/g,"/");let n=2===t.Ye.o&&/\/globalroot\/device\/condrv|\bdevice\/condrv\/kernelconnect/.test(e);return n&&(t.set_cPort(l||t.cPort),o.showHUD(s.or("harmfulURL"))),n};let g=(e,t,r,u)=>{if(u instanceof Promise)u.then(g.bind(0,e,t,r));else switch(n.bt(),u[1]){case 1:o.showHUD(u[0],15),d.runNextCmdBy(1,t);break;case 5:case 6:d.replaceCmdOptions(t),6===u[1]||t.$p?e=0:(d.overrideCmdOptions({},true),d.overrideOption("$p",1)),l.openUrlWithActions(i.yt(u[0]),e,r);break;case 4:e>=3&&u[0]&&d.runNextCmdBy(1,t)}},b=(e,l,t)=>{e?d.runNextOnTabLoaded(l,t):d.runNextCmdBy(0,l)},y=(e,l,t,n)=>{let i=l=>(b(l,e,l),r.Fl());if(n){if(n.length>0&&n[0].incognito&&r.xl(l))return void r.tabsCreate({url:l},i)}else if(r.xl(l)&&true!==t)return void r.getCurTab(y.bind(null,e,l,true));n?r.tabsUpdate(n[0].id,{url:l},i):r.tabsUpdate({url:l},i)},h=(e,l,t,n,i,u)=>{r.makeWindow({url:e,focused:l,incognito:t,type:"string"==typeof e||1===e.length?w(n.window):void 0,left:i.left,top:i.top,width:i.width,height:i.height},null!=i.state?i.state:u&&"minimized"!==u.state?u.state:"",e=>{b(e,n,e&&e.tabs[0])})},I=(e,n,i,u,o)=>{let f=-2!==n,s=u?u.windowId:t.Se,d=o.find(e=>e.id===s),a=null!=d&&d.incognito;if(!i.window&&2!==n&&(a||(o=o.filter(e=>e.incognito&&"normal"===e.type)).length>0)){let n={url:e[0],active:f,windowId:a?s:l.preferLastWnd(o).id};if(a){let e=true===i.opener;n.index=l.newTabIndex(u,i.position,e,i.group),e&&(n.openerTabId=u.id)}r.openMultiTabs(n,t.cRepeat,true,e,a&&i.group,u,e=>{!a&&f&&r.selectWnd(e),b(e,i,e)})}else h(e,true,true,i,i,d)};l.parseReuse=e=>null==e?-1:"string"!=typeof e?isNaN(+e)?-1:0|e:(e=e.toLowerCase().replace("window","wnd").replace(/-/g,""))in p?p[e]:-1;let P=(e,l,i)=>{let u=l&&l.length>0?r.getTabUrl(l[0]):"",o=[i,t.get_cOptions().host_mask||t.get_cOptions().host_mark,t.get_cOptions().tabid_mask||t.get_cOptions().tabId_mask||t.get_cOptions().tabid_mark||t.get_cOptions().tabId_mark,t.get_cOptions().title_mask||t.get_cOptions().title_mark,t.get_cOptions().id_mask||t.get_cOptions().id_mark||t.get_cOptions().id_marker],f=[];for(let t=0;t<o.length;t++){let i=null!=o[t]?o[t]+"":"",s=i?e.indexOf(i):-1;if(s>=0){let e=s+i.length;for(let e of f);f.push([s,e,0===t?/[%$]s/.test(i)?n.g(u):u:1===t?new URL(u).host:2===t?u&&""+l[0].id:3===t?u&&""+n.g(l[0].title):r.Al.runtime.id])}}if(f.length){let l="",t=0;f.sort((e,l)=>e[0]-l[0]);for(let n of f)l=l+e.slice(t,n[0])+n[2],t=n[1];e=l+e.slice(t)}return e},$=(e,n,i,u)=>{let o,f=c(u.incognito);o=(n>-4?new Promise(e=>{r.getCurWnd(false,l=>(e(l||null),r.Fl()))}):m(w(u.window),true,f)).then(e=>e&&new Promise(l=>{r.$l.query({active:true,windowId:e.id},t=>(e.tabs=t,l(e),r.Fl()))})),o.then(o=>{let s=!!o&&!o.focused&&o.id!==t.Se,a=-7===n&&!s;if(!o||!(s||-7===n&&(null==f||o.incognito===!!f))){if(-7===n&&d.runNextCmdBy(0,u))return;return void h(e,n>-8,null!=f?!!f:i,u,u,o)}let v=o.tabs&&o.tabs.length>0?r.selectFrom(o.tabs):null;r.openMultiTabs({url:e[0],active:n>-6||a,windowId:o.id,pinned:!!u.pinned,index:v?l.newTabIndex(v,u.position,false,u.group):void 0},t.cRepeat,!!u.incognito&&"string"==typeof u.incognito,e,u.group,v,e=>{n>-6?s&&r.selectWnd(e):e&&n>-8&&!a&&r.selectTab(e.id),b(e,u,n>-6&&-2!==n&&e)})})},_=(e,n,i,u)=>{let o=u&&u[0],f=!!o&&o.incognito||2===t.we,s=-2!==n&&-8!==n,d=2===n||n<-3||!!i.window,a=c(i.incognito),v=null!=a&&"string"==typeof i.incognito;if(!v&&e.some(r.xl))d=f||d;else if(f)d=false===a||d;else if(a&&n>-4)return void r.Pl.getAll(I.bind(null,e,n,i,o));if(d)return void $(e,n,f,i);let p=i.opener&&o?o.id:void 0,w={url:e[0],active:s,windowId:o?o.windowId:void 0,openerTabId:p,pinned:!!i.pinned,index:o?l.newTabIndex(o,i.position,null!=p,i.group):void 0};r.openMultiTabs(w,t.cRepeat,v,e,i.group,o,e=>{s&&e&&r.selectWndIfNeed(e),b(e,i,s&&e)})},T=(e,n,i,u,o,s)=>{let a,v=i?"string"==typeof i?f.ni(i):"object"==typeof i&&i.t&&i.v?i:null:null,p=2===n||1===n,g=1===n&&o.q||{},y=w(1===n?g.w:u.window),h=c(1!==n?u.incognito:g.i),I=true===(1!==n?u.group:g.g);t.set_cRepeat(1),1===n?(g.m=null,g.g=I):(d.overrideOption("group",I,u),null!=u.replace&&d.overrideOption("replace",v,u)),a=n<-3&&v?m(y,-7===n,h):Promise.resolve(!p&&t.Se>=0?{id:t.Se}:null),Promise.all([a,!I||s?null:new Promise(e=>{r.getCurTab(l=>{s=l||[],e()})})]).then(([e,l])=>v&&(e||p)?new Promise(l=>{r.$l.query(e?{windowId:e.id}:{windowType:y||void 0},e=>{let i=null!=h?!h:n>-4?2!==t.we:-2,u=(e||[]).filter(e=>f.ri(v,e.url)&&e.incognito!==i);if(I&&u.length>0&&s.length>0){let l=r.getGroupId(s[0]);e&&(u=u.filter(e=>r.getGroupId(e)===l))}if(u.sort((e,l)=>{let n=t.Ee.get(l.id),r=t.Ee.get(e.id);return r?n?n.i-r.i:1:n?-1:l.id-e.id}),1===n){let e=u.filter(e=>e.windowId===t.Se);u=e.length>0?e:u}return l(u.length?u[0]:null),r.Fl()})}):null).then(i=>{if(null==i||i.id===t.Ce&&1!==n)1===n?l.dn(o):d.runNextCmdBy(0,u)||(s?_([e],n,u,s):r.getCurTab(_.bind(null,[e],n,u)));else{let l=-2!==n&&-8!==n,f=i.windowId!==t.Se&&n>-6;r.tabsUpdate(i.id,{url:e},e=>(e&&(l&&(r.selectTab(e.id),e.active=true),f&&r.selectWnd(e)),b(e,1===n?o.f||{}:u,-2!==n&&n>-6&&e),r.Fl()))}})};l.openJSUrl=(e,l,i)=>{if(!/^(void|\(void\))? ?(0|\(0\))?;?$/.test(e.slice(11).trim())){if(!i&&t.cPort){if(o.safePost(t.cPort,{N:5,u:e,f:d.parseFallbackOptions(l)}))return;t.set_cPort(null)}(()=>{let t=n.tt(e.slice(11));r.kl(r.$l.executeScript,{code:t}).then(e=>{void 0===e&&i&&i(),b(void 0!==e,l,null)}),r.Fl()})()}},l.openShowPage=(e,n,i,u)=>{let o=t.e.Sl;if(e.length<o.length+3||!e.startsWith(o))return false;if(!u)return r.getCurTab(t=>{if(!t||t.length<=0)return r.Fl();l.openShowPage(e,n,i,t[0])}),true;e=e.slice(o.length);let{incognito:f}=u;e.startsWith("#!image ")&&f&&(e="#!image incognito=1&"+e.slice(8).trim());let s=[e,null,0];if(t.r(s[1]=()=>(clearTimeout(s[2]),t.r(null),s[0])),s[2]=setTimeout(()=>{s[0]="#!url vimium://error (vimium://show: sorry, the info has expired.)",s[2]=setTimeout(()=>{t.E===s[1]&&t.r(null),s[0]="",s[1]=null},2e3)},1200),t.set_cRepeat(1),0!==n||f)f&&[0,-2,-1].indexOf(n)>=0?r.tabsCreate({url:o,active:-2!==n},e=>{b(e,i,e)}):(i.incognito=false,_([o],n,i,[u]));else{let e=u.url.split("#",2)[1]?[]:r.Al.extension.getViews({tabId:u.id});e.length>0&&e[0].location.href.startsWith(o)&&e[0].onhashchange?e[0].onhashchange():r.tabsUpdate(u.id,{url:o}),d.runNextOnTabLoaded(i,null)}return true};let x=e=>{let n=t.get_cOptions(),u=n.urls;if(2!==n.$fmt){if(1!==n.$fmt)for(let e=0;e<u.length;e++)u[e]=i.yt(u[e]+"");d.overrideOption("$fmt",2)}for(let e of u)if(l.vn(e))return r.Fl();let o=l.parseReuse(n.reuse),f=1===o||0===o?-1:o;t.set_cOptions(null),_(u,f,n,e)};l.openUrlWithActions=(e,u,o)=>{var f;if("string"!=typeof e);else if(e||9!==u){let r=t.get_cOptions().url_mask,s=t.get_cOptions().url_mark;if(null==r&&null==s||(e=P(e,o,null!=r?r:s)),9!==u){let l=(t.get_cOptions().keyword||"")+"";e=(null!==(f=t.get_cOptions().testUrl)&&void 0!==f?f:!l)?i.yt(e,l,u):i.zt(e.trim().split(n.ft),l||"~")}let d=t.get_cOptions().goNext;d&&e&&"string"==typeof e&&(e=t.j(e,8192),e=l.goToNextUrl(e,t.cRepeat,d)[1]),e="string"==typeof e?i.$t(e):e}else e=t.Te.newTabUrl_f;let s=t.get_cOptions(),a=l.parseReuse(s.reuse);t.set_cOptions(null),n.bt(),"string"!=typeof e?g(u,s,o,e):l.openShowPage(e,a,s)||(n.lt(e)?l.openJSUrl(e,s):l.vn(e)?d.runNextCmdBy(0,s):1===a?T(e,a,s.replace,null,{u:e,p:s.prefix,q:l.parseOpenPageUrlOptions(s),f:d.parseFallbackOptions(s)},o):0===a?y(s,e):s.replace?T(e,a,s.replace,s,null,o):o?_([e],a,s,o):r.getCurTab(_.bind(null,[e],a,s)))};let k=(e,f)=>{if(null===f)return o.complainLimits("read clipboard"),void d.runNextCmd(0);if(!(f=f.trim()))return o.showHUD(s.or("noCopied")),void d.runNextCmd(0);let a,v=t.get_cOptions().copied,p="string"==typeof v&&v.includes("any");if(("urls"===v||p)&&(a=f.split(/[\r\n]+/g)).length>1){let l=[],u=p&&t.get_cOptions().keyword?t.get_cOptions().keyword+"":null,f=false;for(let e of a)if(e=e.trim(),e){if(e=i.yt(e,u,0),!(p||i.kt<2)){l.length=0,f=true;break}l.push(e)}if(l.length>1)return t.set_cOptions(d.copyCmdOptions(n.ct(),t.get_cOptions())),t.get_cOptions().urls=l,t.get_cOptions().$fmt=1,void(e&&e.length>0?x(e):r.getCurTab(x));if(f)return void(d.runNextCmd(0)||o.showHUD("The copied lines are not URLs"))}if(i.qt.test(f))f=f.slice(1,-1);else{let e=t.get_cOptions().testUrl;(null!=e?e:!t.get_cOptions().keyword)&&(f=u.Bl(f,e))}let c=f.indexOf("://")+3;if(c>3&&n.gt.test(f)){let e,l=(f=/^ttps?:/i.test(f)?"h"+f:f).indexOf("/",c)+1||f.length,t=f.slice(c,l),n=t.startsWith("0.0.0.0")?7:t.includes(":::")&&(e=/^(\[?::\]?):\d{2,5}$/.exec(t))?e[1].length:0;f=n?f.slice(0,c)+(n>6?"127.0.0.1":"[::1]")+f.slice(c+n):f}l.openUrlWithActions(f,2,e)};l.goToNextUrl=(e,l,t)=>{let n=false;return e=e.replace(/\$(?:\{(\d+)[,\/#@](\d*):(\d*)(:-?\d*)?\}|\$)/g,(e,r,i,u,o)=>{if("$$"===e)return"$";n=true;let f=r&&parseInt(r)||1,s=i&&parseInt(i)||0,d=u&&parseInt(u)||0,a=o&&parseInt(o.slice(1))||1;return a<0&&([s,d]=[d,s]),l*=a,f="absolute"!==t?f+l:l>0?s+l-1:l<0?d+l:f,""+Math.max(s||1,Math.min(f,d?d-1:f))}),[n,e]},l.openUrl=e=>{if(t.get_cOptions().urls)return void(t.get_cOptions().urls instanceof Array&&(e&&e.length>0?x(e):r.getCurTab(x)));if((null!=t.get_cOptions().url_mask||null!=t.get_cOptions().url_mark)&&!e)return r.Fl()||void r.getCurTab(l.openUrl);let n=t.get_cOptions().url;if(n){let r=a.rn(t.get_cOptions());n=r?t.j(n+"",0,r):n+"",l.openUrlWithActions(n,3,e)}else if(t.get_cOptions().copied){let l=t.I(a.rn(t.get_cOptions()));l instanceof Promise?l.then(k.bind(null,e)):k(e,l)}else{let n=t.get_cOptions().url_f;l.openUrlWithActions(n||"",9,e)}},l.openUrlReq=(e,r)=>{var f;n.st(e);let s=null!=r&&o.isNotVomnibarPage(r,true);t.set_cPort(s?r:o.findCPort(r)||t.cPort);let a=e.u,v=e.n&&d.parseFallbackOptions(e.n)||{},p=e.o||n.ct(),w=(p.k||"")+"",m=null!==(f=p.t)&&void 0!==f?f:!w,g=p.s;if(v.group=!s||p.g,v.incognito=null!=c(p.i)?p.i:e.i,v.replace=p.m,v.position=p.p,v.reuse=null!=p.r?p.r:e.r,v.window=p.w,a){if(":"===a[0]&&!s&&/^:[bhtwWBHdso]\s/.test(a)&&(a=a.slice(2).trim()),a=t.j(a,e.f?0:s?524288:16384,g),e.f)a=a!==e.u?i.yt(a):a;else if(m||!s){a=m?u.Bl(a,m):a,a=i.yt(a,w,s?-1:3);let l=i.kt;null==e.h||2!==l&&1!==l?s&&3===l&&a.startsWith("vimium:")&&(a=i.yt(a)):a=(e.h?"https":"http")+a.slice("s"===a[4]?5:4)}else a=i.zt(a.trim().split(n.ft),w||"~");v.opener=s?false!==p.o:t.Te.vomnibarOptions.actions.includes("opener"),v.url_f=a}else{if(false===e.c)return;v.copied=null==e.c||e.c,v.keyword=w,v.testUrl=p.t,v.sed=g}t.set_cRepeat(1),d.replaceCmdOptions(v),l.openUrl()},l.dn=(e,n)=>{let u,o=n=>{var i;let o=null!==(i=c(p.i))&&void 0!==i?i:2===t.we&&null;if(null!==o&&n&&(n=n.filter(e=>e.incognito===o)),p.g&&u.length>0){let e=r.getGroupId(u[0]);n&&(n=n.filter(l=>r.getGroupId(l)===e))}if(!(n&&n.length>0))return e.f&&d.runNextCmdBy(0,e.f)||(u.length<=0||p.w||2===t.we&&!u[0].incognito?r.makeWindow({url:e.u,type:w(p.w),incognito:2===t.we&&!r.xl(e.u)},"",e=>{s(e&&e.tabs&&e.tabs.length>0?e.tabs[0]:null)}):r.openMultiTabs({url:e.u,index:l.newTabIndex(u[0],p.p,false,true),openerTabId:p.o&&u[0]?u[0].id:void 0,windowId:u[0].windowId,active:true},1,null,[null],p.g,u[0],s)),r.Fl();{let e=n.filter(e=>e.windowId===t.Se);f(e.length>0?e:n)}},f=l=>{let n=e.u;e.p&&l.sort((e,l)=>e.url.length-l.url.length);let i=r.selectFrom(l);if(i.url.length>l[0].url.length&&(i=l[0]),!n.startsWith(t.e.ul)||t.Pe.get(i.id)||e.s){let e=t.He?i.url.replace(/^edge:/,"chrome:"):i.url,l=t.He?n.replace(/^edge:/,"chrome:"):n;r.tabsUpdate(i.id,{url:e.startsWith(l)?void 0:n,active:true},s),r.selectWndIfNeed(i)}else r.tabsCreate({url:n},s),r.$l.remove(i.id)},s=l=>{if(!l)return e.f&&d.runNextCmdBy(0,e.f),r.Fl();d.runNextOnTabLoaded(e.f||{},l,e.s&&(()=>{v._r.Rr(e,l)}))},a=i.$t(e.u.split("#",1)[0]);if(l.vn(a,n))return;let p=e.q||(e.q={});(null==p.g||a.startsWith(t.e.ul))&&(p.g=false),p.m?T(e.u,null!=p.r&&l.parseReuse(p.r)||1,p.m,null,e):r.getCurTab(l=>{u=l;let t,n=w(p.w)||"normal";return!a.startsWith("file:")&&!a.startsWith("ftp:")||a.includes(".",a.lastIndexOf("/")+1)||(t=a+(e.p?"/*":"/")),e.p&&(a+="*"),r.$l.query({url:t||a,windowType:n},e=>(e&&e.length>0||!t?o(e):r.$l.query({url:a,windowType:n},o),r.Fl())),r.Fl()})}});