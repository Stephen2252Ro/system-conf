"use strict";__filename="background/key_mappings.js",define(["require","exports","./store","./utils","./settings","./exclusions"],(e,t,a,o,n,i)=>{let r,l,s;Object.defineProperty(t,"__esModule",{value:true}),t.ea=t.ta=t.aa=t.oa=t.na=t.ia=t.ra=t.la=t.sa=t.ca=t.ua=t.da=void 0,o=__importStar(o),n=__importStar(n),i=__importStar(i),t.da=/<(?!<)(?:.-){0,4}.\w*?(?::i)?>|./g,t.ca=l,t.ua=s;let c=true,u=null;t.sa=u,t.la=e=>e.length>1?"<escape>"===e?"esc":e.slice(1,-1):e;let d=(e,a)=>e.length<=a?null:e.includes(" $",a)||e.includes(" =",a)?t.ra(e.slice(a+1),e.includes(" $if={",a)?0:1):e.slice(a+1);t.ra=(e,t)=>{let a=o.ct(),n=0;for(let o of e.split(" ")){let e=o.indexOf("=");if("$#/=_".includes(o[0])){if(0===e||"__proto__"===o||"$"===o[0]&&!"$if=$key=$desc=$count=$then=$else=$retry=".includes(o.slice(0,e+1))){null!=t&&w("%s option key:",0===e?"Missing":"Unsupported",o);continue}if("#"===o[0]||o.startsWith("//"))break}if(e<0)a[o]=true,n=1;else{let i=o.slice(e+1);o=o.slice(0,e),a[o]=1===t?1:i&&m(i),n=1}}return 1===n?1===t?e:a:null};let m=e=>{try{return JSON.parse(e)}catch(e){}return e};t.ia=(e,a)=>{let i,r=e.ma;if(void 0===a&&(a=t.aa[e.pa]),i=a.length<4?null:o.st(a[3]),"string"==typeof r&&(r=t.ra(r)),r){if(("$count"in r||"count"in r)&&(1===a[2]?delete r.$count:r.$count=null!=r.$count?parseFloat(r.$count)||1:(parseFloat(r.count||1)||1)*(i&&i.$count||1),delete r.count),(r.$desc||r.$key)&&(e.ba={va:r.$key||"",ka:r.$desc||""},delete r.$key,delete r.$desc),r.$if){if(false===b(r))return false;delete r.$if}if(i&&o.pt(r,i),2===a[0]&&!a[1]){let t=r,a=t.mode,o=t.m,i=t.characters,l=t.action,s=i&&n.Et("c",i);s?t.c=s:"c"in t&&delete t.c,null!=i&&delete t.characters,"action"in t&&delete t.action,"mode"in t&&delete t.mode,a=l?h[l]:a&&"number"!=typeof a?h[a]:null,a=null!=a?a:Math.max(0,0|o),a>33&&(a=65===a?t.url?64:a:38===a?t.url?null!=t.join?57:40:null!=t.join?55:a:a>79?a-16:a),a!==o&&(t.m=a),a>63&&(e.ga=1)}}else r=i;return e.ma=r,true},t.na=(e,a,n)=>{void 0===n&&(n=t.aa[e]);let i={Ta:n[0],wa:n[1],pa:e,ba:null,ma:a||(n.length<4?null:o.st(n[3])),fa:null,ga:n[2]};return a&&"object"==typeof a&&!t.ia(i,n)?null:i},t.oa=e=>{let a=e.ma;return"string"==typeof a&&(t.ia(e),a=e.ma),a};let p=(e,t)=>{let a;return e.length>t&&(a=e.indexOf(" $if={",t))>0&&!/ (#|\/\/)/.test(e.slice(t,a+2))},b=e=>{let t=e&&"object"==typeof e&&e.$if;return t&&"object"==typeof t?!(!(t.sys&&t.sys!==a.e.cl||!!t.before&&t.before.replace("v","")<=a.e.rl)&&(!t.browser||1&t.browser)):null},v=e=>{let n,i,m,v,g,T,h,y=0,L=0,_=new Map,H=new Map,M=null,x=false,U=o.ct(),$="color:red";for(r=null,n=e.replace(/\\\\?\n/g,e=>3===e.length?"\\\n":"").replace(/[\t ]+/g," ").split("\n");L<n.length&&(!n[L]||"#"===(i=n[L])[0]);L++)i&&"!"===i[1]&&(i=i.slice(2).trim(),"no-check"===i&&(x=true));if(c=!x,L>=n.length||"unmapAll"!==n[L]&&"unmapall"!==n[L]){r=new Set;let e=f.split(" ");for(m=e.length;0<m;)m-=2,r.add(e[m]),_.set(e[m],t.na(e[m+1],null))}else L++;for(m=n.length;L<m;L++){let e=n[L].trim();if(e<"$")continue;let l=e.split(" ",3),s=l[0],c=l.length>1?l[1]:"",m=l.length>2?l[2]:"",f=s.length+c.length+m.length+2,I=x;switch(s){case"map":x?v=t.aa[m]:!c||c.length>8&&("__proto__"===c||c.includes("<__proto__>"))?w('Unsupported key sequence %c"%s"',$,c||'""',`for "${m||""}"`):!_.has(c)||r&&r.has(c)||p(e,f)?m?(v=t.aa[m])?(g=c.charCodeAt(0))>47&&g<58||45===g?w('Invalid key: %c"%s"',$,c,"(the first char can not be '-' or number)"):I=true:w('Command %c"%s"',$,m,"doesn't exist!"):w('Lacking command when mapping %c"%s"',$,c):w('Key %c"%s"',$,c,"has been mapped to",_.get(c).pa),I&&(T=t.na(m,d(e,f),v),T&&(_.set(c,T),r&&r.delete(c)));break;case"unmapAll":case"unmapall":_=new Map,H=new Map,M=null,r=null,U=o.ct(),y=0,u&&w("All key mappings is unmapped, but there %s been %c%d error%s%c before this instruction",u.length>1?"have":"has",$,u.length,u.length>1?"s":"","color:auto");break;case"mapKey":case"mapkey":x?i=t.la(c):!m||e.length>f&&!/^(#|\/\/|\$if=\{)/.test(e.slice(f).trimLeft())?w("mapKey: need %s source and target keys:",m?"only":"both",e):c.length>1&&!/^<(?!<[^:]|__proto__>)([acms]-){0,4}.\w*(:[a-z])?>$/.test(c)?w("mapKey: a source key should be a single key with an optional mode id:",e):m.length>1&&!/^<(?!<|__proto__>)([a-z]-){0,4}.\w*>$/.test(m)?w("mapKey: a target key should be a single key:",e):(i=t.la(c),i in U&&U[i]!==t.la(m)&&!p(e,f)?w('The key %c"%s"',$,c,"has been mapped to another key:",U[i].length>1?`<${U[i]}>`:U[i]):I=true),I&&false!==b(d(e,f))&&(U[i]=t.la(m),y++);break;case"shortcut":case"command":x||(m?!(c.startsWith("userCustomized")&&c.length>14)&&a.e.bl.indexOf(c)<0?w('Shortcut %c"%s"',$,c,"is not a valid name"):H.has(c)&&!p(e,f-1-m.length)?w('Shortcut %c"%s"',$,c,"has been configured"):I=true:w("Lacking command name and options in shortcut:",e)),I&&(h=d(e,f-1-m.length),false!==b(h)&&(i=k(H,c,h),i&&w('Shortcut %c"%s"',$,c,i)));break;case"env":x||(m?"__proto__"===c?w('Unsupported env name %c"%s"',$,c):M&&M.has(c)&&!p(e,f-1-m.length)?w('The environment name %c"%s"',$,c,"has been used"):I=true:w("Lacking conditions in env declaration:",e)),I&&(h=d(e,f-1-m.length),false!==b(h)&&(M||(M=new Map)).set(c,h));break;case"unmap":case"unmap!":!c||m&&"#"!==m[0]?w(`unmap: ${m?"only ":""}needs one mapped key:`,e):_.has(c)?(r&&r.delete(c),_.delete(c)):"unmap!"!==s&&w('Unmapping: %c"%s"',$,c,"has not been mapped");break;default:w('Unknown mapping command: %c"%s"',$,s,"in",e)}}for(let e of a.e.bl)e.startsWith("user")||H.has(e)||(T=t.na(e,null))&&H.set(e,T);a.z(_),t.ca=l=H,t.ua=s=M,a.Q(a.ye.k=y>0?U:null)},k=(e,a,o)=>{let n,i=1,r=(o=o&&"string"==typeof o?t.ra(o):o)&&o.command||(i=0,a.startsWith("user")?"":a),l=r?1:0;return l&&r in t.aa&&(i&&delete o.command,(n=t.na(r,o))&&e.set(a,n),l=2),l<1?'requires a "command" option':l>1?"":"gets an unknown command"},g=e=>{let t=0;for(let a in e){let o=a.length;if(o<2){let o=e[a];t|=o.length>1?20:a.toUpperCase()!==a&&o.toUpperCase()!==o?8:4}else t|=o>2&&":"===a[o-2]?"i"===a[o-1]?1:"n"===a[o-1]?32:2:e[a].length>1?20:4}return t},T=e=>{let n=o.ct(),l=null!==e,s=t.la,d='Inactive key: %o with "%s"',m=null!==u;l&&(a.W(t.sa=u=null),v(e));let p=o.dt(a.pe),b=a._e,k=l&&c,T=r?p.filter(e=>!r.has(e)):p,f=T.length,h=r?T.concat(o.dt(r)):p;if(l){let e=p.join().includes(":i>")?64:0;a.K(b?g(b)|e:e)}for(let e=10;0<=--e;)n[e]=1;n["-"]=1;for(let e=0;e<h.length;e++){let t=h[e],i=t.match(/<(?!<)(?:.-){0,4}.\w*?(?::i)?>|./g),r=i.length-1;if(0===r){let o=s(t);if(o in n){if(e>=f){a.pe.delete(t);continue}k&&w(d,n[o],t)}n[o]=0;continue}let l,c=n,u=0;for(;(l=c[s(i[u])])&&u<r;)u++,c=l;if(null!=l&&(e>=f||0===l))e>=f?a.pe.delete(t):k&&w(d,t,i.slice(0,u+1).join(""));else{for(null!=l&&k&&w(d,l,t);u<r;)c=c[s(i[u++])]=o.ct();c[s(i[r])]=0}}l&&(u?u.length>1?(console.group(u.length+" Errors in custom Key mappings:"),u.map(e=>console.log(...e)),console.groupEnd()):console.log.apply(console,u[0]):m&&console.log("The new key mappings have no errors")),a.W(n),r=null;let L=i.li(),_=e=>{for(let t in e){let a=e[t];0!==a?_(a):(true===L||0!==n[t]||L&&t in L)&&!t.startsWith("v-")||delete e[t]}};for(let e in n){let t=n[e];0===t?e.startsWith("v-")&&delete n[e]:1!==t&&_(t)}e&&y(e)},w=function(){(u||(t.sa=u=[])).push([].slice.call(arguments,0))},f="? showHelp <a-c> previousTab <a-s-c> nextTab d scrollPageDown <c-e> scrollDown f LinkHints.activate <f1> simBackspace <s-f1> switchFocus <f2> switchFocus <f8> enterVisualMode G scrollToBottom gf nextFrame gg scrollToTop gi focusInput gn toggleVomnibarStyle gs toggleViewSource gt nextTab gu goUp gF mainFrame gT previousTab gU goToRoot g0 firstTab g$ lastTab h scrollLeft H goBack i enterInsertMode j scrollDown J previousTab K nextTab k scrollUp l scrollRight L goForward <a-m> toggleMuteTab N performBackwardsFind n performFind <a-n> performAnotherFind o Vomnibar.activate <a-p> togglePinTab r reload R reloadGivenTab <a-r> reloadTab <a-s-r> reopenTab t createTab <a-t> createTab u scrollPageUp V enterVisualLineMode v enterVisualMode <a-v> nextTab W moveTabToNextWindow x removeTab X restoreTab yt duplicateTab yy copyCurrentUrl <c-y> scrollUp zH scrollToLeft zL scrollToRight / enterFindMode ` Marks.activate ^ visitPreviousTab [[ goPrevious ]] goNext << moveTabLeft >> moveTabRight b Vomnibar.activateBookmarks ge Vomnibar.activateUrl gE Vomnibar.activateUrlInNewTab m Marks.activateCreate p openCopiedUrlInCurrentTab yf LinkHints.activateCopyLinkUrl B Vomnibar.activateBookmarksInNewTab F LinkHints.activateOpenInNewTab O Vomnibar.activateInNewTab P openCopiedUrlInNewTab T Vomnibar.activateTabs <a-f> LinkHints.activateWithQueue";t.aa={__proto__:null,"LinkHints.activate":[2,0,0,{m:0}],"LinkHints.activateCopyLinkText":[2,0,0,{m:38}],"LinkHints.activateCopyLinkUrl":[2,0,0,{m:40}],"LinkHints.activateDownloadImage":[2,0,0,{m:35}],"LinkHints.activateDownloadLink":[2,0,0,{m:42}],"LinkHints.activateEdit":[2,0,1,{m:66}],"LinkHints.activateHover":[2,0,0,{m:32}],"LinkHints.activateLeave":[2,0,0,{m:33}],"LinkHints.activateMode":[2,0,0,{m:0}],"LinkHints.activateModeToCopyLinkText":[2,0,0,{m:38}],"LinkHints.activateModeToCopyLinkUrl":[2,0,0,{m:40}],"LinkHints.activateModeToDownloadImage":[2,0,0,{m:35}],"LinkHints.activateModeToDownloadLink":[2,0,0,{m:42}],"LinkHints.activateModeToEdit":[2,0,1,{m:66}],"LinkHints.activateModeToHover":[2,0,0,{m:32}],"LinkHints.activateModeToLeave":[2,0,0,{m:33}],"LinkHints.activateModeToOpenImage":[2,0,0,{m:36}],"LinkHints.activateModeToOpenIncognito":[2,0,0,{m:43}],"LinkHints.activateModeToOpenInNewForegroundTab":[2,0,0,{m:3}],"LinkHints.activateModeToOpenInNewTab":[2,0,0,{m:2}],"LinkHints.activateModeToOpenVomnibar":[2,0,1,{m:65}],"LinkHints.activateModeToSearchLinkText":[2,0,0,{m:37}],"LinkHints.activateModeToSelect":[2,0,0,{m:67}],"LinkHints.activateModeToUnhover":[2,0,0,{m:33}],"LinkHints.activateModeWithQueue":[2,0,0,{m:18}],"LinkHints.activateOpenImage":[2,0,0,{m:36}],"LinkHints.activateOpenIncognito":[2,0,0,{m:43}],"LinkHints.activateOpenInNewForegroundTab":[2,0,0,{m:3}],"LinkHints.activateOpenInNewTab":[2,0,0,{m:2}],"LinkHints.activateOpenVomnibar":[2,0,1,{m:65}],"LinkHints.activateSearchLinkText":[2,0,0,{m:37}],"LinkHints.activateSelect":[2,0,0,{m:67}],"LinkHints.activateUnhover":[2,0,0,{m:33}],"LinkHints.activateWithQueue":[2,0,0,{m:18}],"LinkHints.click":[2,0,0,{direct:true,m:0}],"LinkHints.unhoverLast":[7,0,1,{u:true}],"Marks.activate":[3,0,0],"Marks.activateCreate":[3,0,0,{mode:"create"}],"Marks.activateCreateMode":[3,0,0,{mode:"create"}],"Marks.activateGoto":[3,0,0],"Marks.activateGotoMode":[3,0,0],"Marks.clearGlobal":[15,1,1],"Marks.clearLocal":[15,1,1,{local:true}],"Vomnibar.activate":[8,1,0],"Vomnibar.activateBookmarks":[8,1,1,{mode:"bookm"}],"Vomnibar.activateBookmarksInNewTab":[8,1,1,{mode:"bookm",newtab:1}],"Vomnibar.activateEditUrl":[8,1,0,{url:true}],"Vomnibar.activateEditUrlInNewTab":[8,1,0,{url:true,newtab:1}],"Vomnibar.activateHistory":[8,1,1,{mode:"history"}],"Vomnibar.activateHistoryInNewTab":[8,1,1,{mode:"history",newtab:1}],"Vomnibar.activateInNewTab":[8,1,0,{newtab:1}],"Vomnibar.activateTabs":[8,1,1,{mode:"tab",newtab:1}],"Vomnibar.activateTabSelection":[8,1,1,{mode:"tab",newtab:1}],"Vomnibar.activateUrl":[8,1,0,{url:true}],"Vomnibar.activateUrlInNewTab":[8,1,0,{url:true,newtab:1}],addBookmark:[10,1,0],autoCopy:[11,0,1,{copy:true}],autoOpen:[11,0,1,{o:1}],blank:[0,1,0],clearCS:[13,1,1],clearContentSetting:[13,1,1],clearContentSettings:[13,1,1],clearFindHistory:[14,1,1],closeDownloadBar:[46,1,1,{all:1}],closeOtherTabs:[32,1,1,{other:true}],closeTabsOnLeft:[32,1,0,{$count:-1e6}],closeTabsOnRight:[32,1,0,{$count:1e6}],captureTab:[12,1,1],copyCurrentTitle:[16,1,1,{type:"title"}],copyCurrentUrl:[16,1,1],copyWindowInfo:[16,1,0,{type:"window"}],createTab:[17,1,20],debugBackground:[28,1,1,{reuse:1,url:"chrome://extensions/?id=$id",id_mask:"$id",url_mask:""}],discardTab:[18,1,0],dispatchEvent:[16,0,0],duplicateTab:[19,1,20],editText:[13,0,0],enableCSTemp:[39,1,0,{incognito:true}],enableContentSettingTemp:[39,1,0,{incognito:true}],enterFindMode:[5,1,1,{active:true,selected:true}],enterInsertMode:[2,1,1,{insert:true}],enterVisualLineMode:[9,1,1,{mode:"line"}],enterVisualMode:[9,1,1],firstTab:[21,1,0,{absolute:true}],focusInput:[12,0,0],focusOrLaunch:[28,1,1,{reuse:1}],goBack:[0,0,0,{$count:-1}],goForward:[0,0,0],goNext:[1,1,0,{sed:true}],goPrevious:[1,1,0,{sed:true,rel:"prev"}],goToRoot:[22,1,0,{}],goUp:[22,1,0,{$count:-1,type:"frame"}],joinTabs:[23,1,1],lastTab:[21,1,0,{$count:-1,absolute:true}],mainFrame:[24,1,1],moveTabLeft:[25,1,0,{$count:-1}],moveTabRight:[25,1,0],moveTabToIncognito:[26,1,1,{incognito:true}],moveTabToNewWindow:[26,1,0],moveTabToNextWindow:[27,1,0],newTab:[17,1,20],nextFrame:[3,1,0],nextTab:[21,1,0],openCopiedUrlInCurrentTab:[28,1,1,{reuse:0,copied:true}],openCopiedUrlInNewTab:[28,1,20,{copied:true}],openUrl:[28,1,20],parentFrame:[4,1,0],passNextKey:[9,0,0],performAnotherFind:[5,1,0,{index:"other"}],performBackwardsFind:[5,1,0,{$count:-1}],performFind:[5,1,0],previousTab:[21,1,0,{$count:-1}],quickNext:[21,1,0],reload:[0,0,1,{r:1}],reloadGivenTab:[29,1,0,{single:true}],reloadTab:[29,1,0],removeRightTab:[30,1,0],removeTab:[31,1,0],reopenTab:[33,1,1],reset:[47,1,1],restoreGivenTab:[34,1,0,{one:true}],restoreTab:[34,1,25],runKey:[35,1,0],scrollDown:[4,0,0],scrollFullPageDown:[4,0,0,{view:2}],scrollFullPageUp:[4,0,0,{dir:-1,view:2}],scrollLeft:[4,0,0,{dir:-1,axis:"x"}],scrollPageDown:[4,0,0,{dir:.5,view:2}],scrollPageUp:[4,0,0,{dir:-.5,view:2}],scrollPxDown:[4,0,0,{view:1}],scrollPxLeft:[4,0,0,{dir:-1,axis:"x",view:1}],scrollPxRight:[4,0,0,{axis:"x",view:1}],scrollPxUp:[4,0,0,{dir:-1,view:1}],scrollRight:[4,0,0,{axis:"x"}],scrollSelect:[14,0,0],scrollTo:[4,0,0,{dest:"min"}],scrollToBottom:[4,0,0,{dest:"max"}],scrollToLeft:[4,0,0,{axis:"x",dest:"min"}],scrollToRight:[4,0,0,{axis:"x",dest:"max"}],scrollToTop:[4,0,0,{dest:"min"}],scrollUp:[4,0,0,{dir:-1}],searchAs:[11,0,1,{s:1,copied:true,selected:true}],searchInAnother:[36,1,1],sendToExtension:[37,1,0],showHelp:[7,1,1],showHUD:[38,1,1],showTip:[38,1,1],simBackspace:[12,0,1,{act:"backspace"}],simulateBackspace:[12,0,1,{act:"backspace"}],sortTabs:[23,1,1,{sort:"recency",windows:"current"}],switchFocus:[12,0,1,{act:"switch"}],toggleCS:[39,1,0],toggleContentSetting:[39,1,0],toggleLinkHintCharacters:[6,1,1,{key:"linkHintCharacters"}],toggleMuteTab:[40,1,1],togglePinTab:[41,1,0],toggleStyle:[15,0,1],toggleSwitchTemp:[6,1,1],toggleViewSource:[42,1,1,{opener:true}],toggleReaderMode:[42,1,1,{reader:true,reuse:0,opener:true}],toggleVomnibarStyle:[43,1,1,{style:"dark"}],visitPreviousTab:[45,1,0],wait:[0,1,0,{wait:"count"}],zoom:[44,1,0],zoomIn:[44,1,0],zoomOut:[44,1,0,{$count:-1}],zoomReset:[44,1,0,{$count:9e4}]};let h={__proto__:null,newtab:2,queue:18,"cur-queue":16,"new-active":3,"newtab-active":3,hover:32,unhover:33,leave:33,focus:34,"download-media":35,"download-image":35,image:36,"open-image":36,media:36,search:37,"search-text":37,copy:38,"copy-text":38,"copy-list":55,"copy-url":40,"copy-url-list":57,download:42,incognito:43,"edit-url":64,edit:65,"edit-text":65,input:66,"focus-input":66,editable:66,"focus-editable":66,visual:67};t.ta=["character","word","","lineboundary","line","sentence","paragraph","documentboundary"],t.ea={l:1,h:0,j:9,k:8,$:7,0:6,"}":13,"{":12,")":11,"(":10,w:5,W:5,e:3,b:2,B:2,G:15,g:{g:14},gg:14,o:20,a:{w:21,s:25},aw:21,as:25,y:31,Y:32,C:33,"c-s-c":36,p:34,P:35,n:47,N:46,f1:48,"a-f1":48,v:51,V:52,c:53,"/":55,"c-e":62,"c-y":61,"c-down":62,"c-up":61};let y=e=>{let t="";if(!u&&c&&(t+="#! no-check\n"),t){let a=n.Ct,o=a.keyMappings;a.keyMappings=void 0;try{n.Rt("keyMappings",t+e)}catch(e){}a.keyMappings=o}};1&a.je&&(T(n.Nt("keyMappings")),0===a.Ye.o&&(t.ea["m-s-c"]=36)),n.Ct.keyMappings=e=>{let t=a._e,o=a.me;T(e);let i=JSON.stringify,r=a._e,l=!!o&&i(a.me)!==i(o),s=t?!r||i(t)!==i(r):!!o&&!!r;(s||l)&&n.Pt({N:9,m:a._e,t:a.re,k:l?a.me:null}),s&&n.Ht({N:47,d:{k:a._e}})}});