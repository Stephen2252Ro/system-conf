"use strict";__filename="background/others.js",define(["require","exports","./store","./browser","./utils","./settings","./i18n","./normalize_urls","./parse_urls","./open_urls"],(e,t,r,l,i,n,o,u,s,a)=>{Object.defineProperty(t,"__esModule",{value:true}),i=__importStar(i);let c=(n=__importStar(n)).Ct.showActionIcon=t=>{let i=l.Al.action||l.Al.browserAction;if(!i)return void(n.Ct.showActionIcon=void 0);r.G(t),new Promise((t,r)=>{e(["/background/action_icon.js"],t,r)}).then(__importStar).then(e=>{e.In()});let u=o.or("name");t||(u+="\n\n"+o.or("noActiveState")),i.setTitle({title:u})};n.Nt("showActionIcon")?c(true):r.C(r.A),setTimeout(()=>{new Promise((t,r)=>{e(["/background/sync.js"],t,r)}).then(__importStar)},100),(()=>{function e(){h&&(h.$n=null),v=y=h=_=null,S&&clearTimeout(S),T&&clearTimeout(T),p=D=M=S=T=0,w="",i.bt()}function t(){let r=Date.now()-p;if(r>5e3||r<-5e3)return e();S=setTimeout(t,3e4)}function n(){T=0;let e=h;if(e&&!e.yn&&(h=null,e.$n)){let t=Date.now();return t<p&&(p=t-1e3),f(e.va,e.$n)}}function c(e,t,n,u,a){if(!e.$n)return void(h===e&&(h=null));h=null;let c,f=t.length>0,m=f?t[0]:null,d={};D=u,M=a,f&&(v=new Map),y=[];let p=new Set,b=` ${r.ye.s} `.includes(" type-letter ");for(let e=0,l=n?0:1,o=t.length;e<o;e++){let o=t[e],{title:u,u:a,e:c}=o,f="",m=null!=o.s,g=!(n&&0===e||("tab"===c?o.s===r.Ce:"history"!==c||m));p.has(a)?a=`:${e+l} ${a}`:p.add(a),a=i.k(a,1).replace(/%20/g," "),a=s.Hl(a),g&&(d.Sn=c,f=` ~${e+l}~`),f=(u||b?(u?u+" <dim>":"<dim>")+(b?`[${o.e[0].toUpperCase()}] `:"")+(u?"-</dim> <url>":"</dim><url>"):"<url>")+o.textSplit+"</url>"+(f&&`<dim>${f}</dim>`);let _={content:a,description:f};g&&(_.deletable=true),m&&(d.fo=o.s),(g||m)&&(v.set(a,d),d={}),y.push(_)}if(_=e.va,n)if("search"===m.e){let e=m.p;if(c=(e&&`<dim>${i.it(e)+g}</dim>`)+`<url>${m.textSplit}</url>`,k=2,m=t[1])switch(m.e){case"math":y[1].description=`${m.textSplit} = <url><match>${m.t}</match></url>`}}else k=3,c=y[0].description;else 1!==k&&(c=`<dim>${o.or("OpenC")}</dim><url>%s</url>`,k=1);n&&(w=t[0].u,y.shift()),c&&l.Al.omnibox.setDefaultSuggestion({description:c}),e.$n(y),i.bt()}function f(e,l){if(e=e.trim().replace(i.ft," "),h){let t=e===h.va;if(h.$n=t?l:null,t)return}if(e===_)return void(y&&l(y));if(1===D&&e.startsWith(_))return void l([]);if(h={$n:l,va:e,yn:false},T)return;let o=Date.now(),u=r.ye.t+p-o;if(u>30&&u<3e3)return void(T=setTimeout(n,u));h.yn=true,S||(S=setTimeout(t,3e4)),p=o,v=y=null,w="";let s=D<2||!e.startsWith(_)?0:3===D?e.includes(" ")?0:8:M;r.N._n(e,{o:"omni",t:s,r:P,c:$,f:1},c.bind(null,h))}function m(e,t,l){return e?":"===e[0]&&/^:([1-9]|1[0-2]) /.test(e)&&(e=e.slice(" "===e[2]?3:4)):e=u.yt(""),"file://"===e.slice(0,7).toLowerCase()&&(e=/\.(?:avif|bmp|gif|icon?|jpe?g|a?png|tiff?|webp)$/i.test(e)?u.vt("show image "+e,false,0):e),null!=l?r.ie[5]({s:l}):a.openUrlReq({u:e,r:"currentTab"===t?0:"newForegroundTab"===t?-1:-2})}let d=l.Al.omnibox;if(!d)return;let p,g=o.or("colon")+o.or("NS"),b=d.onDeleteSuggestion,_=null,w="",h=null,T=0,v=null,$=128,y=null,S=0,k=0,D=0,M=0,P=12;d.onInputStarted.addListener(()=>{if(l.getCurWnd(false,e=>{let t=e&&e.width;$=t?Math.floor((t-160/devicePixelRatio)/7.72):128}),S)return e()}),d.onInputChanged.addListener(f),d.onInputEntered.addListener(function t(l,o){let u=h;if(u&&u.$n){if(u.$n=t.bind(null,l,o),u.yn)return;return T&&clearTimeout(T),n()}if(l=l.trim().replace(i.ft," "),null===_&&l)return r.N._n(l,{o:"omni",t:0,r:3,c:$,f:1},(e,t)=>t?m(e[0].u,o,e[0].s):m(l,o));w&&l===_&&(l=w);let s=v&&v.get(l)&&v.get(l).fo;return e(),m(l,o,s)}),b.addListener(e=>{let t=parseInt(e.slice(e.lastIndexOf("~",e.length-2)+1))-1,l=y&&y[t].content,i=l&&v&&v.get(l)||null,n=i&&i.Sn;n?(":"===l[0]&&(l=l.slice(l.indexOf(" ")+1)),r.ie[22]({t:n,s:i.fo,u:l},null)):console.log("Error: want to delete a suggestion but no related info found (may spend too long before deleting).")})})(),(()=>{let e=0,t=false,i=0,o=r.He?"edge:":"chrome:",u=r.He?"":o+"//newtab/",s=r.He?"":o+"//new-tab-page/",a=t=>{0===t.frameId&&t.url.startsWith(o)&&e&(t.url.startsWith(u)||t.url.startsWith(s)?2:1)&&!i&&l.vl(t.tabId)};l.Il([{origins:["chrome://*/*"]},r.He?null:{origins:["chrome://new-tab-page/*"]}],function c(f){if(e=(f[0]?1:0)+(f[1]?2:0),1&e&&!n.Nt("allBrowserUrls")&&(e^=1),t!==!!e){let e=l.Ml();if(!e)return false;e.onCommitted[(t=!t)?"addListener":"removeListener"](a)}i=i||e&&setTimeout(()=>{e?l.$l.query({url:o+"//*/*"},t=>{i=0;for(let i of t||[])!r.Pe.has(i.id)&&e&(i.url.startsWith(u)||i.url.startsWith(s)?2:1)&&l.vl(i.id);return l.Fl()}):i=0},120),e&&!n.Ct.allBrowserUrls&&(n.Ct.allBrowserUrls=c.bind(null,f,false))})})(),r.De&&r.De.then(e=>{r.M(null);let t=e.reason;if("install"===t)t="";else{if("update"!==t)return;t=e.previousVersion}setTimeout(()=>{if(l.$l.query({status:"complete"},e=>{let t=/^(file|ftps?|https?):/;for(let r of e)t.test(r.url)&&l.vl(r.id)}),console.log("%cVimium C%c has been %cinstalled%c with %o at %c%s%c.","color:red","color:auto","color:#0c85e9","color:auto",e,"color:#0c85e9",new Date(Date.now()-6e4*(new Date).getTimezoneOffset()).toJSON().slice(0,-5).replace("T"," "),"color:auto"),r.e.sl&&console.log("Sorry, but some commands of Vimium C require the permission to run in incognito mode."),!t)return void(r.O&&r.O()||Promise.resolve()).then(()=>gA.Wt?new Promise(e=>setTimeout(e,200)):0).then(()=>{r.ie[20]({u:r.e.ul+"#commands"})});if(n.Dt("vomnibarPage"),parseFloat(r.e.rl)<=parseFloat(t))return;if(r.f?r.f(6e3):r.i(true),n.Dt("newTabUrl"),!n.Nt("notifyUpdate"))return;t="vimium_c-upgrade-notification";let i={type:"basic",iconUrl:location.origin+"/icons/icon128.png",title:"Vimium C "+o.or("Upgrade"),message:o.or("upgradeMsg",[r.e.pl])+o.or("upgradeMsg2")+"\n\n"+o.or("clickForMore")};r.Ge>=70&&(i.silent=true);let s=l.Al.notifications;s&&s.create(t,i,e=>{let i;if(i=l.Fl())return i;t=e||t,s.onClicked.addListener(function e(l){l===t&&(s.clear(t),r.ie[20]({u:u.yt("vimium://release")}),s.onClicked.removeListener(e))})})},500)}),setTimeout(()=>{let e=globalThis.document;e&&e.body&&(e.body.innerText=""),i.bt()},1e3)});