"use strict";__filename="background/ports.js",define(["require","exports","./store","./utils","./browser","./exclusions","./i18n"],(e,l,t,r,n,o,u)=>{Object.defineProperty(l,"__esModule",{value:true}),l.getParentFrame=l.complainNoSession=l.complainLimits=l.Kt=l.ensuredExitAllGrab=l.showHUD=l.safePost=l.isNotVomnibarPage=l.ensureInnerCSS=l.indexFrame=l.isExtIdAllowed=l.findCPort=l.Ql=l.Vl=l.OnConnect=l.sendResponse=void 0;let i=(e,l)=>{if(90!==e.H)t.ie[e.H](e,l);else{let r=t.ie[e.c](e.a,l,e.i);r!==l&&l.postMessage({N:4,m:e.i,r})}};l.sendResponse=(e,l,r)=>{let n=t.Pe.get(e.s.Xl);if(n&&n.Qt.includes(e))try{e.postMessage({N:4,m:l,r})}catch(e){}},l.OnConnect=(e,l)=>{let r=d(e),u=r.Ot,a=u===t.Te.vomnibarPage_f;if(l>3||a){if(999===l)return void(r.Xl>=0&&!r.Yl&&n.removeTempTab(r.Xl,e.sender.tab.windowId,r.Ot));if(16&l||a)return void s(e,l,a||u===t.e.Cl)}let c,v,_,b=r.Xl,m=b>=0?t.Pe.get(b):void(b=r.Xl=t.getNextFakeTabId()),g=void 0!==m?m.Zl:null;null!==g?(v=g.Vt,c=g.Ke,_=2===c?3:1):(v=o.Xt?o.Yt(u,r):null,c=null===v?0:v?1:2,_=0),r.Ke=c,void 0!==m&&(_|=4&m.Zt,32&l&&(_|=128,m.Zt|=128),r.Zt=_),4&l?(r.Zt|=8&l,e.postMessage({N:1,p:v,f:3&_}),e.postMessage({N:6,d:t.Ye})):e.postMessage({N:0,f:_,c:t.Ye,p:v,m:t._e,t:t.re,k:t.me}),e.onDisconnect.addListener(f),e.onMessage.addListener(i),void 0!==m?(2&l&&(t.Ve&&m.er.s.Ke!==c&&t.L(b,c),m.er=e),1&l&&!m.lr&&(m.lr=e),m.Qt.push(e)):(t.Pe.set(b,{er:e,lr:1&l?e:null,Qt:[e],Zl:null,Zt:0}),0!==c&&t.Ve&&t.L(b,c))};let f=e=>{let l,{Xl:r}=e.s,n=t.Pe.get(r);if(!n)return;let o=n.Qt;l=o.lastIndexOf(e),e.s.Yl?(l===o.length-1?--o.length:l>=0&&o.splice(l,1),o.length?e===n.er&&(n.er=o[0]):t.Pe.delete(r)):l>=0&&t.Pe.delete(r)},s=(e,l,o)=>{if(l>15){if(o)return e.s.Xl<0&&(e.s.Xl=4&l?t.getNextFakeTabId():t.cPort?t.cPort.s.Xl:t.Ce),e.s.Zt|=256,t.fe.push(e),e.onDisconnect.addListener(a),e.onMessage.addListener(i),void(4&l||e.postMessage({N:42,l:t.ye,s:r.t(false)}))}else e.s.Xl<0||0===e.s.Yl||n.$l.executeScript(e.s.Xl,{file:t.e.El,frameId:e.s.Yl,runAt:"document_start"},n.Fl);e.disconnect()},a=e=>{let l=t.fe,r=l.lastIndexOf(e);r===l.length-1?--l.length:r>=0&&l.splice(r,1)},d=e=>{let l=e.sender,t=l.tab||{id:-1,incognito:false},r=l.url;return l.tab=null,e.s={Yl:l.frameId||0,tr:t.incognito,Ke:0,Zt:0,Xl:t.id,Ot:r}};l.Vl=(e,r,u)=>{var i;return(e=e||(null===(i=t.Pe.get(t.Ce))||void 0===i?void 0:i.lr))&&o.Xt&&(r||o.rr)?e.s.Ot:new Promise(t=>{let r=e&&e.s.Yl?n.Ml():null;e?(r?r.getFrame:n.tabsGet)(r?{tabId:e.s.Xl,frameId:e.s.Yl}:e.s.Xl,o=>{let i=o?o.url:"";return!i&&r&&(u.N=3,l.safePost(e,u)),t(i),n.Fl()}):n.getCurTab(e=>(t(e&&e.length?n.getTabUrl(e[0]):""),n.Fl()))})},l.Ql=(e,r)=>{var n;t.set_cPort(t.cPort||(null===(n=t.Pe.get(t.Ce))||void 0===n?void 0:n.lr));let o=l.Vl(t.cPort,r,e);if("string"!=typeof o)return o.then(l=>(e.u=l,l&&t.ie[e.H](e,t.cPort),l));e.u=o,t.ie[e.H](e,t.cPort)},l.findCPort=e=>{let l=t.Pe.get(e?e.s.Xl:t.Ce);return l?l.er:null},l.isExtIdAllowed=e=>{let l=null!=e.id?e.id:"unknown_sender",r=e.url,n=e.tab,o=t.ke,u=o.get(l);if(true!==u&&n){let e=t.Pe.get(n.id),r=e?e.nr:null;e&&(null==r||r!==l&&"string"==typeof r)&&(e.nr=null==r?l:2)}return null!=u?u:r===t.Te.vomnibarPage_f||(console.log("%cReceive message from an extension/sender not in the allow list: %c%s","background-color:#fffbe5","background-color:#fffbe5;color:red",l),o.set(l,false),false)},l.indexFrame=(e,l)=>{let r=t.Pe.get(e);for(let e of r?r.Qt:[])if(e.s.Yl===l)return e;return null},l.ensureInnerCSS=e=>{if(8&e.Zt)return null;let l=t.Pe.get(e.Xl);return l&&(l.Zt|=4),e.Zt|=12,t.Ne},l.isNotVomnibarPage=(e,l)=>{let t=e.s,r=t.Zt;return!(256&r)&&(l||512&r||(console.warn("Receive a request from %can unsafe source page%c (should be vomnibar) :\n %s @ tab %o","color:red","color:auto",t.Ot.slice(0,128),t.Xl),t.Zt|=512),true)},l.safePost=(e,l)=>{try{return e.postMessage(l),1}catch(e){return 0}},l.showHUD=(e,r)=>{r&&(e.startsWith(t.e.ll+"-")&&e.includes("://")&&(e=e.slice(e.indexOf("/",e.indexOf("/")+2)+1)||e),e=e.length>41?e.slice(0,41)+"\u2026":e+"."),t.cPort&&!l.safePost(t.cPort,{N:12,H:l.ensureInnerCSS(t.cPort.s),k:r?e?20:r:1,t:e})&&t.set_cPort(null)},l.ensuredExitAllGrab=e=>{let l={N:8};for(let t of e.Qt)4&t.s.Zt||(t.postMessage(l),t.s.Zt|=4);e.Zt|=4},l.Kt=(e,l)=>{let n=r.dt(t.Pe),o=t.Ce,u=l=>{let r=t.Pe.get(l),n=0;return null!=r&&(n=Math.min(r.Qt.length,8),e(r)),n};if(n.length<50){let i=n.indexOf(o);i>=0&&(n.splice(i,1),e(t.Pe.get(o))),r.n(n,u,l)}else n.forEach(u)},l.complainLimits=e=>{l.showHUD(u.or("notAllowA",[e]))},l.complainNoSession=()=>{l.complainLimits("control tab sessions")},l.getParentFrame=(e,r,o)=>r&&n.Ml()?1===o&&t.Ge>48?n.kl(n.Ml().getFrame,{tabId:e,frameId:r}).then(t=>{let r=t?t.parentFrameId:0;return r>0?l.indexFrame(e,r):null}):n.kl(n.Ml().getAllFrames,{tabId:e}).then(t=>{let n=false,u=r;if(!t)return null;do{n=false;for(let e of t)if(e.frameId===u){u=e.parentFrameId,n=u>0;break}}while(n&&0<--o);return u>0&&u!==r?l.indexFrame(e,u):null}):Promise.resolve(null)});