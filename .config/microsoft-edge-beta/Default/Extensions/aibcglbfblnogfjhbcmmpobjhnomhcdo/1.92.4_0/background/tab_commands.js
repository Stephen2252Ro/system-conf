"use strict";__filename="background/tab_commands.js",define(["require","exports","./store","./utils","./browser","./normalize_urls","./parse_urls","./ports","./i18n","./run_commands","./clipboard","./open_urls","./frame_commands","./filter_tabs","./tools"],(e,l,t,r,n,i,o,u,d,f,a,s,w,m,c)=>{Object.defineProperty(l,"__esModule",{value:true}),l.kr=l.toggleTabUrl=l.togglePinTab=l.toggleMuteTab=l.removeTab=l.reloadTab=l.moveTabToNextWindow=l.moveTabToNewWindow=l.joinTabs=l.copyWindowInfo=void 0,r=__importStar(r);let v=Math.abs,p=()=>{t.cPort&&w.focusFrame(t.cPort,false,0)};l.copyWindowInfo=e=>{let l=!!(t.get_cOptions().decoded||t.get_cOptions().decode),i=t.get_cOptions().type,o=a.rn(t.get_cOptions());if("frame"===i&&t.cPort){let r;return 128&t.cPort.s.Zt?(t.cPort.postMessage({N:3,H:16,d:l,e:o}),r=1):r=u.Ql({H:16,u:"",d:l,e:o}),void(1!==r&&(r&&r instanceof Promise?r.then(()=>{e(1)}):e(1)))}n.$l.query("browser"===i?{windowType:"normal"}:{active:"window"!==i&&("tab"!==i||v(t.cRepeat)<2)||void 0,currentWindow:true},f=>{if(!i||"title"===i||"frame"===i||"url"===i)return t.ie[16]({u:"title"===i?f[0].title:n.getTabUrl(f[0]),d:l,e:o},t.cPort),void e(1);let a=t.cPort?t.cPort.s.tr:2===t.we,s=t.get_cOptions().format,w=""+(s||"${title}: ${url}"),c=t.get_cOptions().join,v="json"===c&&!s,p=t.get_cOptions().filter;if(p){let e=t.cPort?t.cPort.s.Xl:t.Ce,l=f.filter(e=>e.incognito===a),r=l.find(l=>l.id===e),n=l.length;l=m.si(r,l,p),p=l.length<n?p:null,p&&(f=l)}if("tab"!==i||p)(f=f.filter(e=>e.incognito===a)).sort((e,l)=>e.windowId-l.windowId||e.index-l.index);else{let e=f.length<2?0:n.selectFrom(f).index,l=m.getTabRange(e,f.length);f=f.slice(l[0],l[1])}let b=f.map(e=>v?{title:e.title,url:l?r.et(n.getTabUrl(e)):n.getTabUrl(e)}:w.replace(/\$\{([^}]+)\}/g,(t,i)=>{let o;return l&&"url"===i?r.et(n.getTabUrl(e)):"__proto__"!==i&&(o=e[i],o&&"object"==typeof o?JSON.stringify(o):o||"")})),I=t.R(b,c,o);u.showHUD("tab"===i&&f.length<2?I:d.or("copiedWndInfo"),15),e(1)})},l.joinTabs=e=>{let l=null!=t.get_cOptions().order?t.get_cOptions().order:t.get_cOptions().sort,r=t.get_cOptions().windows,i="current"===r,o=o=>{let u=2===t.we;o=i?o:o.filter(e=>e.incognito===u);let d=i?o:o.filter(e=>e.id===t.Se),f=d.length?d[0]:null;if(!i&&!f)return void e(0);let a=r=>{let i=[],u=e=>{i.push(e)};if(o.sort((e,l)=>e.id-l.id).forEach(e=>{e.tabs.forEach(u)}),!i.length)return void e(0);let d=t.get_cOptions().filter;if(d){let e=i.find(e=>e.id===t.Ce),l=i.length;i=m.si(e,i,d),d=i.length<l?d:null}l&&(i=m.oi(i,l));let f=r?r.tabs.length:0,a=r?r.id:t.Se;d&&(f=i.reduce((e,l)=>l.windowId===a?Math.min(l.index,e):e,i.length));for(let e of i)n.$l.move(e.id,{windowId:a,index:f++});for(let e of i)e.pinned&&n.tabsUpdate(e.id,{pinned:true});e(1)};if(f&&"popup"===f.type&&f.tabs.length){let e=f.tabs[0].id;f.tabs=f.tabs.filter(l=>l.id!==e),n.makeWindow({tabId:e,incognito:f.incognito},f.state,a)}else o=i||!f||"all"===r?o:o.filter(e=>e.id!==f.id),a(f)};i?n.getCurWnd(true,e=>e?o([e]):n.Fl()):n.Pl.getAll({populate:true,windowTypes:["normal","popup"]},o)},l.moveTabToNewWindow=e=>{let l=r=>{if(!r)return e(0),n.Fl();let i=r.tabs,o=i.length,a=!!t.get_cOptions().all;if(!a&&o<=1)return;let s,w,{incognito:c,index:v}=n.selectFrom(i);if(a){for(let l of i)if(null!=n.getGroupId(l))return u.showHUD("Can not keep groups info during this command"),void e(0);s=[0,w=o]}else{if(s=m.getTabRange(v,o),w=s[1]-s[0],w>=o)return u.showHUD(d.or("moveAllTabs"));if(w>30&&f.tn())return void f.ln("moveTabToNewWindow",w).then(l.bind(null,r))}n.makeWindow({tabId:i[v].id,incognito:c},"normal"===r.type?r.state:"",w<2?p:l=>{if(!l)return void e(0);p();let t=i.slice(s[0],v),r=i.slice(v+1,s[1]),o=t.length,u=r.length,d=e=>e.id;o&&(n.$l.move(t.map(d),{index:0,windowId:l.id},n.Fl),o>1&&n.$l.move(i[v].id,{index:o})),u&&n.$l.move(r.map(d),{index:o+1,windowId:l.id},n.Fl);for(let e of i)e.pinned&&n.tabsUpdate(e.id,{pinned:true});e(1)})},r=!!t.get_cOptions().incognito;r&&(t.cPort?t.cPort.s.tr:2===t.we)?(u.showHUD(d.or("hasIncog")),e(0)):n.getCurWnd(true,r?l=>{if(!l)return e(0),n.Fl();let r=n.selectFrom(l.tabs);if(l.incognito&&r.incognito)return e(0),u.showHUD(d.or("hasIncog"));let i=r.id,o={incognito:true},a=n.getTabUrl(r);if(r.incognito);else{if(n.xl(a))return e(0),u.complainLimits(d.or("openIncog"));o.url=a}l.tabs=null,n.Pl.getAll(r=>{if((r=r.filter(e=>e.incognito&&"normal"===e.type)).length)return void n.$l.query({windowId:s.preferLastWnd(r).id,active:true},([e])=>{n.tabsCreate({url:a,windowId:e.windowId,index:s.newTabIndex(e,t.get_cOptions().position,false,false)},f.getRunNextCmdBy(3)),n.selectWnd(e),n.$l.remove(i)});let u,d="normal"===l.type?l.state:"";(u=null!=o.url)?t.e.sl&&(o.focused=true,d=""):o.tabId=i,n.makeWindow(o,d,l=>{u||l&&p(),e(!!l)}),u&&n.$l.remove(i)})}:l)},l.moveTabToNextWindow=([e],l)=>{n.Pl.getAll(r=>{let i,o,u=false===t.get_cOptions().minimized||false===t.get_cOptions().min;if(i=r.filter(l=>l.incognito===e.incognito&&"normal"===l.type&&(!u||"minimized"!==l.state)),i.length>0){o=i.map(e=>e.id);let r=o.indexOf(e.windowId);if(o.length>=2||r<0){let i=(r+t.cRepeat)%o.length;return r<0&&t.cRepeat<0&&i++,i<0&&(i+=o.length),void n.$l.query({windowId:o[i],active:true},([r])=>{let i=t.get_cOptions().end?null:null!=t.get_cOptions().position?s.newTabIndex(e,t.get_cOptions().position,false,false):r.index+(false!==t.get_cOptions().right?1:0),o=null==i||i>r.index,u=()=>{-1!==d?(n.$l.move(e.id,{index:null!=i?i:-1,windowId:r.windowId},p),n.selectWnd(r),n.selectTab(e.id,n.yl(l)),d>0&&n.selectTab(d)):n.$l.query({windowId:e.windowId,index:e.index+(o?-1:1)},e=>(d=e&&e[0]&&e[0].id||-9,u(),n.Fl()))},d=o&&!e.index?-9:-1;u()})}}else i=r.filter(l=>l.id===e.windowId);n.makeWindow({tabId:e.id,incognito:e.incognito},1===i.length&&"normal"===i[0].type?i[0].state:"",e=>{e&&p(),l(!!e)})})},l.reloadTab=(e,[r,i,o],u,d)=>{let a={bypassCache:true===(t.get_cOptions().hard||t.get_cOptions().bypassCache)},s=n.$l.reload;if(v(t.cRepeat)<2||t.get_cOptions().single)return void s(e[d?i:r].id,a,f.getRunNextCmdBy(0));let w=o-r;if(w>20&&f.tn())f.ln("reloadTab",w).then(l.reloadTab.bind(null,e,[r,i,o],u));else for(s(e[i].id,a,f.getRunNextCmdBy(0));r!==o;r++)r!==i&&s(e[r].id,a)},l.removeTab=(e,r,i)=>{let o=t.get_cOptions().highlighted,u=t.get_cOptions().goto||(t.get_cOptions().left?"left":""),d=(u+"").split(/[\/,;\s]/),a=d.length>1?d[v(t.cRepeat)>1?1:0]:u+"",s="near"===a||"reverse"===a||a.startsWith("back"),w=a.startsWith("forw"),p=s?t.cRepeat>0:w?t.cRepeat<0:"left"===a,_=s?t.cRepeat<0:w?t.cRepeat>0:"right"===a,g=a.includes("previous"),x=g&&a.includes("only");if(!r){let r=v(t.cRepeat)>1||o||g&&!x;return void(r?n.getCurTabs:n.getCurTab)(l.removeTab.bind(null,e,r?2:1))}if(!i||!i.length)return n.Fl();let T,h=i.length,y=n.selectFrom(i),k=y.index,j=1,$=k,O=k+1;if(v(t.cRepeat)>1&&h>1){let n=0;if(i[0].pinned!==y.pinned&&!(t.cRepeat<0&&i[k-1].pinned))for(;i[n].pinned;)n++;let o=m.getTabRange(k,h-n,h);if(j=o[1]-o[0],j>20&&f.tn()&&r<3)return void f.ln("removeTab",j).then(l.removeTab.bind(null,e,2,i));j>1&&($=n+o[0],O=n+o[1])}else if(o){let l=i.filter(e=>e.highlighted&&e!==y),t="no-current"===o;if(j=l.length+1,j>1&&(t||j<h)&&n.$l.remove(l.map(e=>e.id),n.Fl),t)return void e(j>1)}else if(t.get_cOptions().filter&&0==m.si(y,[y],t.get_cOptions().filter).length)return void e(false);if(!$&&j>=h&&true!==(null!=t.get_cOptions().mayClose?t.get_cOptions().mayClose:t.get_cOptions().allow_close))return void(r<2?n.getCurTabs(l.removeTab.bind(null,e,3)):n.Pl.getAll(b.bind(null,e,y,i)));if(r<2){if(x){let e=m.ai();e>=0&&(T=n.kl(n.tabsGet,e))}else(_||p&&$>0)&&(T=n.kl(n.$l.query,{windowId:y.windowId,index:p?$-1:$+1}).then(e=>e&&e[0]));if(T)return void T.then(t=>{t&&t.windowId===y.windowId&&n.Wl(t)?(n.selectTab(t.id),n.$l.remove(y.id,n.yl(e))):n.getCurTabs(l.removeTab.bind(null,e,3))})}let M=h;if(j>=h);else if(g){let e=!x&&O<h&&!t.Ee.has(i[O].id)?i[O]:i.filter((e,l)=>(l<$||l>=O)&&t.Ee.has(e.id)).sort(c.ar.Xr)[0];M=e?e.index:h}else if(p||_){let e=M=p?$>0?$-1:O:O<h?O:$-1;for(;e>=0&&e<h&&(e<$||e>=O)&&!n.Wl(i[e]);)e+=e<$?-1:1;M=e>=0&&e<h?e:M}M>=0&&M<h&&n.selectTab(i[M].id),I(y,i,$,O,e)};let b=(e,l,r,i)=>{let o,u,d=false;i=i.filter(e=>"normal"===e.type),"always"===t.get_cOptions().keepWindow?d=!i.length||i.some(e=>e.id===l.windowId):i.length<=1?(d=true,(u=i[0])&&(u.id!==l.windowId?d=false:u.incognito&&!n.xl(t.Te.newTabUrl_f)&&(o=u.id))):l.incognito||1===(i=i.filter(e=>!e.incognito)).length&&i[0].id===l.windowId&&(o=i[0].id,d=true),d&&n.tabsCreate({index:r.length,url:"",windowId:o},f.getRunNextCmdBy(3)),I(l,r,0,r.length,d?e:null)},I=(e,l,r,i,o)=>{n.$l.remove(e.id,o?n.yl(o):n.Fl);let u=l.slice(e.index+1,i),d=l.slice(r,e.index);t.cRepeat<0&&([u,d]=[d,u]),u.length>0&&n.$l.remove(u.map(e=>e.id),n.Fl),d.length>0&&n.$l.remove(d.map(e=>e.id),n.Fl)};l.toggleMuteTab=e=>{t.get_cOptions().all||t.get_cOptions().other||t.get_cOptions().others?n.$l.query({audible:true},l=>{let r=t.get_cOptions().other||t.get_cOptions().others?t.cPort?t.cPort.s.Xl:t.Ce:-1,i=0===l.length||-1!==r&&1===l.length&&l[0].id===r;if(null!=t.get_cOptions().mute)i=!!t.get_cOptions().mute;else for(let e of l)if(e.id!==r&&!n.isTabMuted(e)){i=true;break}let o={muted:i};for(let e of l)e.id!==r&&i!==n.isTabMuted(e)&&n.tabsUpdate(e.id,o);let f=-1===r?"All":"Other";u.showHUD(d.or(i?"mute":"unmute",[d.or(f)||f])),e(1)}):n.getCurTab(([l])=>{let r=!n.isTabMuted(l),i=null!=t.get_cOptions().mute?!!t.get_cOptions().mute:r;i===r&&n.tabsUpdate(l.id,{muted:i}),u.showHUD(d.or(i?"muted":"unmuted")),e(1)})},l.togglePinTab=(e,r,i,o)=>{let u=r[1],d=e[u],a=!d.pinned,s={pinned:a},w=a?0:1,c=0;if(o&&(r=[u,u,u+1]),v(t.cRepeat)>1&&a)for(;e[c].pinned;)c++;let p=m.getTabRange(u-c,e.length-c,e.length),b=c+p[w]-w,I=c+p[1-w]-w,_=[];for(;b!==I;b+=a?1:-1)(a||e[b].pinned)&&_.push(e[b].id);if(I=_.length,I>30&&f.tn())f.ln("togglePinTab",I).then(l.togglePinTab.bind(null,e,r,i));else for(let e of _)n.tabsUpdate(e,s,e===d.id?n.yl(i):n.Fl)},l.toggleTabUrl=(e,l)=>{let a=n.getTabUrl(e[0]),w=t.get_cOptions().reader,m=t.get_cOptions().keyword;if(a.startsWith(t.e.ll))return u.complainLimits(d.or(w?"noReader":"openExtSrc")),void l(0);if(w&&m){let l=o.Gl({u:a});l&&l.k===m?(f.overrideCmdOptions({keyword:""}),s.openUrlWithActions(l.u,0,e)):(a=i.yt(l&&t.get_cOptions().parsed?l.u:a,m),s.openUrlWithActions(a,9,e))}else w?t.He&&r.gt.test(a)?(a=a.startsWith("read:")?r.tt(a.slice(a.indexOf("?url=")+5)):`read://${new URL(a).origin.replace(/:\/\/|:/g,"_")}/?url=${r.g(a)}`,s.openUrlWithActions(a,9,e)):(u.complainLimits(d.or("noReader")),l(0)):(a=a.startsWith("view-source:")?a.slice(12):"view-source:"+a,s.openUrlWithActions(a,9,e))},l.kr=(e,l,r,i)=>{let o,u=e.id,d=1===l;if(l&&n.Ol()&&(false!==i||null==n.getGroupId(e))){let l=0,t=-1,r=()=>{let e=n.Fl();if(e)return n.Ol().restore(null,f.getRunNextCmdBy(0)),t>=0&&n.$l.remove(t),t=0,e;l+=1,l>=5||setTimeout(()=>{n.tabsGet(u,r)},50*l*l)};return d&&n.tabsCreate({url:"about:blank",active:false,windowId:e.windowId},e=>{t?t=e.id:n.$l.remove(e.id)}),void n.$l.remove(u,()=>(n.tabsGet(u,r),n.Fl()))}{let l=n.isTabMuted(e);o=e=>{l!==n.isTabMuted(e)&&n.tabsUpdate(e.id,{muted:l})}}let a={windowId:e.windowId,index:e.index,url:n.getTabUrl(e),active:e.active,pinned:e.pinned,openerTabId:e.openerTabId};r&&(a=Object.assign(r,a)),null!=a.index&&a.index++,n.openMultiTabs(a,1,true,[null],i,e,e=>{e&&o&&o(e),e?f.runNextOnTabLoaded(t.get_cOptions(),e):f.runNextCmd(0)}),n.$l.remove(u)}});