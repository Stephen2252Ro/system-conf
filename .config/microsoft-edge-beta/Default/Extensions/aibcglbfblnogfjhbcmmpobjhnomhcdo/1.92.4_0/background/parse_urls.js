"use strict";__filename="background/parse_urls.js",define(["require","exports","./store","./utils","./normalize_urls"],(e,l,t,r,u)=>{Object.defineProperty(l,"__esModule",{value:true}),l.Rl=l.Ul=l.Hl=l.Tl=l.Bl=l.Dl=l.Gl=void 0,r=__importStar(r),l.Gl=e=>{let i,n,f=e.u,s=f.toLowerCase(),a=null,o=false;if(!r.gt.test(u.xt(s)))return r.bt(),null;if(e.p){let t=l.Dl(e);return{k:"",s:0,u:null!=t.p?t.u:f,e:null!=t.p?t.p:t.u}}let p=t.Te.searchEngineRules;for((n=r.d(s))&&(s=s.slice(n),f=f.slice(n)),n=p.length;0<=--n&&(i=p[n],!s.startsWith(i.Jl)||(a=f.slice(i.Jl.length).match(i.Kl),!a)););if(!a||!i){let e=t.e.Sl;return s.startsWith(e)?(f=f.slice(e.length).replace(/^#!?/,""),{k:"vimium://show",u:f,s:f.startsWith("image")&&f.lastIndexOf("&",f.indexOf(":")+1)+1||f.indexOf(" ")+1}):(r.bt(),null)}a.length>1&&!i.Kl.global&&a.shift();let g=i.Ll;for(a.length>1?o=true:g instanceof RegExp?(s=a[0],(a=s.match(g))?(a.shift(),o=true):a=[s]):a=a[0].split(g),s="",n=0;n<a.length;n++)s+=" "+r.tt(a[n]);return s=s.trim().replace(r.ft," "),r.bt(),{k:i.Nl,u:s,s:o?s.lastIndexOf(" ")+1:0}},l.Dl=e=>{let{u:l}=e,n=l.toLowerCase();if(1===e.p){let r=t.j(l,131072,e.s);if(r!==l&&r&&r!==l+"/"&&r+"/"!==l){let e=u.yt(r,null,-2);if(0===u.kt)return{u:e,p:"(sed)"}}}if(!r.gt.test(u.xt(n)))return{u:"This url has no upper paths",p:null};let f,s,a,o,p=encodeURIComponent,g="",m=false,_=false,c=false,$=null,h=0,d=0,b=false;if((a=l.lastIndexOf("#")+1)&&(g=l.slice(a+ +("!"===l.substr(a,1))),f=r.tt(g),a=f.lastIndexOf("/"),a>0||0===a&&f.length>1)){b=f!==g;let e=/([^&=]+=)([^&\/=]*\/[^&]*)/;s=e.exec(f)||/(^|&)([^&\/=]*\/[^&=]*)(?:&|$)/.exec(f),$=s?s[2]:f,"/"===$||$.includes("://")?$=null:s?b?(f="https://example.com/",f=encodeURI(f+$).slice(f.length),a=(g.indexOf(f)+1||g.indexOf(f=p($))+1)-1,a<0&&(b=false,a=g.indexOf(f=$)),d=a+f.length,a<0&&"&"!==s[1]&&(a=g.indexOf(f=s[1]),a<0&&(b=true,f=p(s[1].slice(0,-1)),a=g.indexOf(f)),a>=0&&(a+=f.length,d=g.indexOf("&",a)+1)),a>=0?h=a:(o=e.exec(g))?($=r.tt(o[2]),h=o.index+o[1].length,d=h+o[2].length):"&"!==(f=s[1])&&(a=l.length-g.length,g=f+p($),l=l.slice(0,a)+g,h=f.length,d=0)):h=s.index+s[1].length:h=0,$&&(a=l.length-g.length,h+=a,d>0&&(d+=a))}if(!$){if(n.startsWith(t.e.ll)&&!e.f)return{u:"An extension has no upper-level pages",p:null};g="",h=l.indexOf("/",l.indexOf("://")+3),n.startsWith("filesystem:")&&(h=l.indexOf("/",h+1)),h=h<0?0:h,a=l.indexOf("?",h),d=l.indexOf("#",h),a=d<0?a:a<0?d:a<d?a:d,a=a>0?a:l.length,$=l.slice(h,a),d=0,b=false}if(a=e.p,m=$.startsWith("/"),!g&&n.startsWith("file:")){if($.length<=1||11===l.length&&l.endsWith(":/")){if(!e.f)return{u:"Here has been the root path",p:null};a=0}_=true,e.f||1===a&&(a=-1)}else _=!(g||!n.startsWith("ftp:"))||(null!=e.t?!!e.t:null!=e.r?!!e.r:$.length>1&&$.endsWith("/")||/\.([a-z]{2,3}|apng|jpeg|tiff)$/i.test($));let w=$.slice(+m,$.length-+$.endsWith("/")).split("/"),x=w.length,v=a<0?a+x:a;c=x<=1&&a<=-2&&l.lastIndexOf("#",h)>0,a=v>x?x:a>0?v-1:v>0?v:0,w.length=a,$=w.join("/"),(f=e.a||"")&&($+="/"===f[0]?f:"/"+f),$=$?("/"===$[0]?"":"/")+$+(!_||$.endsWith("/")?"":"/"):"/",!d&&l.lastIndexOf("git",h-3)>0&&($=i(l,$)||$),!c||$&&"/"!==$?(f=b?p($):$,l=l.slice(0,h)+(d?f+l.slice(d):f)):l=l.split("#",1)[0];let k=t.j(l,64,e.s)||l;if(k!==l){let e=u.yt(k,null,-2);l=0===u.kt?e:l}return{u:l,p:$}};let i=(e,l)=>{let t=r.ot(e),u=t?t.host:"";if(!u)return;if(!/git\b|\bgit/i.test(u)||!/^[\w\-]+(\.\w+)?(:\d{2,5})?$/.test(u))return;let i=l.split("/"),n=i.length-1;i[n]||(n--,i.pop());let f=i[n];if(u.startsWith("github.")){if(3===n)return"pull"===f||"milestone"===f||"commit"===f?l+"s":"tree"===f||"blob"===f?i.slice(0,3).join("/"):null;if(4===n&&"releases"===i[3]&&("tag"===i[4]||"edit"===i[4]))return i.slice(0,4).join("/");if(n>3)return"blob"===i[3]?(i[3]="tree",i.join("/")):null}};l.Bl=(e,t)=>"string"==typeof t&&t.toLowerCase().startsWith("whole")?l.Tl(e):n(e);let n=e=>{let t,r=e.indexOf("\uff1a")+1||e.indexOf(":")+1;if(r&&"/"!==e[r]){let l=e.slice(0,r-1).trim().toLowerCase();if("link"!==l&&"\u94fe\u63a5"!==l)return e;if(t=e.slice(r).trim(),r=t.indexOf("\uff1a")+1||t.indexOf(":")+1,!r||!/^[\w+-]+((?:\.[\w+-])*\.[a-z]{2,6})?\//.test(t))return e}else{if(!r||"/"!==e.substr(r+1,1))return e;t=e}let i=/\s|[^=][\u3002\uff0c\uff1b]([^a-z?&#-]|$)/.exec(t),n=!!i&&1===i[0].length,f=i?t.slice(0,i.index+(n?0:1)):null,s=/["(\u2018\u201c\u300a\uff08\uff1c]/,a=(f||t).includes("#~:text=")?0:7;return a&&f&&(n?",.;\u3002\uff0c\uff1b".lastIndexOf(f.slice(-1),2)>=0?(t=f.slice(0,-1),a=3):'")\u2019\u201d\u300b\uff09\uff1e'.includes(f.slice(-1))&&(a=s.test(f.slice(r))?0:(t=f.slice(0,-1),1)):(t=f,a=3)),4&a&&",.;\u3002\uff0c\uff1b".includes(t.slice(-1))&&(t=t.slice(0,-1)),2&a&&'")\u2019\u201d\u300b\uff09\uff1e'.includes(t.slice(-1))&&(s.test(t.slice(r))?a=0:t=t.slice(0,-1)),t&&",.;\u3002\uff0c\uff1b".includes(t[0])&&(t=t.slice(1).trim()),1&a&&t&&s.test(t[0])&&(t=t.slice(1)),t=l.Tl(t,false,true),u.kt<=2&&!t.startsWith("vimium:")?t:e};l.Tl=(e,l,t)=>{let r=+e.includes("\u3002")+2*+e.includes("\uff1a");if(!r&&!t)return e;let i=e.indexOf("//");if(i=e.indexOf("/",i>=0?i+2:0),i>=0&&i<4)return e;let n=i>0?e.slice(0,i):e;return/^(data|javascript)[:\uff1a]/i.test(n)?e:(1&r&&(n=n.replace(/\u3002/g,".")),2&r&&(n=n.replace("\uff1a",":").replace("\uff1a",":")),i>0&&(n+=e.slice(i)),u.yt(n,null,-2),u.kt<3?n:1!==r||!l||/[^.\w\u3002-]/.test(e)?e:e.replace(/\u3002/g,"."))},l.Hl=e=>{if(2===t.Ye.o&&e.startsWith("file://")){let l=e.indexOf("/",7);if(l<0||l===e.length-1)return l<0?e+"/":e;e=7===l&&":"===e.substr(9,1)?e[8].toUpperCase()+e.slice(9):"\\\\"+e.slice(7);let t=/[?#]/.exec(e),r=t?t.index:0,u=r?e.slice(r):"";e=(e=r?e.slice(0,r):e).replace(/\/+/g,"\\"),e=r?e+u:e}return e},l.Ul=(e,t)=>{let i,n,s,a,o,p,g=[],m=u.St,_=/\s/,c=e=>!!((e=e.trim())&&"__proto__"!==e&&e.length<51)&&(t.set(e,o),true);for(let t of e.replace(/\\\\?\n/g,e=>3===e.length?"\\\n":"").split("\n")){if(t=t.trim(),t<"$")continue;p=0;do{p=t.indexOf(":",p+1)}while(92===t.charCodeAt(p-1));if(p<=0||!(a=t.slice(0,p).trimRight()))continue;if(i=a.replace(/\\:/g,":").split("|"),t=t.slice(p+1).trimLeft(),!t)continue;a=t.replace(/\\\s/g,"\\s"),p=a.search(_);let $="";if(p>0){if(e=t.slice(p),t=a.slice(0,p),p=e.search(/\sblank=/i),p>=0){let l=e.slice(p+7).search(_);l=l>0?p+7+l:0,$=e.slice(p+7,l||void 0),e=e.slice(0,p)+(l?e.slice(l):"")}p=e.search(/\sre=/i)}else t=a,e="";if(t=t.replace(/\\s/g," ").trim().replace(/([^\\]|^)%(s)/gi,"$1$$$2").replace(/\\%/g,"%"),o={Nl:"",A:$,Ot:t},i=i.filter(c),0!==i.length){if(-1===p){m.lastIndex=0;let e=m.exec(t);e&&(p=e.index+1)&&(a=e[2],a?t=t.replace(m,"$$$1"):a="s"===e[1]?"+":" ",t=u.yt(t,null,-1),u.kt>2?(t=t.replace(/%24(s)/gi,"$$$1"),p=t.search(m)+1):0!==u.kt&&(p+=2===u.kt?7:5),(n=f(t.toLowerCase(),p))&&(a.includes("$")?(a=a.replace(u.jt,"(.*)"),s=new RegExp("^"+a,/[a-z]/i.test(a)?"i":"")):s=a.trim()||" ",g.push({Jl:n.Jl,Kl:n.Kl,Nl:i[0].trimRight(),Ll:s})))}else if(47===e.charCodeAt(p+4)){a=p>1?e.slice(1,p).trim():"",p=(e=e.slice(p+5)).search(/[^\\]\//)+1,t=e.slice(0,p),p=(e=e.slice(p+1)).search(_);let u=r.l(t,p>=0?e.slice(0,p):e);u&&(a=l.Rl(a),g.push({Jl:a,Kl:u,Nl:i[0].trimRight(),Ll:o.Ot.lastIndexOf("$S")>=0?" ":"+"})),e=p>=0?e.slice(p+1):""}else e=e.slice(p+4);e=e.trimLeft(),o.Nl=e?r.tt(e):i[i.length-1].trimLeft()}}return g};let f=(e,t)=>{if(t<1||!r.gt.test(e))return null;let u,i,n,f;return u=e.slice(0,t-1),(t=Math.max(u.lastIndexOf("?"),u.lastIndexOf("#"))+1)?(n=i=u.slice(t),u=u.slice(0,u.search(/[#?]/)),(f=i.lastIndexOf("&")+1)&&(n=i.slice(f)),n&&n.indexOf("=")>=1?(i="[#&?]",e="([^#&]*)"):(n=i,i="#"===e[t-1]?"#":n?"[#?]":"\\?",e="([^#&?]*)")):(i="^([^#?]*)",(n=e.slice(u.length+2))&&(t=n.search(/[#?]/)+1)&&(n=n.slice(0,t-1)),e=""),n=n&&r.o(n).replace(/\\\+|%20| /g,"(?:\\+|%20| )"),u=l.Rl(u),{Jl:u,Kl:new RegExp(i+n+e,/[a-z]/i.test(n)?"i":"")}};l.Rl=e=>{let l=e.slice(0,9).toLowerCase(),t=r.d(l);return t?e=e.slice(t):"vimium://"===l&&(e=u.vt(e.slice(9),false,-1)),e}});