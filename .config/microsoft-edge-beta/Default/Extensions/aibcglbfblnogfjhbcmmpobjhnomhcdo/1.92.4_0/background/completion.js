"use strict";__filename="background/completion.js",define(["require","exports","./store","./browser","./utils","./normalize_urls","./parse_urls","./completion_utils","./browsing_data_manager"],function(e,t,l,r,f,i,u,n,o){Object.defineProperty(t,"__esModule",{value:true}),f=__importStar(f);let s=0,a=false,_=false,c=0,m=0,h=0,d=0,p=0,w=[""],b="",g="",v="",S="",$=0,y=false,k=false,x="",M="",R=0,T=true,z=function(e,t,l,r,f,i){this.e=e,this.u=t,this.t=l,this.title=r,this.r=f(this,i),this.visit=0},F={_n(e,t){if(0!==w.length&&1&R)2===l.ce.Ke?F.ef():o.Ti.wi=()=>{e.o||F.ef()};else if(I.tf([],1),t)return;0===l.ce.Ke&&o.Ti.Ii()},ef(){var e;let t,r=w.some(e=>47===e.charCodeAt(0)),f=null===(e=n.ji.lf)||void 0===e?void 0:e.Fe,i=n.ji.rf?[]:null,u=f&&f[0]===r?f[1]:l.ce.Fe,s=u.length,a=[];for(let e=0;e<s;e++){let t=u[e];if(n.ff(t.t,r?t.Oi:t.Ai)&&(T||t.Bi)){if(null!==i&&i.push(t),M&&t.u.length<M.length+2&&M===(t.u.endsWith("/")?t.u.slice(0,-1):t.u))continue;a.push([-n.if(t.t,t.Ai),e])}}i&&(n.ji.rf.Fe=[r,i]),t=a.length,d+=t,t?(a.sort(n.sortBy0),p>0&&!(6&R)?(a=a.slice(p,p+m),p=0):t>p+m&&(a.length=p+m)):R^=1;let _=[],h=64&c?-.666446:0;for(let[e,t]of a){let f=u[t];h&&(e=e<h?e:(e+h)/2);let i=new z("bookm",f.u,f.t,r?f.Oi:f.Ai,n.get2ndArg,-e),s=32&c&&o.hi.qi?o.hi.Ci(f.u):-1;i.visit=s<0?0:l.ue.We[s].Qi,_.push(i),null!==f.Pi&&(i.u=f.Pi,i.title=n.cutTitle(r?f.Oi:f.Ai),i.textSplit="javascript: \u2026",i.t=f.Vi)}I.tf(_,1)}},j={_n(e,t){if(!w.length&&1024&c||!(2&R))return I.tf([],2);let r=w.length>0;if(l.ue.We){if(r)return void I.tf(j.ef(),2);(l.ue.$e>10||l.ue.el>0)&&o.hi.$i()}else{let t=r?()=>{e.o||I.tf(j.ef(),2)}:null;if(r&&(_||o.hi.Fi))o.hi.Fi>0&&clearTimeout(o.hi.Fi),o.hi.Fi=0,o.hi.Ji(t);else if(o.hi.Fi||(o.hi.Fi=setTimeout(()=>{o.hi.Fi=0,o.hi.Ji(t)},r?200:150)),r){let e=I.uf,t=e.length,l=t>0;I.nf(l&&"search"===e[0].t?[e[0]]:[],a&&l,0,0,t,g,$)}if(r)return}0===t?n.of(k,c,j.sf,e):o.pi(p+m,T,j.af.bind(null,e))},ef(){var e;let t=1===w.length?w[0]:"",r=t&&("."===t[0]?/^\.[\da-zA-Z]+$/.test(t):(i.yt(t,null,-2),i.kt<=2)),f=r?"."===t[0]||i.kt>0?n.cf._f[0]:(n.cf.mf||n.cf.hf(),n.cf.mf[0]):null,u=n.ji.rf?[]:null,s=[-1.1,-1.1],a=[],_=n.ff,c=r&&t.includes("%")&&!/[^\x21-\x7e]|%[^A-F\da-f]/.test(t),h=m+p,b=-1.1,g=0,v=0,S=0;for(x&&h++,v=h;--v;)s.push(-1.1,-1.1);h=2*h-2;let $=(null===(e=n.ji.lf)||void 0===e?void 0:e.We)||l.ue.We;for(let e=$.length;g<e;g++){let e=$[g];if((r?f.test(c?e.u:e.t):_(e.t,e.Ai))&&(T||e.Bi)){null!==u&&u.push(e),S++;let t=r?n.ComputeRecency(e.Qi)||1e-16*Math.max(0,e.Qi):n.ComputeRelevancy(e.t,e.Ai,e.Qi);if(t>b){for(v=h-2;0<=v&&s[v]<t;v-=2)s[v+2]=s[v],s[v+3]=s[v+1];s[v+2]=t,s[v+3]=g,b=s[h]}}}for(u&&(n.ji.rf.We=u),d+=S,S||(R^=2),5&R?g=0:(g=2*p,p=0);g<=h;g+=2){let e=s[g];if(e<=0)break;let t=$[s[g+1]];if(t.u!==x){let l=new z("history",t.u,c?t.u:t.t,t.Ai,n.get2ndArg,e);l.visit=t.Qi,a.push(l)}}return o._i.zi(),a},sf(e,t){if(n.ji.co(t),e.o)return;let l=new Set,f=0;for(let e of t){if(e.incognito&&n.tabsInNormal)continue;let t=r.getTabUrl(e);l.has(t)||(l.add(t),f++)}return j.df([],e,l,p,f)},af(e,t){if(e.o)return;let l=[],r=new Set,f=-p;return t.some(e=>{let t,i=e.u;return t=i+"\n"+e.Ai,!r.has(t)&&(r.add(t),r.add(i),++f>0&&l.push(e),l.length>=m)})?j.pf(l):j.df(l,e,r,-f,0)},df(e,t,l,f,i){r.Al.history.search({text:"",maxResults:p+m*(T?1:2)+i},r=>{if(t.o)return;r=r.filter(e=>{let t=e.url;return t.length>2e3&&(e.url=t=o.hi.Ni(t,e)),!l.has(t)&&(T||0!==o.ci(e.url,e.title||""))}),f<0?r.length=Math.min(r.length,m-e.length):f>0&&(r=r.slice(f,f+m));let i=r.map(e=>({u:e.url,Ai:e.title||"",uo:e.lastVisitTime,fo:null}));f<0&&(i=e.concat(i)),j.pf(i)})},pf(e){e.forEach(j.wf),p=0,o._i.zi(),I.tf(e,2)},wf(e,t,l){let r=e.u,f=new z("history",r,o._i.Hi(r,r),e.Ai||"",n.get2ndArg,(99-t)/100),i=e.fo;f.visit=e.uo,i&&(f.s=i,f.label='<span class="undo">&#8630;</span>'),l[t]=f}},A={_n(e,t){if(1!==w.length||!(16&R)||w[0].lastIndexOf("/",w[0].length-2)>=0)return I.tf([],16);if(l.ue.Xe);else{if(!l.ue.We)return t>0?I.tf([],16):o.hi.Ji(()=>{e.o||A._n(e,0)});o.hi.Xi&&o.hi.Xi(l.ue.We)}return A.ef()},ef(){let e,t=l.ue.Xe,r=n.bf,i=16===R&&a?[]:null,u=w[0].replace("/","").toLowerCase(),o=u===w[0],s=[],_="",c=-1.1;n.gf(3);for(let l of t.keys())if(l.includes(u)&&(e=t.get(l),T||e.lo>0)){let t=n.ComputeRelevancy(l,"",e.Qi);i?i.push({r:t,d:l,m:e}):t>c&&(c=t,_=l)}let h=_.length===u.length;if(_&&!h){if(!_.startsWith("www.")&&!_.startsWith(u)){let l=_.slice(_.indexOf(".")+1);if(l.includes(u)){let r;l="www."+l,(r=t.get(l))?(T||r.lo>0)&&(_=l,e=r):(r=t.get(l="m."+l))&&(T||r.lo>0)&&(T||r.lo>0)&&(_=l,e=r)}}let l=_.startsWith(u)?0:_.startsWith("www."+u)?4:-1;if(l>=0){let[e,t]=f.nt(_),r=e.length-1;t>1&&(l=_.length-l-u.length-e[r].length-1,(!l||3===t&&l===e[r-1].length+1)&&(h=true))}}if(_)d++,a=!p&&h||a,s=A.vf(_,e,0,o);else if(i){i.sort(A.Sf),d=i.length,d>p+m&&(i.length=p+m);for(let e of i)s.push(A.vf(e.d,e.m,e.r,o)[0])}n.gf(r),I.tf(s,16)},vf(e,t,r,i){let u=t.Mt>0,s="";if(2===l.ce.Ke){let t=new RegExp(`^https?://${f.o(e)}/?$`),r=l.ce.Fe.filter(e=>t.test(e.u)&&(T||e.Bi));if(r.length>0){let e=r.filter(e=>"s"===e.u[4]);u=e.length>0,r=u?e:r;let t=r[0].u;M=t.endsWith("/")?t.slice(0,-1):t,s=r[0].Ai}}let a=(u?"https://":"http://")+e+"/";if(!r&&(x=a,p>0))return p--,[];let _=new z("domain",a,i?e:e+"/","",n.get2ndArg,r||2),c=o.hi.qi?o.hi.Ci(a):-1,h=c>0?l.ue.We[c]:null;return n.$f(_),h&&(T||h.Bi)&&(_.visit=h.Qi,s=s||h.Ai),_.title=n.cutTitle(s,[]),--m,[_]},Sf(e,t){return t.r-e.r}},B={_n(e,t){!(4&R)||t&&(!w.length||256&c)?I.tf([],4):n.of(k,c,B.ef,e)},ef(e,t){if(n.ji.co(t),e.o)return;let i=l.Ce,u=w.length<=0,s=3&R,a=!!(8&c)&&k&&u&&!_,b=[];if(a&&!(128&c)&&t.length>p&&t.length>h){let e=new Map;for(let l of t)e.set(l.id,l);{let l=e.get(i),r=l?l.openerTabId:0,f=r?e.get(r):null,u=f?f.index:l?l.index-1:0,n=f?0:h/2|0;for(;1<--n&&u>0&&t[u-1].openerTabId===r;u--);t=u>0?t.slice(u).concat(t.slice(0,u)):t}}let g=[],v=[],S=!u&&/^:[a-z]+/gm.test(w.join("\n"));for(let e of t){if(!k&&n.tabsInNormal&&e.incognito)continue;let t=r.getTabUrl(e),l=e.text||(e.text=o._i.Hi(t,e.incognito?"":t)),f=e.title;if(S&&(1===w.length&&(l=f=""),e.audible&&(f+=" :audible :audio",f+=r.isTabMuted(e)?" :muted":" :unmuted"),e.discarded&&(f+=" :discarded"),e.incognito&&(f+=" :incognito"),e.pinned&&(f+=" :pinned")),u||n.ff(l,f)){let t=e.windowId;!k&&v.lastIndexOf(t)<0&&v.push(t),g.push(e)}}s&&1===g.length&&g[0].id===i&&(g.length=0);let $=g.length;if(d+=$,$||(R^=4),p>=$&&!s)return p=0,I.tf(b,4);v.sort(B.yf);let y=u?a?B.kf:B.xf:n.ComputeWordRelevancy,x=a?f.ct():null,M=v.length>1?l.Se:0;if(a)for(let e of g){let t=e.openerTabId,l=t&&x[t];x[e.id]=l?l<5?l+1:5:1}let T=32&c?1===l.Ye.o?0:performance.timeOrigin:0;for(let e=0;e<g.length;){let t=g[e++],f=t.id,o=a?x[f]:1,s=r.getTabUrl(t),_=l.Ee.get(f),c=new z("tab",s,t.text,t.title,y,a?e:f),m=M&&t.windowId!==M?`${v.indexOf(t.windowId)+1}:`:"",h="";m+=e,i===f?(a||(c.r=u?1<<31:0),m=`(${m})`):_||(m=`**${m}**`),!n.tabsInNormal&&t.incognito&&(h+="*"),!!t.discarded&&(h+="~"),t.audible&&(h+=r.isTabMuted(t)?"\u266a":"\u266c"),c.visit=_?_.t+T:0,c.s=f,c.label=`#${m}${h&&" "+h}`,o>1&&(c.level=" level-"+o),b.push(c)}b.sort(I.Mf);let F=b.length,j=p+m-F;if(s||j<0||!u){p>0&&!s?(b=b.slice(p,p+m),F=m,p=0):F>p+m&&(b.length=F=p+m);for(let e=s?0:F;e<F;e++)b[e].r*=8/(e/4+1)}else if(p>0){let e=b.slice(0,j);for(let t of e)t.label+="[r]";b=b.slice(p).concat(e),F=b.length;for(let e=0;e<F;e++)b[e].r=F-e;p=0}o._i.zi(),I.tf(b,4)},yf:(e,t)=>e-t,xf(e,t){let r=l.Ee.get(t);return r?r.i:4&c?2047+t:-t},kf:(e,t)=>1/t},E={Rf:0,_n:l.A,Tf(e,t){if(!(8&R))return I.tf([],8);let r,f,u,o,a,_=w,c=_.length>0?_[0]:"";if(0===_.length);else{if(true!==t&&"\\"===c[0]&&"\\"!==c[1])return c.length>1?_[0]=c.slice(1):_.shift(),c=v.slice(1).trimLeft(),T=true,p?(p--,I.tf([],8)):(r=E.zf(c),I.tf([r],8));f=l.Te.searchEngineMap.get(c)}if(true===t){if(!f)return true}else{if(!f&&!c.startsWith("vimium://"))return 0===s&&_.length<=1&&(s=_.length?n.jf.Ff()?-2:0:-1),I.tf([],8);f&&S&&(_.push(S),p=0,v+=" "+S,S="",$&=-5),_.length>1||(s=-1)}if(_.length>1&&f?(_.shift(),v.length>200&&(_=v.split(" "),_.shift())):f&&(_=[]),T=true,f){let e=i._t(_,f.Ot,f.A,[]);a=u=e.Ot,o=e.Ut}else a=u=_.join(" "),o=[];if("~"===c);else if(u.startsWith("vimium://")){let t=l.P(u.slice(9),1,true),r=E.Af.bind(E,_,u,a,f,o);if(t instanceof Promise)return t.then(E.Bf.bind(E,e,r));if(t instanceof Array)return E.Bf(e,r,t);t&&(u=a=t,o=[])}else u=i.yt(u,null,-2);return r=E.Af(_,u,a,f,o),I.tf([r],8)},Bf(e,t,l){let r;if(!e.o){switch(l[1]){case 5:case 6:let i=l[0];if(s=6===l[1]&&w.length>1?s:-1,!i)break;return v="\\ "+i,S="",w=(v.length<201?v:f.ut(v,0,200).trim()).split(" "),w.length>1&&(w[1]=u.Tl(w[1],w.length>2)),E.Tf(e);case 2:let n=l[0];w=n.length>1||1===n.length&&n[0]?n:w;let o=E.Rf++;if(o>12)break;let a=E.Tf(e,true);if(o<=0&&(E.Rf=0),true!==a)return a;break;case 0:l[0]&&(r=E.Ef(t(),l))}I.tf(r||[t()],8)}},Af(e,t,l,r,i){let u=new z("search",t,l,(r?r.Nl+": ":"")+e.join(" "),n.get2ndArg,9);return e.length>0&&r?(u.t=E.If(l,i),u.title=n.cutTitle(u.title,[r.Nl.length+2,u.title.length]),u.textSplit=n.highlight(u.t,i)):(u.t=f.tt(n.shortenUrl(l)),u.title=n.cutTitle(u.title,[]),u.textSplit=f.it(u.t)),u.v=_?"":r&&r.A||n.Df(t),u.p=_&&r?r.Nl:"",u},Ef(e,t){let l=t[0],r=new z("math","vimium://copy "+l,l,l,n.get2ndArg,9);return--r.r,r.title=`<match style="text-decoration: none;">${n.cutTitle(r.title,[])}<match>`,r.textSplit=f.it(t[2]),[e,r]},If(e,t){let l,r,i,u=t.length;if(r=f.tt(t.length>0?e.slice(0,t[0]):e),(l=f.d(r))&&(r=r.slice(l),l=0),t.length<=0)return r;for(i=t[0];t[l]=r.length,u>++l;)r+=f.tt(e.slice(i,t[l])),i=t[l];return i<e.length&&(r+=f.tt(e.slice(i))),r},zf(e){let t=i.yt(e,null,-2),l=4===i.kt,r=new z("search",t,f.tt(n.shortenUrl(t)),"",n.get2ndArg,9);return r.title=l?"~: "+n.cutTitle(e,[0,e.length]):n.cutTitle(e,[]),r.textSplit=f.it(r.t),r.v=_?"":n.Df(t),r.p=_&&l?"~":"",r.n=1,r}},I={Of:0,Qf:0,uf:null,Uf:null,nf:null,_n(e){I.Uf&&(I.Uf.o=true);let t=I.Uf={o:false};I.Qf=0,R&=e[0];let l=1,r=-9&R?e.length:2;if(I.uf=[],I.Of=r-1,s=p&&-1,e[1]===E){let f=E.Tf(t);if(r<3)return;if(f)return void f.then(I.qf.bind(null,e,t,l));l=2}I.qf(e,t,l)},qf(e,t,l){for(n.Cf(Date.now()-18144e5),n.gf(3*w.length||.01),w.indexOf("__proto__")>=0&&(w=w.join(" ").replace(/(^| )__proto__(?=$| )/g," __proto_").trimLeft().split(" ")),n.ji.Vr(T),w.sort(I.Gf),n.cf.Hf();l<e.length;l++)e[l]._n(t,l-1)},Gf:(e,t)=>t.length-e.length||(e<t?-1:e===t?0:1),tf(e,t){let l=I.uf,r=e.length;if(r>0&&(I.Qf|=t,I.uf=0===l.length?e:l.concat(e),8===t&&(a=!0,m-=r,d+=r)),0==--I.Of)return l=null,I.Nf()},Nf(){let e=I.uf;if(I.uf=null,e.sort(I.Mf),p>0?(e=e.slice(p,p+h),p=0):e.length>h&&(e.length=h),n.cf.Pf=n.cf.mf=null,w.length>0){let e=w[0],t=n.shortenUrl(e),l=e.length!==t.length;(l||e.endsWith("/")&&e.length>1&&!e.endsWith("//"))&&(w[0]=l?t:e.slice(0,-1),n.cf.Wf(w[0]))}e.forEach(n.$f);let t=e.length>0,l=a&&t,r=d,f=":"===b,i=s<0?-2!==s||t||f?0:3:T?w.length<=0||y?0:t?2:f?0:1:0,u=g,o=$,_=2!==i||f?0:I.Qf,c=I.nf;return I.Zf(),c(e,l,i,_,r,u,o)},Zf(){I.Uf=I.nf=null,n.set_tabsInNormal(null),n.setupQueryTerms(w=[],_=false,0),b=g=v=S=x=M="",n.cf._f=null,n.gf(3),n.Cf(0),s=I.Qf=c=m=h=d=0,R=0,$=0,a=false,y=k=false,T=true},Jf(){let e,t,l=v;if(p=0,S="",!(0===l.length||(e=(l=l.slice(-5)).lastIndexOf("+"))<0||0!==e&&32!==l.charCodeAt(e-1))){if(l=l.slice(e),e=v.length-l.length,(t=parseInt(l,10))>=0&&"+"+t===l&&t<=(e>0?100:200))p=t;else if("+"!==l)return;v=v.slice(0,e&&e-1),S=l,$|=4}},Mf:(e,t)=>t.r-e.r},D={__proto__:null,bookm:[1,F],domain:[16,A],history:[2,j],omni:[63,E,A,j,F,B],search:[8,E],tab:[4,B]};l.N._n=(e,t,r)=>{(e=e.trim())&&2===l.Ye.o&&(/^[a-z]:\\|^\\\\[\w$.-]+(\\|$)|^\\\\$/i.test(e)?e=(":"===e[1]?"":"//")+e.slice(":"===e[1]?0:2).replace(/\\+/g,"/").toLowerCase():"file:"===e.slice(0,5).toLowerCase()&&(e=e.toLowerCase())),b=v=e&&e.replace(f.ft," "),g="",$=0,I.Jf(),w=(e=v)?(e=e.length<201?e:f.ut(e,0,200).trimRight()).split(" "):[];let i=0|t.c||128;i&&(i-=e.replace(/[\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u9fbf\uf900-\ufaff\ufe30-\ufe4f\uff00-\uffef]/g,"aa").length-e.length),i=Math.max(50,Math.min(i,320)),c=t.f,_=!!(1&c),h=m=Math.min(Math.max(3,0|t.r||10),25),d=0,I.nf=r;let o="bomni"===t.o?(c|=64,D.omni):D[t.o],s=w.length>=1?w[0]:"",p=t.t||63,S=t.e||63;if(o===D.tab&&(k=!!(2&c)),2===s.length&&":"===s[0]){s=s[1];let e="b"===s?D.bookm:"h"===s?D.history:"t"===s||"w"===s||"W"===s?(k="t"!==s,c|=0,D.tab):"B"===s?(c|=64,D.omni):"H"===s?(c|=256,D.omni):"d"===s?D.domain:"s"===s?D.search:"o"===s?D.omni:null;e&&(o=e,g=w.shift(),$|=1,v=v.slice(3),S=o[0])}if(w.length>0&&((s=w[0]).includes("\u3002")||s.includes("\uff1a"))){y=w.length<2;let e=u.Tl(s,y);e!==s?(w[0]=e,v=e+v.slice(s.length),y=y&&!/^[.\u3002]\w+([.\u3002]\w*)?$/.test(s)):y=y&&s.includes("\uff1a")&&!/\uff1a([^\/\d]|\d[^\0-\xff])/.test(s)}T=true,R=p&S,a=2===o.length,v&&($|=2),n.setupQueryTerms(w,_,i),I._n(o)}});