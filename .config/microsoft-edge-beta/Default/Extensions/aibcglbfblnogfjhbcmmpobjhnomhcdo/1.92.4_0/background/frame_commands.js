"use strict";__filename="background/frame_commands.js",define(["require","exports","./store","./utils","./browser","./normalize_urls","./settings","./ports","./i18n","./key_mappings","./run_commands","./open_urls","./tools"],(e,l,t,n,r,o,i,u,a,s,f,m,d)=>{let p;Object.defineProperty(l,"__esModule",{value:true}),l.focusFrame=l.framesGoNext=l.toggleZoom=l.mainFrame=l.framesGoBack=l.openImgReq=l.captureTab=l.enterVisualMode=l.showVomnibar=l.initHelp=l.performFind=l.parentFrame=l.nextFrame=void 0,n=__importStar(n),i=__importStar(i),l.nextFrame=()=>{let e=t.cPort,n=-1,r=t.Pe.get(e.s.Xl),o=r&&r.Qt;if(o&&o.length>1){n=o.indexOf(e);for(let e=Math.abs(t.cRepeat);e>0;e--)n+=t.cRepeat>0?1:-1,n===o.length?n=0:n<0&&(n=o.length-1);e=o[n]}l.focusFrame(e,0===e.s.Yl,e!==t.cPort&&r&&e!==r.er?3:2,t.get_cOptions())},l.parentFrame=()=>{let e=t.cPort.s,n=e.Xl>=0&&t.Pe.get(e.Xl)?null:"Vimium C can not access frames in current tab";n&&u.showHUD(n),u.getParentFrame(e.Xl,e.Yl,t.cRepeat).then(e=>{e?l.focusFrame(e,true,4,t.get_cOptions()):l.mainFrame()})},l.performFind=()=>{let e=t.cPort.s,l=t.cRepeat<0?-t.cRepeat:t.cRepeat,n=t.get_cOptions().index,r=n?"other"===n?l+1:"count"===n?l:n>=0?-1-(0|n):0:0,o=!!r||!t.get_cOptions().active,i=null;32&e.Zt||(e.Zt|=32,i=t.Ae),f.sendFgCmd(1,true,f.wrapFallbackOptions({c:r>0?t.cRepeat/l:t.cRepeat,l:o,f:i,m:!!t.get_cOptions().highlight,n:!!t.get_cOptions().normalize,r:true===t.get_cOptions().returnToViewport,s:!r&&l<2&&!!t.get_cOptions().selected,p:!!t.get_cOptions().postOnEsc,e:!!t.get_cOptions().restart,q:t.get_cOptions().query?t.get_cOptions().query+"":o||t.get_cOptions().last?d.fr.Jr(e.tr,"",r<0?-r:r):""}))},l.initHelp=(l,r)=>{let o=t.Ie||[];Promise.all([new Promise((l,n)=>{e([t.e.HelpDialogJS],l,n)}).then(__importStar),null!=o[0]?null:n.a(t.e.helpDialog),null!=o[1]?null:a.getI18nJson("help_dialog"),null!=o[2]?null:a.getI18nJson("params.json")]).then(([e,n,o,u])=>{var a;let m=l.w&&(null===(a=t.Pe.get(r.s.Xl))||void 0===a?void 0:a.lr)||r,d=m.s.Ot.startsWith(t.e.ul),p=l.a||{};m.s.Zt|=64,t.set_cPort(m);let c=t.Ie||t.X([null,null,null]);n&&(c[0]=n),o&&(c[1]=o),u&&(c[2]=u),f.sendFgCmd(17,true,{h:e.mn(d),o:t.e.ul,e:!!p.exitOnClick,c:i.Nt("showAdvancedCommands",true)||d&&!!s.sa})},null)},l.showVomnibar=e=>{var l;let r=t.cPort,o=t.get_cOptions().url;if(null!=o&&true!==o&&"string"!=typeof o&&(o=null,delete t.get_cOptions().url),!r){if(r=(null===(l=t.Pe.get(t.Ce))||void 0===l?void 0:l.lr)||null,!r)return;t.set_cPort(r)}"bookmark"===t.get_cOptions().mode&&f.overrideOption("mode","bookm");let i=t.Te.vomnibarPage_f,{Ot:u}=r.s,a=!i.startsWith(t.e.ll),s=u.startsWith(t.e.ll),m=e||!i.startsWith(location.origin)?t.e.Cl:i,d=(e=e||(a?s||i.startsWith("file:")&&!u.startsWith("file:///")||i.startsWith("http:")&&!/^http:/.test(u)&&!/^http:\/\/localhost[:/]/i.test(i):r.s.tr||s&&!i.startsWith(u.slice(0,u.indexOf("/",u.indexOf("://")+3)+1))))||i===m||r.s.Xl<0,p=t.get_cOptions().trailingSlash,c=t.get_cOptions().trailing_slash,g=f.copyCmdOptions(n.st({v:d?m:i,i:d?null:m,t:d?0:a?2:1,s:null!=p?!!p:null!=c?!!c:null,j:d?"":t.e.fl,e:!!t.get_cOptions().exitOnClick,k:n.t(true)}),t.get_cOptions());f.portSendFgCmd(r,6,true,g,t.cRepeat),g.k="omni",t.set_cOptions(g)},l.enterVisualMode=()=>{let e=t.get_cOptions().mode,l="string"==typeof e?e.toLowerCase():"",n=t.cPort.s,r=null,o=null,i=null;16&~n.Zt&&(32&n.Zt||(n.Zt|=32,r=t.Ae),o=s.ea,i=s.ta,n.Zt|=16),f.sendFgCmd(5,true,f.wrapFallbackOptions({m:"caret"===l?3:"line"===l?2:1,f:r,g:i,k:o,t:!!t.get_cOptions().richText,s:!!t.get_cOptions().start,w:""}))},l.captureTab=(e,l)=>{let n=t.get_cOptions().show,o=t.get_cOptions().png?0:Math.min(Math.max(0|t.get_cOptions().jpeg,0),100),i=e&&e[0],u=i?i.id:t.Ce,a=i?i.windowId:t.Se,s=i?i.title:"";s="title"===t.get_cOptions().name||!s||u<0?s||""+u:u+"-"+s,s+=o>0?".jpg":".png",r.$l.captureVisibleTab(a,o>0?{format:"jpeg",quality:o}:{format:"png"},e=>{if(!e)return l(0),r.Fl();let o=e=>{var o;let a="string"!=typeof e?URL.createObjectURL(e):e;if(a.startsWith("blob:")&&(p&&(clearTimeout(p[0]),URL.revokeObjectURL(p[1])),p=[setTimeout(()=>{p&&URL.revokeObjectURL(p[1]),p=null},n?5e3:3e4),a]),n)return i(a),void l(1);let f=t.cPort&&(null===(o=t.Pe.get(t.cPort.s.Xl))||void 0===o?void 0:o.lr)||t.cPort;r.downloadFile(a,s,f?f.s.Ot:null,e=>{e||u(a),l(e)})},i=e=>{t.ie[23]({o:"pixel=1&",u:e,f:s,a:false,r:-1,q:{r:t.get_cOptions().reuse,m:t.get_cOptions().replace,p:t.get_cOptions().position,w:t.get_cOptions().window}},t.cPort)},u=e=>{let l=document.createElement("a");l.href=e,l.download=s,l.target="_blank",l.click()};e.startsWith("data:")?fetch(e).then(e=>e.blob()).then(o):o(e)})},l.openImgReq=(e,l)=>{let r=e.u;if(/^<svg[\s>]/i.test(r)){let n=(new DOMParser).parseFromString(r,"image/svg+xml").firstElementChild;if(n)for(let e of[].slice.call(n.querySelectorAll("script,use")))e.remove();if(!n||!n.lastElementChild)return t.set_cPort(l),void u.showHUD(a.or("invalidImg"));n.setAttribute("xmlns","http://www.w3.org/2000/svg"),r="data:image/svg+xml,"+encodeURIComponent(n.outerHTML),e.f=e.f||"SVG Image"}if(!n.ot(r))return t.set_cPort(l),void u.showHUD(a.or("invalidImg"));let i=t.e.Sl+"#!image ";e.f&&(i+="download="+n.g(e.f)+"&"),false!==e.a&&(i+="auto=once&"),e.o&&(i+=e.o);let s=e.q||n.ct(),d=s.k;r=s.s?t.j(r,32768,s.s):r,f.replaceCmdOptions({opener:true,reuse:null!=s.r?s.r:e.r,replace:s.m,position:s.p,window:s.w}),t.set_cRepeat(1),m.openUrlWithActions("string"==typeof d||r.startsWith(location.protocol)&&!r.startsWith(location.origin)?d?o.yt(r,d,2):r:i+r,9)},l.framesGoBack=(e,t,n)=>{let o=f.hasFallbackOptions(e.o)?(f.replaceCmdOptions(e.o),f.getRunNextCmdBy(0)):r.Fl,i=n?n.id:t.s.Xl,u=e.s,a=m.parseReuse(e.o.reuse||0);if(a){let t=e.o.position;r.$l.duplicate(i,n=>{if(!n)return o();-2===a&&r.selectTab(i);{let t=f.parseFallbackOptions(e.o)||{};t.reuse=0,l.framesGoBack({s:u,o:t},null,n)}let s=n.index--,d="end"===t?3e4:m.newTabIndex(n,t,false,true);null!=d&&d!==s&&r.$l.move(n.id,{index:d},r.Fl)})}else{let e=u>0?r.$l.goForward:r.$l.goBack;for(let l=0,t=u>0?u:-u;l<t;l++)e(i,l?r.Fl:o)}},l.mainFrame=()=>{let e=t.Pe.get(t.cPort?t.cPort.s.Xl:t.Ce),n=e&&e.lr;n&&n===e.er&&t.get_cOptions().$else&&"string"==typeof t.get_cOptions().$else?f.runNextCmd(0):n&&l.focusFrame(n,true,n===e.er?2:4,t.get_cOptions())},l.toggleZoom=e=>{r.kl(r.$l.getZoom).then(l=>{if(!l)return void e(0);let n=t.cRepeat<-4?-t.cRepeat:t.cRepeat;(t.get_cOptions().in||t.get_cOptions().out)&&(n=0,t.set_cRepeat(t.get_cOptions().in?t.cRepeat:-t.cRepeat));let o,i=t.get_cOptions().level,u=Math;if(t.get_cOptions().reset)o=1;else if(null!=i&&!isNaN(+i)||n>4){let e=u.max(.1,u.min(0|t.get_cOptions().min||.25,.9)),l=u.max(1.1,u.min(0|t.get_cOptions().min||5,100));o=null==i||isNaN(+i)?n>1e3?1:n/(n>49?100:10):1+i*t.cRepeat,o=u.max(e,u.min(o,l))}else{let e=0,n=9,r=[.25,1/3,.5,2/3,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3,4,5];for(let t=0,o=0;t<r.length&&(o=Math.abs(r[t]-l))<n;t++)e=t,n=o;o=r[e+t.cRepeat<0?0:u.min(e+t.cRepeat,r.length-1)]}Math.abs(o-l)>.005?r.$l.setZoom(o,r.yl(e)):e(0)})},l.framesGoNext=(e,l)=>{let n=t.get_cOptions().patterns,r=false;if(n&&n instanceof Array||(n=n&&"string"==typeof n?n:(r=true,e?t.Te.nextPatterns:t.Te.previousPatterns),n=n.split(",")),r||!t.get_cOptions().$fmt){let e=[];for(let l of n)if(l=l&&(l+"").trim(),l&&e.push(".#[".includes(l[0])?l:l.toLowerCase()),200===e.length)break;n=e,r||(f.overrideOption("patterns",n),f.overrideOption("$fmt",1))}let o=n.map(e=>Math.max(e.length+12,4*e.length)),i=Math.max.apply(Math,o);f.sendFgCmd(10,true,f.wrapFallbackOptions({r:t.get_cOptions().noRel?"":l,n:e,exclude:t.get_cOptions().exclude,match:t.get_cOptions().match,evenIf:t.get_cOptions().evenIf,p:n,l:o,m:i>0&&i<99?i:32}))},l.focusFrame=(e,l,n,r)=>{e.postMessage({N:7,H:l?u.ensureInnerCSS(e.s):null,m:n,k:t.cKey,c:0,f:r&&f.parseFallbackOptions(r)||{}})}});